"use strict";(this.webpackChunkGrafanaToWebComponent=this.webpackChunkGrafanaToWebComponent||[]).push([[3168],{82367:(Ue,Z,u)=>{u.r(Z),u.d(Z,{plugin:()=>Ae});var q=u(54721),t=u(39953),oe=u(32688),le=u(3782),ie=u(3587),E=u(56921);const{Select:_,Input:ce}=ie.LegacyForms,G=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],J=[{label:"second",value:1},{label:"millisecond",value:2}],me=s=>{const{onChange:e,value:a}=s,r=(0,t.useId)();return t.createElement(t.Fragment,null,t.createElement("h5",null,"OpenTSDB settings"),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:7,htmlFor:`select-version-${r}`},"Version"),t.createElement(_,{inputId:`select-version-${r}`,options:G,value:G.find(o=>o.value===a.jsonData.tsdbVersion)??G[0],onChange:ee("tsdbVersion",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:7,htmlFor:`select-resolution-${r}`},"Resolution"),t.createElement(_,{inputId:`select-resolution-${r}`,options:J,value:J.find(o=>o.value===a.jsonData.tsdbResolution)??J[0],onChange:ee("tsdbResolution",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:7,htmlFor:`lookup-input-${r}`},"Lookup limit"),t.createElement(ce,{id:`lookup-input-${r}`,type:"number",value:a.jsonData.lookupLimit??1e3,onChange:ge("lookupLimit",a,e)})))},ee=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.value}})},ge=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.currentTarget.value}})},ue=s=>{const{options:e,onOptionsChange:a}=s;return t.createElement(t.Fragment,null,t.createElement(le.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:a,secureSocksDSProxyEnabled:oe.config.secureSocksDSProxyEnabled}),t.createElement(me,{value:e,onChange:a}))};var B=u(41407),de=u(28425),W=u(82803),b=u(99456),L=u(38637),F=u(9558),U=u(99491),M=u(26286);const fe=(0,B.css)({paddingRight:"4px"});function pe({query:s,onChange:e,onRunQuery:a,aggregators:r,fillPolicies:o,tsdbVersion:c}){const i=r.map(l=>(0,b.E)(l)),n=o.map(l=>(0,b.E)(l));return t.createElement("div",{className:"gf-form-inline","data-testid":te.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Leave interval blank for auto or for example use ",t.createElement("code",null,"1m"))},"Down sample"),t.createElement(L.I,{width:25,className:fe,"data-testid":te.interval,placeholder:"interval",value:s.downsampleInterval??"",onChange:l=>{const m=l.currentTarget.value;e({...s,downsampleInterval:m})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{className:"gf-form-input",value:s.downsampleAggregator?(0,b.E)(s.downsampleAggregator):void 0,options:i,onChange:({value:l})=>{l&&(e({...s,downsampleAggregator:l}),a())}})),c>=2&&t.createElement("div",{className:"gf-form"},t.createElement(U.W,{className:"width-6 query-keyword"},"Fill"),t.createElement(F.Ph,{inputId:"opentsdb-fillpolicy-select",value:s.downsampleFillPolicy?(0,b.E)(s.downsampleFillPolicy):void 0,options:n,onChange:({value:l})=>{l&&(e({...s,downsampleFillPolicy:l}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword"},"Disable downsampling"),t.createElement(M.x,{value:s.disableDownsampling??!1,onChange:()=>{const l=s.disableDownsampling??!1;e({...s,disableDownsampling:!l}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const te={section:"opentsdb-downsample",interval:"downsample-interval"};var he=u(97368),$=u.n(he),g=u(86832),ae=u(4919),x=u(39285);function ve({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,filterTypes:o,suggestTagValues:c}){const i=(0,W.wW)(ae.gN),[n,l]=(0,t.useState)(),[m,h]=(0,t.useState)(),[p,w]=(0,t.useState)(!1),[T,N]=(0,t.useState)("iliteral_or"),[C,V]=(0,t.useState)(""),[v,k]=(0,t.useState)(""),[P,K]=(0,t.useState)(!1),[R,H]=(0,t.useState)(""),X=o.map(d=>(0,b.E)(d));function f(){w(!p)}function O(){if(s.tags&&(0,g.size)(s.tags)>0){H("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!p){w(!0);return}const d={type:T,tagk:C,filter:v,groupBy:P};s.filters=s.filters?s.filters.concat([d]):[d],N("literal_or"),V(""),k(""),K(!1),e(s),a(),f()}function A(d){s.filters?.splice(d,1),e(s),a()}function Me(d,S){A(S),V(d.tagk),k(d.filter),N(d.type),K(d.groupBy),O()}const De=" ",Ke=(0,t.useCallback)((d,S)=>{const Y=d.value??"";return S.split(De).reduce((Re,Be)=>Re&&Y.toLowerCase().includes(Be.toLowerCase()),!0)},[]),Le=$()(d=>c(d),350);return t.createElement("div",{className:"gf-form-inline","data-testid":Q.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Filters does not work with tags, either of the two will work but not both.")},"Filters"),s.filters&&s.filters.map((d,S)=>t.createElement(E.c,{key:S,width:"auto","data-testid":Q.list+S},d.tagk," = ",d.type,"(",d.filter,"), groupBy = ",""+d.groupBy,t.createElement("button",{type:"button",className:i,onClick:()=>Me(d,S)},t.createElement(x.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>A(S),"data-testid":Q.remove},t.createElement(x.J,{name:"times"})))),!p&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:f,"aria-label":"Add filter"},t.createElement(x.J,{name:"plus"}))),p&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:C?(0,b.E)(C):void 0,placeholder:"key",allowCustomValue:!0,filterOption:Ke,onOpenMenu:async()=>{h(!0);const S=(await r(s)).map(Y=>(0,b.E)(Y));l(S),h(!1)},isLoading:m,options:n,onChange:({value:d})=>{d&&V(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(U.W,{className:"width-4 query-keyword"},"Type"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",value:T?(0,b.E)(T):void 0,options:X,onChange:({value:d})=>{d&&N(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.qb,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:v?(0,b.E)(v):void 0,placeholder:"filter",allowCustomValue:!0,loadOptions:Le,defaultOptions:[],onChange:({value:d})=>{d&&k(d)}})),t.createElement(E.c,{width:5,className:"query-keyword"},"Group by"),t.createElement(M.x,{value:P,onChange:()=>{K(!P)}}),t.createElement("div",{className:"gf-form"},R&&t.createElement("div",{className:"gf-form-label",title:R,"data-testid":Q.error},t.createElement(x.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:i,onClick:O},"add filter"),t.createElement("button",{type:"button",className:i,onClick:f},t.createElement(x.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const Q={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};function Ee({query:s,onChange:e,onRunQuery:a,suggestMetrics:r,aggregators:o}){const c=o.map(n=>(0,b.E)(n)),i=$()(n=>r(n),350);return t.createElement("div",{className:"gf-form-inline","data-testid":se.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:8,className:"query-keyword"},"Metric"),t.createElement(F.qb,{width:25,inputId:"opentsdb-metric-select",className:"gf-form-input",value:s.metric?(0,b.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,loadOptions:i,defaultOptions:[],onChange:({value:n})=>{n&&(e({...s,metric:n}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",className:"gf-form-input",value:s.aggregator?(0,b.E)(s.aggregator):void 0,options:c,onChange:({value:n})=>{n&&(e({...s,aggregator:n}),a())}})),t.createElement("div",{className:"gf-form max-width-20"},t.createElement(E.c,{className:"query-keyword",width:6,tooltip:t.createElement("div",null,"Use patterns like $tag_tagname to replace part of the alias for a tag value")},"Alias"),t.createElement(L.I,{"data-testid":se.alias,placeholder:"series alias",value:s.alias??"",onChange:n=>{const l=n.currentTarget.value;e({...s,alias:l})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const se={section:"opentsdb-metricsection",alias:"metric-alias"};function be({query:s,onChange:e,onRunQuery:a,tsdbVersion:r}){return t.createElement("div",{className:"gf-form-inline","data-testid":D.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8},"Rate"),t.createElement(M.x,{"data-testid":D.shouldComputeRate,value:s.shouldComputeRate??!1,onChange:()=>{const o=s.shouldComputeRate??!1;e({...s,shouldComputeRate:!o}),a()}})),s.shouldComputeRate&&t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:"auto"},"Counter"),t.createElement(M.x,{"data-testid":D.isCounter,value:s.isCounter??!1,onChange:()=>{const o=s.isCounter??!1;e({...s,isCounter:!o}),a()}})),s.shouldComputeRate&&s.isCounter&&t.createElement("div",{className:"gf-form"},t.createElement(U.W,{width:"auto",className:"query-keyword"},"Counter max"),t.createElement(L.I,{"data-testid":D.counterMax,placeholder:"max value",value:s.counterMax??"",onChange:o=>{const c=o.currentTarget.value;e({...s,counterMax:c})},onBlur:()=>a()}),t.createElement(U.W,{width:"auto",className:"query-keyword"},"Reset value"),t.createElement(L.I,{"data-testid":D.counterResetValue,placeholder:"reset value",value:s.counterResetValue??"",onChange:o=>{const c=o.currentTarget.value;e({...s,counterResetValue:c})},onBlur:()=>a()})),r>2&&t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:"auto"},"Explicit tags"),t.createElement(M.x,{"data-testid":D.explicitTags,value:s.explicitTags??!1,onChange:()=>{const o=s.explicitTags??!1;e({...s,explicitTags:!o}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const D={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function Te({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,suggestTagValues:o,tsdbVersion:c}){const i=(0,W.wW)(ae.gN),[n,l]=(0,t.useState)(),[m,h]=(0,t.useState)(),[p,w]=(0,t.useState)(!1),[T,N]=(0,t.useState)(""),[C,V]=(0,t.useState)(""),[v,k]=(0,t.useState)("");function P(){w(!p)}function K(){if(s.filters&&(0,g.size)(s.filters)>0){k("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!p){w(!0);return}if(s.tags&&(0,g.has)(s.tags,T)){const f="Duplicate tag key '"+T+"'.";k(f);return}s.tags||(s.tags={}),s.tags[T]=C,N(""),V(""),e(s),a(),P()}function R(f){delete s.tags[f],e(s),a()}function H(f,O){R(f),N(f),V(O),K()}const X=$()(f=>o(f),350);return t.createElement("div",{className:"gf-form-inline","data-testid":j.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:c>=2?t.createElement("div",null,"Please use filters, tags are deprecated in opentsdb 2.2"):void 0},"Tags"),s.tags&&Object.keys(s.tags).map((f,O)=>{const A=s.tags[f];return t.createElement(E.c,{key:O,width:"auto","data-testid":j.list+O},f,"=",A,t.createElement("button",{type:"button",className:i,onClick:()=>H(f,A)},t.createElement(x.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>R(f),"data-testid":j.remove},t.createElement(x.J,{name:"times"})))}),!p&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:P,"aria-label":"Add tag"},t.createElement(x.J,{name:"plus"}))),p&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:T?(0,b.E)(""+T):void 0,placeholder:"key",allowCustomValue:!0,onOpenMenu:async()=>{h(!0);const O=(await r(s)).map(A=>(0,b.E)(A));l(O),h(!1)},isLoading:m,options:n,onChange:({value:f})=>{f&&N(f)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.qb,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:C?(0,b.E)(C):void 0,placeholder:"value",allowCustomValue:!0,loadOptions:X,defaultOptions:[],onChange:({value:f})=>{f&&V(f)}})),t.createElement("div",{className:"gf-form"},v&&t.createElement("div",{className:"gf-form-label",title:v,"data-testid":j.error},t.createElement(x.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:i,onClick:K},"add tag"),t.createElement("button",{type:"button",className:i,onClick:P},t.createElement(x.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const j={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function Ne({datasource:s,onRunQuery:e,onChange:a,query:r,range:o,queries:c}){const i=(0,W.wW)(ye),[n,l]=(0,t.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),m=["none","nan","null","zero"],[h,p]=(0,t.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),w=s.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),(0,t.useEffect)(()=>{s.getAggregators().then(v=>{v.length!==0&&l(v)})},[s]),(0,t.useEffect)(()=>{s.getFilterTypes().then(v=>{v.length!==0&&p(v)})},[s]);async function T(v){return s.metricFindQuery(`metrics(${v})`).then(V)}async function N(v){return s.metricFindQuery(`suggest_tagv(${v})`).then(V)}async function C(v){return s.suggestTagKeys(v)}function V(v){return v.map(k=>({value:de.QX.escapeHtml(k.text),description:k.text}))}return t.createElement("div",{className:i.container,"data-testid":we.editor},t.createElement("div",{className:i.visualEditor},t.createElement(Ee,{query:r,onChange:a,onRunQuery:e,suggestMetrics:T,aggregators:n}),t.createElement(pe,{query:r,onChange:a,onRunQuery:e,aggregators:n,fillPolicies:m,tsdbVersion:w}),w>=2&&t.createElement(ve,{query:r,onChange:a,onRunQuery:e,filterTypes:h,suggestTagValues:N,suggestTagKeys:C}),t.createElement(Te,{query:r,onChange:a,onRunQuery:e,suggestTagValues:N,suggestTagKeys:C,tsdbVersion:w}),t.createElement(be,{query:r,onChange:a,onRunQuery:e,tsdbVersion:w})))}function ye(s){return{container:(0,B.css)`
      display: flex;
    `,visualEditor:(0,B.css)`
      flex-grow: 1;
    `,toggleButton:(0,B.css)`
      margin-left: ${s.spacing(.5)};
    `}}const we={editor:"opentsdb-editor"};var Ce=u(36497),Se=u(3195),z=u(63302),I=u(31312),xe=u(10752),y=u(71476),re=u(53305),Ve=u(77877),ne=u(4148),Fe=u(41182);const Ie=s=>{const{query:e,onChange:a}=s,[r,o]=(0,t.useState)(e.target??""),[c,i]=(0,t.useState)(e.isGlobal??!1),n=(m,h)=>{a({...e,[m]:h,fromAnnotations:!0})},l=m=>{m=!m,i(m),n("isGlobal",m)};return t.createElement("div",{className:"gf-form-group"},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:12},"OpenTSDB metrics query"),t.createElement(L.I,{value:r,onChange:m=>o(m.currentTarget.value??""),onBlur:()=>n("target",r),placeholder:"events.eventname"})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:12},"Show Global Annotations?"),t.createElement(M.x,{value:c,onChange:m=>l(c)})))},ke=s=>({fromAnnotations:!0,target:s.target??"",name:s.name??"",isGlobal:s.isGlobal??!1}),Oe=s=>{const e=s.target&&typeof s.target!="string"?s.target:ke(s);return s.target=e,s};class Pe extends q.MF{constructor(e,a=(0,Fe.J)()){super(e),this.templateSrv=a,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Ie,prepareAnnotation:Oe}}query(e){if(e.targets.some(n=>n.fromAnnotations)){const n=[];for(const l of e.targets)l.target&&n.push(new Ce.y(m=>{this.annotationEvent(e,l).then(h=>m.next({data:[(0,re.g0)(h)]})).catch(h=>m.next({data:[(0,re.g0)([])]})).finally(()=>m.complete())}));return(0,Se.T)(...n)}const a=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),r=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),o=[];(0,g.each)(e.targets,n=>{n.metric&&o.push(this.convertTargetToQuery(n,e,this.tsdbVersion))});const c=(0,g.compact)(o);if((0,g.isEmpty)(c))return(0,z.of)({data:[]});const i={};return(0,g.each)(c,n=>{n.filters&&n.filters.length>0?(0,g.each)(n.filters,l=>{i[l.tagk]=!0}):(0,g.each)(n.tags,(l,m)=>{i[m]=!0})}),e.targets=(0,g.filter)(e.targets,n=>n.hide!==!0),this.performTimeSeriesQuery(c,a,r).pipe((0,xe.K)(n=>{throw n?.data?.error?.message||"Error performing time series query."}),(0,y.U)(n=>{const l=this.mapMetricsToTargets(n.data,e,this.tsdbVersion);return{data:(0,g.map)(n.data,(h,p)=>(p=l[p],p===-1&&(p=0),this._saveTagKeys(h),this.transformMetricData(h,i,e.targets[p],e,this.tsdbResolution)))}}))}annotationEvent(e,a){const r=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),o=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),c=[],i=[];c.push({aggregator:"sum",metric:a.target});const n=(0,g.compact)(c);return(0,I.n)(this.performTimeSeriesQuery(n,r,o).pipe((0,y.U)(l=>{if(l.data[0]){let m=l.data[0].annotations;a.isGlobal&&(m=l.data[0].globalAnnotations),m&&(0,g.each)(m,h=>{const p={text:h.description,time:Math.floor(h.startTime)*1e3,annotation:a};i.push(p)})}return i})))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0){for(let a=0;a<e.filters.length;a++)if(this.templateSrv.containsTemplate(e.filters[a].filter))return!0}if(e.tags&&Object.keys(e.tags).length>0){for(const a in e.tags)if(this.templateSrv.containsTemplate(e.tags[a]))return!0}return!1}performTimeSeriesQuery(e,a,r){let o=!1;this.tsdbResolution===2&&(o=!0);const c={start:a,queries:e,msResolution:o,globalAnnotations:!0};this.tsdbVersion===3&&(c.showQuery=!0),r&&(c.end=r);const i={method:"POST",url:this.url+"/api/query",data:c};return this._addCredentialOptions(i),(0,ne.i)().fetch(i)}suggestTagKeys(e){const a=e.metric??"";return Promise.resolve(this.tagKeys[a]||[])}_saveTagKeys(e){const a=Object.keys(e.tags);(0,g.each)(e.aggregateTags,r=>{a.push(r)}),this.tagKeys[e.metric]=a}_performSuggestQuery(e,a){return this._get("/api/suggest",{type:a,q:e,max:this.lookupLimit}).pipe((0,y.U)(r=>r.data))}_performMetricKeyValueLookup(e,a){if(!e||!a)return(0,z.of)([]);const r=a.split(",").map(n=>n.trim()),o=r[0];let c=o+"=*";r.length>1&&(c+=","+r.splice(1).join(","));const i=e+"{"+c+"}";return this._get("/api/search/lookup",{m:i,limit:this.lookupLimit}).pipe((0,y.U)(n=>{n=n.data.results;const l=[];return(0,g.each)(n,m=>{l.indexOf(m.tags[o])===-1&&l.push(m.tags[o])}),l}))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,y.U)(a=>{a=a.data.results;const r=[];return(0,g.each)(a,o=>{(0,g.each)(o.tags,(c,i)=>{r.indexOf(i)===-1&&r.push(i)})}),r})):(0,z.of)([])}_get(e,a){const r={method:"GET",url:this.url+e,params:a};return this._addCredentialOptions(r),(0,ne.i)().fetch(r)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let a;try{a=this.templateSrv.replace(e,{},"distributed")}catch(N){return Promise.reject(N)}const r=N=>(0,g.map)(N,C=>({text:C})),o=/metrics\((.*)\)/,c=/tag_names\((.*)\)/,i=/tag_values\((.*?),\s?(.*)\)/,n=/suggest_tagk\((.*)\)/,l=/suggest_tagv\((.*)\)/,m=a.match(o);if(m)return(0,I.n)(this._performSuggestQuery(m[1],"metrics").pipe((0,y.U)(r)));const h=a.match(c);if(h)return(0,I.n)(this._performMetricKeyLookup(h[1]).pipe((0,y.U)(r)));const p=a.match(i);if(p)return(0,I.n)(this._performMetricKeyValueLookup(p[1],p[2]).pipe((0,y.U)(r)));const w=a.match(n);if(w)return(0,I.n)(this._performSuggestQuery(w[1],"tagk").pipe((0,y.U)(r)));const T=a.match(l);return T?(0,I.n)(this._performSuggestQuery(T[1],"tagv").pipe((0,y.U)(r))):Promise.resolve([])}testDatasource(){return(0,I.n)(this._performSuggestQuery("cpu","metrics").pipe((0,y.U)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,I.n)(this._get("/api/aggregators").pipe((0,y.U)(e=>e.data&&(0,g.isArray)(e.data)?e.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,I.n)(this._get("/api/config/filters").pipe((0,y.U)(e=>e.data?Object.keys(e.data).sort():[]))),this.filterTypesPromise)}transformMetricData(e,a,r,o,c){const i=this.createMetricLabel(e,r,a,o),n=[];return(0,g.each)(e.dps,(l,m)=>{c===2?n.push([l,m*1]):n.push([l,m*1e3])}),{target:i,datapoints:n}}createMetricLabel(e,a,r,o){if(a.alias){const n=(0,g.clone)(o.scopedVars||{});return(0,g.each)(e.tags,(l,m)=>{n["tag_"+m]={value:l}}),this.templateSrv.replace(a.alias,n)}let c=e.metric;const i=[];return(0,g.isEmpty)(e.tags)||(0,g.each)((0,g.toPairs)(e.tags),n=>{(0,g.has)(r,n[0])&&i.push(n[0]+"="+n[1])}),(0,g.isEmpty)(i)||(c+="{"+i.join(", ")+"}"),c}convertTargetToQuery(e,a,r){if(!e.metric||e.hide)return null;const o=this.interpolateVariablesInQuery(e,a.scopedVars);if(e.shouldComputeRate&&(o.rate=!0,o.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(o.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(o.rateOptions.resetValue=parseInt(e.counterResetValue,10)),r>=2&&(o.rateOptions.dropResets=!o.rateOptions.counterMax&&(!o.rateOptions.ResetValue||o.rateOptions.ResetValue===0))),!e.disableDownsampling){let c=this.templateSrv.replace(e.downsampleInterval||a.interval);c.match(/\.[0-9]+s/)&&(c=parseFloat(c)*1e3+"ms"),o.downsample=c+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&e.downsampleFillPolicy!=="none"&&(o.downsample+="-"+e.downsampleFillPolicy)}return e.explicitTags&&(o.explicitTags=!0),o}interpolateVariablesInFilters(e,a){e.filters=e.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,a,"pipe"),r.filter=this.templateSrv.replace(r.filter,a,"pipe"),r))}mapMetricsToTargets(e,a,r){let o,c;return(0,g.map)(e,i=>r===3?i.query.index:(0,g.findIndex)(a.targets,n=>n.filters&&n.filters.length>0?n.metric===i.metric:n.metric===i.metric&&(0,g.every)(n.tags,(l,m)=>(o=this.templateSrv.replace(l,a.scopedVars,"pipe"),c=o.split("|"),(0,g.includes)(c,i.tags[m])||o==="*"))))}interpolateVariablesInQueries(e,a){return e.length?e.map(r=>this.interpolateVariablesInQuery(r,a)):e}interpolateVariablesInQuery(e,a){const r=(0,g.cloneDeep)(e);if(r.metric=this.templateSrv.replace(e.metric,a,"pipe"),r.aggregator="avg",e.aggregator&&(r.aggregator=this.templateSrv.replace(e.aggregator)),r.filters&&r.filters.length>0)this.interpolateVariablesInFilters(r,a);else if(r.tags)for(const o in r.tags)r.tags[o]=this.templateSrv.replace(r.tags[o],a,"pipe");return r}convertToTSDBTime(e,a,r){return e==="now"?null:(e=Ve.parse(e,a,r),e.valueOf())}}const Ae=new q.hf(Pe).setQueryEditor(Ne).setConfigEditor(ue)}}]);

//# sourceMappingURL=opentsdbPlugin.js.map