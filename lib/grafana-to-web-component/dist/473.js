"use strict";(this.webpackChunkGrafanaToWebComponent=this.webpackChunkGrafanaToWebComponent||[]).push([[473],{76644:(Pe,W,s)=>{s.r(W),s.d(W,{default:()=>We,getStyles:()=>re});var y=s(41407),S=s(86832),e=s(39953),oe=s(14058),M=s(92403),L=s(27366),N=s(82803),le=s(33155),ie=s(69865),b=s(39285),Z=s(3532),B=s(4919),ce=s(96227),me=s(36495),ue=s(38637),de=s(20584);const ge=de.C.injectEndpoints({endpoints:t=>({getRuleHistory:t.query({query:({ruleUid:n,from:r,to:a,limit:l=100})=>({url:"/api/v1/rules/history",params:{ruleUID:n,from:r,to:a,limit:l}})})})});var O=s(14949),fe=s(44351),pe=s(87254),U=s(50912),ve=s(97473),F=s(201);function P(t,n){if(t==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t}function he(t){return P({},t)}var ye=s(96448),K=s(73053),G=1e3*60,$=60*24,Q=$*30,Y=$*365;function Ee(t,n,r){var a,l,c;(0,K.Z)(2,arguments);var o=(0,pe.j)(),m=(a=(l=r?.locale)!==null&&l!==void 0?l:o.locale)!==null&&a!==void 0?a:ye.Z;if(!m.formatDistance)throw new RangeError("locale must contain localize.formatDistance property");var p=(0,ve.Z)(t,n);if(isNaN(p))throw new RangeError("Invalid time value");var i=P(he(r),{addSuffix:!!r?.addSuffix,comparison:p}),u,E;p>0?(u=(0,F.Z)(n),E=(0,F.Z)(t)):(u=(0,F.Z)(t),E=(0,F.Z)(n));var R=String((c=r?.roundingMethod)!==null&&c!==void 0?c:"round"),v;if(R==="floor")v=Math.floor;else if(R==="ceil")v=Math.ceil;else if(R==="round")v=Math.round;else throw new RangeError("roundingMethod must be 'floor', 'ceil' or 'round'");var d=E.getTime()-u.getTime(),f=d/G,I=(0,U.Z)(E)-(0,U.Z)(u),h=(d-I)/G,T=r?.unit,g;if(T?g=String(T):f<1?g="second":f<60?g="minute":f<$?g="hour":h<Q?g="day":h<Y?g="month":g="year",g==="second"){var D=v(d/1e3);return m.formatDistance("xSeconds",D,i)}else if(g==="minute"){var V=v(f);return m.formatDistance("xMinutes",V,i)}else if(g==="hour"){var H=v(f/60);return m.formatDistance("xHours",H,i)}else if(g==="day"){var A=v(h/$);return m.formatDistance("xDays",A,i)}else if(g==="month"){var C=v(h/Q);return C===12&&T!=="month"?m.formatDistance("xYears",1,i):m.formatDistance("xMonths",C,i)}else if(g==="year"){var J=v(h/Y);return m.formatDistance("xYears",J,i)}throw new RangeError("unit must be 'second', 'minute', 'hour', 'day', 'month' or 'year'")}function Se(t,n){return(0,K.Z)(1,arguments),Ee(t,Date.now(),n)}var xe=s(48069),Te=s(15429),X=s(78247);function k(t,n){return t.filter(r=>!n.find(a=>JSON.stringify(a)===JSON.stringify(r)))}function be(t){const n=t.flatMap(a=>a);return(0,S.uniqBy)(n.filter(a=>n.filter(c=>(0,S.isEqual)(a,c)).length===Object.keys(t).length),a=>JSON.stringify(a))}function Re(t){const n=t.reduce((r,a)=>{const l=r.get(a.timestamp);return l?l.push(a):r.set(a.timestamp,[a]),r},new Map);return new Map([...n].sort((r,a)=>a[0]-r[0]))}const q=e.memo(({records:t,commonLabels:n,onLabelClick:r,onRecordsRendered:a})=>{const l=(0,N.wW)(j),c=Re(t),o=new Map;return(0,e.useEffect)(()=>{a&&a(o)}),e.createElement("ul",{className:l.logsScrollable,"aria-label":"State history by timestamp"},Array.from(c.entries()).map(([m,p])=>e.createElement("li",{id:m.toString(10),key:m,"data-testid":m,ref:i=>i&&o.set(m,i),className:l.listItemWrapper},e.createElement(Le,{time:m}),e.createElement("div",{className:l.logsContainer},p.map(({line:i})=>e.createElement(e.Fragment,{key:(0,S.uniqueId)()},e.createElement(X.l,{state:i.previous,size:"sm",muted:!0}),e.createElement(b.J,{name:"arrow-right",size:"sm"}),e.createElement(X.l,{state:i.current}),e.createElement(L.K,{direction:"row"},i.values&&e.createElement(w,{record:i.values})),e.createElement("div",null,i.labels&&e.createElement(Z.P,{tags:k(Object.entries(i.labels),n).map(([u,E])=>`${u}=${E}`),onClick:r}))))))))});q.displayName="LogRecordViewerByTimestamp";function Ke({records:t,commonLabels:n}){const r=useStyles2(j),a=groupBy(t,l=>JSON.stringify(l.line.labels));return React.createElement(React.Fragment,null,Object.entries(a).map(([l,c])=>React.createElement(Stack,{direction:"column",key:l},React.createElement("h4",null,React.createElement(TagList,{tags:omitLabels(Object.entries(c[0].line.labels??{}),n).map(([o,m])=>`${o}=${m}`)})),React.createElement("div",{className:r.logsContainer},c.map(({line:o,timestamp:m})=>React.createElement("div",{key:uniqueId()},React.createElement(AlertStateTag,{state:o.previous,size:"sm",muted:!0}),React.createElement(Icon,{name:"arrow-right",size:"sm"}),React.createElement(AlertStateTag,{state:o.current}),React.createElement(Stack,{direction:"row"},o.values&&React.createElement(w,{record:o.values})),React.createElement("div",null,dateTimeFormat(m))))))))}const Le=({time:t})=>{const n=new Date(t),r=(0,N.wW)(j);return e.createElement("div",{className:r.timestampWrapper},e.createElement(L.K,{direction:"row",alignItems:"center",gap:1},e.createElement(b.J,{name:"clock-nine",size:"sm"}),e.createElement("span",{className:r.timestampText},(0,xe.dq)(n)),e.createElement("small",null,"(",Se(n)," ago)")))},w=e.memo(({record:t})=>{const n=Object.entries(t);return e.createElement(e.Fragment,null,n.map(([r,a])=>e.createElement(Te._,{key:r,label:r,value:a})))});w.displayName="AlertInstanceValues";const j=t=>({logsContainer:(0,y.css)`
    display: grid;
    grid-template-columns: max-content max-content max-content auto max-content;
    gap: ${t.spacing(2,1)};
    align-items: center;
  `,logsScrollable:(0,y.css)`
    height: 500px;
    overflow: scroll;

    flex: 1;
  `,timestampWrapper:(0,y.css)`
    color: ${t.colors.text.secondary};
  `,timestampText:(0,y.css)`
    color: ${t.colors.text.primary};
    font-size: ${t.typography.bodySmall.fontSize};
    font-weight: ${t.typography.fontWeightBold};
  `,listItemWrapper:(0,y.css)`
    background: transparent;
    outline: 1px solid transparent;

    transition:
      background 150ms,
      outline 150ms;
    padding: ${t.spacing(1)} ${t.spacing(1.5)};
  `});var Ne=s(19977),Ie=s(86261),_=s(34547),Ce=s(56386),Me=s(80047);const ee=e.memo(({frames:t,timeRange:n,onPointerMove:r=S.noop})=>{const a=(0,N.l4)(),{setupCursorTracking:l}=Oe(r);return e.createElement(Ne.Z,{disableHeight:!0},({width:c})=>e.createElement(Ce.K,{frames:t,timeRange:n,timeZone:"browser",mode:Me.KN.Changes,height:18*t.length+50,width:c,showValue:_.Jp.Never,theme:a,rowHeight:.8,legend:{calcs:[],displayMode:_.jK.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:a.colors.success.main,yAxis:1},{label:"Pending",color:a.colors.warning.main,yAxis:1},{label:"Alerting",color:a.colors.error.main,yAxis:1},{label:"NoData",color:a.colors.info.main,yAxis:1},{label:"Mixed",color:a.colors.text.secondary,yAxis:1}]},o=>(l(o),null)))});function Oe(t){const n=(0,e.useRef)(new Ie.X({seriesIdx:0,pointIdx:0}));return(0,e.useEffect)(()=>{const a=n.current.subscribe(({seriesIdx:l,pointIdx:c})=>{t&&t(l,c)});return()=>{a.unsubscribe()}},[t]),{setupCursorTracking:a=>{a.setSync();const l=a.getTooltipInterpolator();l&&a.addHook("setCursor",c=>{l(o=>{if(o){const m=n.current.getValue();n.current.next({...m,seriesIdx:o})}},o=>{if(o){const m=n.current.getValue();n.current.next({...m,pointIdx:o})}},()=>{},c)})}}}ee.displayName="LogTimelineViewer";var te=s(89591),Fe=s(94123),$e=s(49372),ne=s(41406);function De(t,n){const r=(0,N.l4)();return(0,e.useMemo)(()=>{const a=t?.data?.values[0]??[],l=Ae(a)?a:[],c=t?.data?.values[1]??[],o=l.reduce((d,f,I)=>{const h=c[I];return ze(h)&&d.push({timestamp:f,line:h}),d},[]),m=(0,S.groupBy)(o,d=>JSON.stringify(d.line.labels)),i=Object.keys(m).map(d=>Object.entries(JSON.parse(d))),u=be(i),E=n?(0,O.Zh)(n):[],v=Object.entries(m).filter(([d])=>{const f=JSON.parse(d);return(0,O.eD)(f,E)}).map(([d,f])=>we(d,f,u,r));return{historyRecords:o.filter(({line:d})=>d.labels&&(0,O.eD)(d.labels,E)),dataFrames:v,commonLabels:u,totalRecordsCount:o.length}},[t,n,r])}function Ae(t){return t.every(n=>typeof n=="number")}function ze(t){return typeof t=="object"&&t!==null&&"current"in t&&"previous"in t}function we(t,n,r,a){const l=Object.entries(JSON.parse(t)),c={name:"time",type:te.fS.time,values:[...n.map(i=>i.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},o=c.values.map((i,u)=>u);o.sort((0,$e.Mo)(c));const m=[...n.map(i=>i.line.current),n.at(-1)?.line.current],p={fields:[{...c,values:c.values.map((i,u)=>c.values[o[u]])},{name:"state",type:te.fS.string,values:m.map((i,u)=>m[o[u]]),config:{displayName:k(l,r).map(([i,u])=>`${i}=${u}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:ne.Hi.ValueToText,options:{Alerting:{color:a.colors.error.main},Pending:{color:a.colors.warning.main},Normal:{color:a.colors.success.main},NoData:{color:a.colors.info.main}}}],thresholds:{mode:ne.H3.Absolute,steps:[]}}}],length:c.values.length,name:t};return p.fields.forEach(i=>{i.display=(0,Fe.U)({field:i,theme:a})}),p}const je=12,Ve=({ruleUID:t})=>{const n=(0,N.wW)(re),[r,a]=(0,e.useState)(""),l=(0,e.useRef)(new Map),{getValues:c,setValue:o,register:m,handleSubmit:p}=(0,oe.cI)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:i}=ge,u=(0,e.useMemo)(()=>Je(),[]),{currentData:E,isLoading:R,isError:v,error:d}=i({ruleUid:t,from:u.from.unix(),to:u.to.unix(),limit:250}),{dataFrames:f,historyRecords:I,commonLabels:h,totalRecordsCount:T}=De(E,r),{frameSubset:g,frameSubsetTimestamps:D,frameTimeRange:V}=He(f),H=(0,e.useCallback)(x=>{const z=(0,O.vB)(c("query"),x);a(z),o("query",z)},[a,o,c]),A=(0,e.useCallback)(()=>{a(""),o("query","")},[a,o]),C=(0,e.useRef)(void 0),J=(0,e.useCallback)((x,z)=>{C.current?.classList.remove(n.highlightedLogRecord);const Ue=D[z],se=l.current.get(Ue);se?.classList.add(n.highlightedLogRecord),C.current=se},[D,n.highlightedLogRecord]);if(R)return e.createElement("div",null,"Loading...");if(v)return e.createElement(le.b,{title:"Error fetching the state history",severity:"error"},d instanceof Error?d.message:"Unable to fetch alert state history");const Ze=g.length<f.length,Be=T>0?`No matches were found for the given filters among the ${T} instances`:"No state transitions have occurred in the last 30 days";return e.createElement("div",{className:n.fullSize},e.createElement("form",{onSubmit:p(x=>a(x.query))},e.createElement(ae,{...m("query"),showClearFilterSuffix:!!r,onClearFilterClick:A}),e.createElement("input",{type:"submit",hidden:!0})),!(0,S.isEmpty)(h)&&e.createElement("div",{className:n.commonLabels},e.createElement(L.K,{gap:1,alignItems:"center"},e.createElement("strong",null,"Common labels"),e.createElement(ie.u,{content:"Common labels are the ones attached to all of the alert instances"},e.createElement(b.J,{name:"info-circle"}))),e.createElement(Z.P,{tags:h.map(x=>x.join("="))})),(0,S.isEmpty)(g)?e.createElement(e.Fragment,null,e.createElement("div",{className:n.emptyState},Be,T>0&&e.createElement(B.zx,{variant:"secondary",type:"button",onClick:A},"Clear filters"))):e.createElement(e.Fragment,null,e.createElement("div",{className:n.graphWrapper},e.createElement(ee,{frames:g,timeRange:V,onPointerMove:J})),Ze&&e.createElement("div",{className:n.moreInstancesWarning},e.createElement(L.K,{direction:"row",alignItems:"center",gap:1},e.createElement(b.J,{name:"exclamation-triangle",size:"sm"}),e.createElement("small",null,`Only showing ${g.length} out of ${f.length} instances. Click on the labels to narrow down the results`))),e.createElement(q,{records:I,commonLabels:h,onRecordsRendered:x=>l.current=x,onLabelClick:H})))};function He(t){return(0,e.useMemo)(()=>{const n=(0,S.take)(t,je),r=(0,S.sortBy)((0,S.uniq)(n.flatMap(p=>p.fields[0].values))),a=Math.min(...r),l=Math.max(...r),c=(0,M.CQ)(a),o=(0,M.CQ)(l);return{frameSubset:n,frameSubsetTimestamps:r,frameTimeRange:{from:c,to:o,raw:{from:c,to:o}}}},[t])}const ae=e.forwardRef(({showClearFilterSuffix:t,onClearFilterClick:n,...r},a)=>e.createElement(ce.g,{label:e.createElement(me._,{htmlFor:"instancesSearchInput"},e.createElement(L.K,{gap:.5},e.createElement("span",null,"Filter instances"),e.createElement(fe.z,{content:e.createElement(e.Fragment,null,"Use label matcher expression (like ",e.createElement("code",null,"{foo=bar}"),") or click on an instance label to filter instances")},e.createElement(b.J,{name:"info-circle",size:"sm"}))))},e.createElement(ue.I,{id:"instancesSearchInput",prefix:e.createElement(b.J,{name:"search"}),suffix:t&&e.createElement(B.zx,{fill:"text",icon:"times",size:"sm",onClick:n},"Clear"),placeholder:"Filter instances",ref:a,...r})));ae.displayName="SearchFieldInput";function Je(){const t=(0,M.CQ)().subtract(30,"days"),n=(0,M.CQ)();return{from:t,to:n,raw:{from:t,to:n}}}const re=t=>({fullSize:(0,y.css)`
    min-width: 100%;
    height: 100%;

    display: flex;
    flex-direction: column;
  `,graphWrapper:(0,y.css)`
    padding: ${t.spacing()} 0;
  `,emptyState:(0,y.css)`
    color: ${t.colors.text.secondary};

    display: flex;
    flex-direction: column;
    gap: ${t.spacing(2)};
    align-items: center;
    margin: auto auto;
  `,moreInstancesWarning:(0,y.css)`
    color: ${t.colors.warning.text};
    padding: ${t.spacing()};
  `,commonLabels:(0,y.css)`
    display: grid;
    grid-template-columns: max-content auto;
  `,highlightedLogRecord:(0,y.css)`
    background: ${t.colors.primary.transparent} !important;
    outline: 1px solid ${t.colors.primary.shade} !important;
  `}),We=Ve}}]);

//# sourceMappingURL=473.js.map