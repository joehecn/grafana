"use strict";(this.webpackChunkGrafanaToWebComponent=this.webpackChunkGrafanaToWebComponent||[]).push([[7444],{67444:(se,W,d)=>{d.r(W),d.d(W,{plugin:()=>_a});var k=d(54721),m=d(86832),s=d(39953),b=d(47635),M=d(3587),N=d(9558),D=d(33155),U=d(3782),O=d(69171),p=d(50820);const H="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.",F="default";var y=(a=>(a.InfluxQL="InfluxQL",a.Flux="Flux",a.SQL="SQL",a))(y||{}),h=d(56921);const{Input:R,SecretFormField:L}=M.LegacyForms,Y=a=>{const{options:{jsonData:e,secureJsonData:t,secureJsonFields:r}}=a,n=(0,m.uniqueId)("influxdb-flux-config");return s.createElement(s.Fragment,null,s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{htmlFor:`${n}-org`,className:"width-10"},"Organization"),s.createElement("div",{className:"width-10"},s.createElement(R,{id:`${n}-org`,className:"width-20",value:e.organization||"",onChange:(0,b._R)(a,"organization")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(L,{isConfigured:!!(r&&r.token),value:t?.token||"",label:"Token","aria-label":"Token",labelWidth:10,inputWidth:20,onReset:()=>(0,b.Mf)(a,"token"),onChange:(0,b.fi)(a,"token")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{className:"width-10"},"Default Bucket"),s.createElement("div",{className:"width-10"},s.createElement(R,{className:"width-20",placeholder:"default bucket",value:e.defaultBucket||"",onChange:(0,b._R)(a,"defaultBucket")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),s.createElement("div",{className:"width-10"},s.createElement(R,{className:"width-20",placeholder:"10s",value:e.timeInterval||"",onChange:(0,b._R)(a,"timeInterval")})))))},{Input:J,SecretFormField:Ne}=M.LegacyForms,Re=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],be=a=>{const{options:e,onOptionsChange:t}=a,{database:r,jsonData:n,secureJsonData:i,secureJsonFields:o}=e,l=(0,m.uniqueId)("influxdb-influxql-config");return s.createElement(s.Fragment,null,s.createElement(D.b,{severity:"info",title:"Database Access"},s.createElement("p",null,"Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",s.createElement("code",null,"SHOW MEASUREMENTS ON _internal")," or",s.createElement("code",null,'SELECT * FROM "_internal".."database" LIMIT 10'),s.createElement("br",null),s.createElement("br",null),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB.")),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{htmlFor:`${l}-db`,className:"width-10"},"Database"),s.createElement("div",{className:"width-20"},s.createElement(J,{id:`${l}-db`,className:"width-20",value:n.dbName??r,onChange:u=>{t({...e,database:"",jsonData:{...n,dbName:u.target.value}})}})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{htmlFor:`${l}-user`,className:"width-10"},"User"),s.createElement("div",{className:"width-10"},s.createElement(J,{id:`${l}-user`,className:"width-20",value:e.user||"",onChange:(0,b.z_)(a,"user")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(Ne,{isConfigured:!!(o&&o.password),value:i?.password||"",label:"Password","aria-label":"Password",labelWidth:10,inputWidth:20,onReset:()=>(0,b.Mf)(a,"password"),onChange:(0,b.fi)(a,"password")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{htmlFor:`${l}-http-method`,className:"width-10",tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`},"HTTP Method"),s.createElement(N.Ph,{inputId:`${l}-http-method`,className:"width-20",value:Re.find(u=>u.value===e.jsonData.httpMode),options:Re,defaultValue:e.jsonData.httpMode,onChange:(0,b.nx)(a,"httpMode")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),s.createElement("div",{className:"width-10"},s.createElement(J,{className:"width-20",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,b._R)(a,"timeInterval")})))))};var qe=d(63423),_e=d(74661),$=d(38637),X=d(99491);const et=(a,e)=>{a([...e,{key:"",value:""}])},tt=(a,e,t)=>{const r=[...t];r.splice(a,1),e(r)},at=(a,e,t,r)=>{const n=[...e];n[t].key=a,r(n)},rt=(a,e,t,r)=>{const n=[...e];n[t].value=a,r(n)},nt=a=>{const{options:{jsonData:e,secureJsonData:t,secureJsonFields:r}}=a,n=e?.metadata?.length?e?.metadata?.map(l=>({key:Object.keys(l)[0],value:Object.values(l)[0]})):[{key:"bucket-name",value:""}],[i,o]=(0,s.useState)(n);return(0,s.useEffect)(()=>{const{onOptionsChange:l,options:u}=a,c=i?.map(f=>({[f.key]:f.value})),g={...u.jsonData,metadata:c};l({...u,jsonData:g})},[i]),s.createElement("div",null,s.createElement("div",{className:"gf-form"},s.createElement("h6",null,"Token")),s.createElement("div",null,s.createElement(O._,{labelWidth:20,label:"Token"},s.createElement(qe.m4,{width:40,name:"token",type:"text",value:t?.token||"",onReset:()=>(0,b.Mf)(a,"token"),onChange:(0,b.fi)(a,"token"),isConfigured:r?.token}))),s.createElement("div",null,s.createElement("div",{className:"gf-form"},s.createElement("h6",null,"MetaData")),i?.map((l,u)=>s.createElement(_e.Z,{key:u,style:{flexFlow:"row"}},s.createElement(O._,{labelWidth:20,label:"Key"},s.createElement($.I,{key:u,width:40,name:"key",type:"text",value:i[u]?.key||"",placeholder:"key",onChange:c=>at(c.currentTarget.value,i,u,o)})),s.createElement(O._,{labelWidth:20,label:"Value"},s.createElement($.I,{key:u,width:40,name:"value",type:"text",value:i[u]?.value?.toString()??"",placeholder:"value",onChange:c=>rt(c.currentTarget.value,i,u,o)})),u+1>=i.length&&s.createElement(X.W,{as:"button",className:"",onClick:()=>et(o,i),width:"auto"},"+"),u>0&&s.createElement(X.W,{as:"button",className:"",width:"auto",onClick:()=>tt(u,o,i)},"-")))))},{Input:st}=M.LegacyForms,de=[{label:"InfluxQL",value:y.InfluxQL,description:"The InfluxDB SQL-like query language."},{label:"Flux",value:y.Flux,description:"Advanced data scripting and query language. Supported in InfluxDB 2.x and 1.8+"}],_=[...de,{label:"SQL",value:y.SQL,description:"Native SQL language. Supported in InfluxDB 3.0"}];class it extends s.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.versionNotice={Flux:"Support for Flux in Grafana is currently in beta",SQL:"Support for SQL in Grafana is currently in alpha"},this.onResetPassword=()=>{(0,b.Mf)(this.props,"password")},this.onResetToken=()=>{(0,b.Mf)(this.props,"token")},this.onVersionChanged=t=>{const{options:r,onOptionsChange:n}=this.props,i={...r,jsonData:{...r.jsonData,version:t.value}};if(t.value===y.Flux){i.access="proxy",i.basicAuth=!0,i.jsonData.httpMode="POST";const{user:o,database:l,...u}=i;n(u)}else n(i)},this.getQueryLanguageDropdownValue=t=>{switch(t){case y.InfluxQL:return _[0];case y.Flux:return _[1];case y.SQL:return _[2];default:return _[0]}},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,m.uniqueId)("influxdb-config")}renderJsonDataOptions(){switch(this.props.options.jsonData.version){case y.InfluxQL:return s.createElement(be,{...this.props});case y.Flux:return s.createElement(Y,{...this.props});case y.SQL:return s.createElement(nt,{...this.props});default:return s.createElement(be,{...this.props})}}render(){const{options:e,onOptionsChange:t}=this.props,r=e.access==="direct";return s.createElement(s.Fragment,null,s.createElement("h3",{className:"page-heading"},"Query Language"),s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(N.Ph,{"aria-label":"Query language",className:"width-30",value:this.getQueryLanguageDropdownValue(e.jsonData.version),options:p.config.featureToggles.influxdbSqlSupport?_:de,defaultValue:de[0],onChange:this.onVersionChanged})))),e.jsonData.version!==y.InfluxQL&&s.createElement(D.b,{severity:"info",title:this.versionNotice[e.jsonData.version]},s.createElement("p",null,"Please report any issues to: ",s.createElement("br",null),s.createElement("a",{href:"https://github.com/grafana/grafana/issues/new/choose"},"https://github.com/grafana/grafana/issues"))),r&&s.createElement(D.b,{title:"Error",severity:"error"},H),s.createElement(U.E,{showAccessOptions:r,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t,secureSocksDSProxyEnabled:p.config.secureSocksDSProxyEnabled}),s.createElement("div",{className:"gf-form-group"},s.createElement("div",null,s.createElement("h3",{className:"page-heading"},"InfluxDB Details")),this.renderJsonDataOptions(),s.createElement("div",{className:"gf-form-inline"},s.createElement(O._,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000."},s.createElement(st,{placeholder:"1000",type:"number",className:"width-20",value:this.state.maxSeries,onChange:n=>{this.setState({maxSeries:n.currentTarget.value});const i=parseInt(n.currentTarget.value,10);(0,b.tp)(this.props,"maxSeries",Number.isFinite(i)?i:void 0)}})))))}}const ot=it;var A=d(41407),fe=d(55705),C=d(40927);const ge=[],T={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Ae(a){const e=ge[a.type];if(!e)throw{message:"Could not find query part "+a.type};return new C.XN(a,e)}function I(a){ge[a.type]=new C.zU(a),a.category.push(ge[a.type])}const pe=[];function lt(a,e){return e+' AS "'+a.params[0]+'"'}function Oe(a){const e=a.params[0];if(e==="*")return"*";let t=`"${e}"`;return e.endsWith("::tag")&&(t=`"${e.slice(0,-5)}"::tag`),e.endsWith("::field")&&(t=`"${e.slice(0,-7)}"::field`),t}function w(a,e){for(let t=0;t<a.length;t++){const r=a[t];if(r.def.category===T.Aggregations){if(r.def.type===e.def.type)return;if(r.def.type==="count"&&e.def.type==="distinct")break;if(r.def.type==="distinct"){const n=a.length>=t+2;if(e.def.type!=="count"&&n)a[t+1].def.category===T.Aggregations&&a.splice(t+1,1);else if(e.def.type==="count"){(!n||a[t+1].def.type!=="count")&&a.splice(t+1,0,e);return}}a[t]=e;return}if(r.def.category===T.Selectors){a[t]=e;return}}a.splice(1,0,e)}function G(a,e){let t;for(t=0;t<a.length;t++){const r=a[t];if(r.def.category===T.Math||r.def.category===T.Aliasing)break}a.splice(t,0,e)}function ut(a,e){const t=a.length;if(t>0){if(a[t-1].def.type==="math"){a[t-1]=e;return}if(t>1&&a[t-2].def.type==="math"){a[t-2]=e;return}else if(a[t-1].def.type==="alias"){a.splice(t-1,0,e);return}}a.push(e)}function ct(a,e){const t=a.length;if(t>0&&a[t-1].def.type==="alias"){a[t-1]=e;return}a.push(e)}function mt(a,e,t){const r=(0,m.map)(a,n=>Ae({type:n.def.type,params:(0,m.clone)(n.params)}));t.selectModels.push(r)}I({type:"field",addStrategy:mt,category:T.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:Oe}),I({type:"count",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"distinct",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"integral",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"mean",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"median",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"mode",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"sum",addStrategy:w,category:T.Aggregations,params:[],defaultParams:[],renderer:C.D}),I({type:"derivative",addStrategy:G,category:T.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.D}),I({type:"spread",addStrategy:G,category:T.Transformations,params:[],defaultParams:[],renderer:C.D}),I({type:"non_negative_derivative",addStrategy:G,category:T.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.D}),I({type:"difference",addStrategy:G,category:T.Transformations,params:[],defaultParams:[],renderer:C.D}),I({type:"non_negative_difference",addStrategy:G,category:T.Transformations,params:[],defaultParams:[],renderer:C.D}),I({type:"moving_average",addStrategy:G,category:T.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:C.D}),I({type:"cumulative_sum",addStrategy:G,category:T.Transformations,params:[],defaultParams:[],renderer:C.D}),I({type:"stddev",addStrategy:G,category:T.Transformations,params:[],defaultParams:[],renderer:C.D}),I({type:"time",category:pe,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:C.D}),I({type:"fill",category:pe,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:C.D}),I({type:"elapsed",addStrategy:G,category:T.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.D}),I({type:"holt_winters",addStrategy:G,category:T.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:C.D}),I({type:"holt_winters_with_fit",addStrategy:G,category:T.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:C.D}),I({type:"bottom",addStrategy:w,category:T.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:C.D}),I({type:"first",addStrategy:w,category:T.Selectors,params:[],defaultParams:[],renderer:C.D}),I({type:"last",addStrategy:w,category:T.Selectors,params:[],defaultParams:[],renderer:C.D}),I({type:"max",addStrategy:w,category:T.Selectors,params:[],defaultParams:[],renderer:C.D}),I({type:"min",addStrategy:w,category:T.Selectors,params:[],defaultParams:[],renderer:C.D}),I({type:"percentile",addStrategy:w,category:T.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:C.D}),I({type:"top",addStrategy:w,category:T.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:C.D}),I({type:"tag",category:pe,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:Oe}),I({type:"math",addStrategy:ut,category:T.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:C.C7}),I({type:"alias",addStrategy:ct,category:T.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:lt});const z={create:Ae,getCategories:()=>T,replaceAggregationAdd:w};class V{constructor(e,t,r){this.selectModels=[],this.target=e,this.templateSrv=t,this.scopedVars=r,e.policy=e.policy||F,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,m.map)(this.target.select,e=>(0,m.map)(e,z.create)),this.groupByParts=(0,m.map)(this.target.groupBy,z.create)}updatePersistedParts(){this.target.select=(0,m.map)(this.selectModels,e=>(0,m.map)(e,t=>({type:t.def.type,params:t.params})))}hasGroupByTime(){return(0,m.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,m.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const r=t[1],n=t[2],i=z.create({type:r,params:[n]}),o=this.target.groupBy.length;o===0?this.target.groupBy.push(i.part):r==="time"?this.target.groupBy.splice(0,0,i.part):r==="tag"?this.target.groupBy[o-1].type==="fill"?this.target.groupBy.splice(o-1,0,i.part):this.target.groupBy.push(i.part):this.target.groupBy.push(i.part),this.updateProjection()}removeGroupByPart(e,t){const r=z.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,m.filter)(this.target.groupBy,n=>n.type!=="fill"),this.target.select=(0,m.map)(this.target.select,n=>(0,m.filter)(n,i=>{const o=z.create(i);return!(o.def.category===r.Aggregations||o.def.category===r.Selectors)}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if(t.def.type==="field"){if(this.selectModels.length>1){const r=(0,m.indexOf)(this.selectModels,e);this.selectModels.splice(r,1)}}else{const r=(0,m.indexOf)(e,t);e.splice(r,1)}this.updatePersistedParts()}addSelectPart(e,t){const r=z.create({type:t});r.def.addStrategy(e,r,this),this.updatePersistedParts()}renderTagCondition(e,t,r){let n="",i=e.operator,o=e.value;t>0&&(n=(e.condition||"AND")+" "),i||(/^\/.*\/$/.test(o)?i="=~":i="="),i!=="=~"&&i!=="!~"?(r&&(o=this.templateSrv.replace(o,this.scopedVars)),i!==">"&&i!=="<"&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'")):r&&(o=this.templateSrv.replace(o,this.scopedVars,"regex"));let l=`"${e.key}"`;return e.key.endsWith("::tag")&&(l=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(l=`"${e.key.slice(0,-7)}"::field`),n+l+" "+i+" "+o}getMeasurementAndPolicy(e){let t=this.target.policy,r=this.target.measurement||"measurement";return r.match("^/.*/$")?e&&(r=this.templateSrv.replace(r,this.scopedVars,"regex")):r='"'+r+'"',t!==F?t='"'+this.target.policy+'".':t="",t+r}interpolateQueryStr(e,t,r){return!t.multi&&!t.includeAll?e:typeof e=="string"?(0,fe.yI)(e):"("+(0,m.map)(e,fe.yI).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let r="SELECT ",n,i;for(n=0;n<this.selectModels.length;n++){const u=this.selectModels[n];let c="";for(i=0;i<u.length;i++)c=u[i].render(c);n>0&&(r+=", "),r+=c}r+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const o=(0,m.map)(t.tags,(u,c)=>this.renderTagCondition(u,c,e));o.length>0&&(r+="("+o.join(" ")+") AND "),r+="$timeFilter";let l="";for(n=0;n<this.groupByParts.length;n++){const u=this.groupByParts[n];n>0&&(l+=u.def.type==="fill"?" ":", "),l+=u.render("")}return l.length&&(r+=" GROUP BY "+l),t.fill&&(r+=" fill("+t.fill+")"),t.orderByTime==="DESC"&&(r+=" ORDER BY time DESC"),t.limit&&(r+=" LIMIT "+t.limit),t.slimit&&(r+=" SLIMIT "+t.slimit),t.tz&&(r+=" tz('"+t.tz+"')"),r}renderAdhocFilters(e){return(0,m.map)(e,(r,n)=>this.renderTagCondition(r,n,!0)).join(" ")}}function xe(a){const e=(0,m.cloneDeep)(a);return new V(e).render(!1)}function dt(a){if(a.policy!==void 0&&a.resultFormat!==void 0&&a.orderByTime!==void 0&&a.tags!==void 0&&a.groupBy!==void 0&&a.select!==void 0)return a;const e=(0,m.cloneDeep)(a);return new V(e).target}function ft(a,e,t){const r=(0,m.cloneDeep)(a),n=new V(r);return n.addSelectPart(n.selectModels[t],e),n.target}function gt(a,e,t){const r=(0,m.cloneDeep)(a),n=new V(r),i=n.selectModels[t];return n.removeSelectPart(i,i[e]),n.target}function pt(a,e,t,r){const n=[...a.select??[]];return n[e]=[...n[e]],n[e][t]={...n[e][t],params:r},{...a,select:n}}function ht(a,e){const t=(0,m.cloneDeep)(a),r=new V(t);return r.addGroupBy(e),r.target}function Et(a,e){const t=(0,m.cloneDeep)(a),r=new V(t);return r.removeGroupByPart(r.groupByParts[e],e),r.target}function yt(a,e,t){const r=[...a.groupBy??[]];return r[e]={...r[e],params:t},{...a,groupBy:r}}var De=d(79059),Z=d(99566),vt=d(84541),ie=d(4919),St=d(26005),oe=d(82803);const Tt=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class It extends s.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e}),this.props.onRunQuery()},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate(),this.props.onRunQuery()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:Z.k.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:Z.k.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:Z.k.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:Z.k.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:Z.k.Property,detail:"org configured for the datsource"}],t=(0,De.J)();return t.getVariables().forEach(r=>{const n="${"+r.name+"}";let i=t.replace(n);i===n&&(i=""),e.push({label:n,kind:Z.k.Text,detail:`(Template Variable) ${i}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:t}=this.props,r=Ct(t),n=s.createElement("div",null,"Type: ",s.createElement("i",null,"ctrl+space")," to show template variable suggestions ",s.createElement("br",null),"Many queries can be copied from Chronograf");return s.createElement(s.Fragment,null,s.createElement(vt.p,{height:"100%",containerStyles:r.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),s.createElement("div",{className:(0,A.cx)("gf-form-inline",r.editorActions)},s.createElement(ie.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/"},"Flux language syntax"),s.createElement(St.X,{options:Tt,value:"Sample query",onChange:this.onSampleChange,className:(0,A.css)`
              margin-top: -${t.spacing(.5)};
              margin-left: ${t.spacing(.5)};
            `}),s.createElement("div",{className:"gf-form gf-form--grow"},s.createElement("div",{className:"gf-form-label gf-form-label--grow"})),s.createElement(h.c,{width:5,tooltip:n},"Help")))}}const Ct=a=>({editorContainerStyles:(0,A.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${a.isDark?a.colors.background.canvas:a.colors.background.primary};
    padding-bottom: ${a.spacing(1)};
  `,editorActions:(0,A.css)`
    margin-top: 6px;
  `}),he=(0,oe.HE)(It);var Nt=d(42933),le=d(78597),Rt=d(64755),bt=d(55232),At=d(67564),Ee=d(16824),Ot=d(75392),ee=d(63565);class xt extends Rt.D{constructor(e){super(e),this.instanceSettings=e}getQueryModel(){return{quoteLiteral:ee.MM}}getSqlLanguageDefinition(){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const e={getMeta:t=>this.fetchMeta(t)};return this.sqlLanguageDefinition={id:"mysql",completionProvider:(0,Ot.Iu)(e),formatter:bt._},this.sqlLanguageDefinition}async fetchDatasets(){return(await this.runSql((0,Ee.tk)(),{refId:"datasets"})).map(t=>(0,ee.vy)(t[0]))}async fetchTables(e){const t=(0,Ee.qw)(e);return(await this.runSql(t,{refId:"tables"})).map(n=>(0,ee.vy)(n[0]))}async fetchFields(e){if(!e.dataset||!e.table)return[];const t=(0,Ee.W2)(e.table,e.dataset),n=(await this.runSql(t,{refId:"fields"})).map(i=>({name:i[0],text:i[0],value:(0,ee.vy)(i[0]),type:i[1],label:i[0]}));return(0,At.J)(n)}async fetchMeta(e){const t=this.instanceSettings.jsonData.database;return!e?.schema&&t?(await this.fetchTables(t)).map(n=>({name:n,completion:`${t}.${n}`,kind:le.cm.Class})):!e?.schema&&!t?(await this.fetchDatasets()).map(n=>({name:n,completion:`${n}.`,kind:le.cm.Module})):!e?.table&&(!t||e?.schema)?(await this.fetchTables(e?.schema)).map(n=>({name:n,completion:n,kind:le.cm.Class})):e?.table&&e.schema?(await this.fetchFields({dataset:e.schema,table:e.table})).map(n=>({name:n.name,completion:n.value,kind:le.cm.Field})):[]}getDB(){return this.db!==void 0?this.db:{datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),fields:e=>this.fetchFields(e),validateQuery:(e,t)=>Promise.resolve({query:e,error:"",isError:!1,isValid:!0}),dsID:()=>this.id,toRawSql:ee.Et,functions:()=>["VARIANCE","STDDEV"],getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition()}}}class Dt extends s.PureComponent{constructor(e){super(e);const{datasource:t}=e;this.datasource=new xt({url:t.urls[0],access:t.access,id:t.id,jsonData:{allowCleartextPasswords:!1,tlsAuth:!1,tlsAuthWithCACert:!1,tlsSkipVerify:!1,maxIdleConns:1,maxOpenConns:1,maxIdleConnsAuto:!0,connMaxLifetime:1,timezone:"",user:"",database:"",url:t.urls[0],timeInterval:""},meta:t.meta,name:t.name,readOnly:!1,type:t.type,uid:t.uid})}transformQuery(e){return{...e}}render(){const{query:e,theme:t,onRunQuery:r,onChange:n}=this.props,i=Lt(t),o=()=>r(),l=c=>{n({...c})},u=s.createElement("div",null,"Type: ",s.createElement("i",null,"ctrl+space")," to show template variable suggestions ",s.createElement("br",null),"Many queries can be copied from Chronograf");return s.createElement(s.Fragment,null,s.createElement(D.b,{title:"Warning",severity:"warning"},"InfluxDB SQL support is currently in alpha state. It does not have all the features."),s.createElement(Nt.M,{datasource:this.datasource,query:this.transformQuery(e),onRunQuery:o,onChange:l}),s.createElement("div",{className:(0,A.cx)("gf-form-inline",i.editorActions)},s.createElement(ie.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/cloud-serverless/query-data/sql/"},"SQL language syntax"),s.createElement("div",{className:"gf-form gf-form--grow"},s.createElement("div",{className:"gf-form-label gf-form-label--grow"})),s.createElement(h.c,{width:5,tooltip:u},"Help")))}}const Lt=a=>({editorContainerStyles:(0,A.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${a.isDark?a.colors.background.canvas:a.colors.background.primary};
    padding-bottom: ${a.spacing(1)};
  `,editorActions:(0,A.css)`
    margin-top: 6px;
  `}),wt=(0,oe.HE)(Dt);var Pt=d(32840);const Mt=({isRaw:a,onChange:e})=>{const[t,r]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{r(!1)},[a]),a?s.createElement(s.Fragment,null,s.createElement(ie.zx,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{r(!0)}}),s.createElement(Pt.s,{isOpen:t,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{r(!1)}})):s.createElement(ie.zx,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var Le=d(68421),Ft=d(12223);const we=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],Pe="time_series";var Bt=d(7763);function ue(a){const[e,t]=(0,s.useState)(a),r=(0,Bt.Z)(a);return(0,s.useEffect)(()=>{r!==a&&e!==a&&t(a)},[a,e,r]),[e,t]}const Qt=({query:a,onChange:e,onRunQuery:t})=>{const[r,n]=ue(a.query),[i,o]=ue(a.alias),l=(0,s.useId)(),u=(0,s.useId)(),c=a.resultFormat??Pe,g=()=>{e({...a,query:r,alias:i,resultFormat:c}),t()};return s.createElement("div",null,s.createElement(Le.K,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:g,onChange:f=>{n(f.currentTarget.value)},value:r??""}),s.createElement(Ft.Lh,null,s.createElement(h.c,{htmlFor:u},"Format as"),s.createElement(N.Ph,{inputId:u,onChange:f=>{e({...a,resultFormat:f.value}),t()},value:c,options:we}),s.createElement(h.c,{htmlFor:l},"Alias by"),s.createElement($.I,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:g,onChange:f=>{o(f.currentTarget.value)},value:i??""})))};var q=d(75160);const ye=a=>{let e="",{type:t,templateService:r,scopedVars:n,database:i,measurement:o,retentionPolicy:l,tags:u,withKey:c,withMeasurementFilter:g}=a;switch(t){case"RETENTION_POLICIES":return'SHOW RETENTION POLICIES on "'+i+'"';case"FIELDS":return!o||o===""?"SHOW FIELD KEYS":(o&&!o.match(/^\/.*\/|^$/)&&(o='"'+o+'"',l&&l!==F&&(l='"'+l+'"',o=l+"."+o)),"SHOW FIELD KEYS FROM "+o);case"TAG_KEYS":e="SHOW TAG KEYS";break;case"TAG_VALUES":e="SHOW TAG VALUES";break;case"MEASUREMENTS":e="SHOW MEASUREMENTS",g&&(e+=" WITH MEASUREMENT =~ /(?i)"+(0,fe.yI)(g)+"/");break;default:return e}if(o&&(!o.match("^/.*/")&&!o.match(/^merge\(.*\)/)&&(o='"'+o+'"'),l&&l!==F&&(l='"'+l+'"',o=l+"."+o),o!==""&&(e+=" FROM "+o)),c){let f=c;f.endsWith("::tag")&&(f=f.slice(0,-5)),e+=' WITH KEY = "'+f+'"'}if(u&&u.length>0){const f=(0,m.reduce)(u,(v,E)=>(E.key&&E.key===c||E.operator===">"||E.operator==="<"||v.push(kt(E,v.length,r,n,!0)),v),[]);f.length>0&&(e+=" WHERE "+f.join(" "))}return t==="MEASUREMENTS"&&(e+=" LIMIT 100"),e};function kt(a,e,t,r,n){let i="",o=a.operator,l=a.value;e>0&&(i=(a.condition||"AND")+" "),o||(/^\/.*\/$/.test(a.value)?o="=~":o="="),(l===""||o!=="=~"&&o!=="!~")&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),o!=="=~"&&o!=="!~"?n?l=t.replace(l,r):o!==">"&&o!=="<"&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"):n&&(l=t.replace(l,r,"regex"));let u=`"${a.key}"`;return a.key.endsWith("::tag")&&(u=`"${a.key.slice(0,-5)}"::tag`),a.key.endsWith("::field")&&(u=`"${a.key.slice(0,-7)}"::field`),i+u+" "+o+" "+l}const te=async a=>{const{type:e,datasource:t,scopedVars:r,measurement:n,retentionPolicy:i,tags:o,withKey:l,withMeasurementFilter:u}=a,c=ye({type:e,scopedVars:r,measurement:n,retentionPolicy:i,tags:o,withKey:l,withMeasurementFilter:u,templateService:t.templateSrv,database:t.database}),g=i?t.templateSrv.replace(i,{},"regex"):"",f={query:c,policy:g,rawQuery:!0,refId:"metadataQuery"};if(p.default.featureToggles.influxdbBackendMigration)return t.runMetadataQuery(f);{const v={policy:f.policy};return t.metricFindQuery(c,v)}};async function Ut(a){return(await te({type:"RETENTION_POLICIES",datasource:a})).map(t=>t.text)}async function Gt(a,e,t){return(await te({type:"MEASUREMENTS",datasource:a,tags:e,withMeasurementFilter:t})).map(n=>n.text)}async function Vt(a,e,t){return(await te({type:"TAG_KEYS",datasource:a,measurement:e,retentionPolicy:t})).map(n=>n.text)}async function Wt(a,e,t,r,n){return t.endsWith("::field")?[]:(await te({type:"TAG_VALUES",tags:e,withKey:t,datasource:a,measurement:r,retentionPolicy:n})).map(o=>o.text)}async function Me(a,e,t){return(await te({type:"FIELDS",datasource:a,measurement:e,retentionPolicy:t})).map(n=>n.text)}function Fe(a,e){return a.filter(t=>t.key.endsWith("::tag")||e.has(t.key+"::tag"))}function B(a){return{label:a,value:a}}function ae(a){if(a==null)throw new Error("value must not be nullish");return a}function $t(){const a=z.getCategories(),e=[];return Object.keys(a).forEach(r=>{const n=a[r].map(i=>B(i.type));e.push({label:r,options:n})}),e}async function Ht(a,e){const t=await e(),r={...a},n=new V(r),i=[];return n.hasFill()||i.push(B("fill(null)")),n.hasGroupByTime()||i.push(B("time($interval)")),t.forEach(o=>{i.push(B(`tag(${o})`))}),i}function Kt(a,e){const t=z.create(a).def,r=(a.params??[]).map(n=>n.toString());if(r.length!==t.params.length)throw new Error("Invalid query-segment");return r.map((n,i)=>{const o=t.params[i];return o.dynamicLookup?{value:n,options:ae(e.get(`${t.type}_${i}`))}:o.options!=null?{value:n,options:()=>Promise.resolve(o.options)}:{value:n,options:null}})}function Be(a,e){return a.map(t=>({name:t.type,params:Kt(t,e)}))}function Yt(a){return(0,De.J)().getVariables().map(a)}function ve(a,e,t){let r=Yt(e);return t&&(r=r.filter(n=>n.indexOf(t)>-1)),a.then(n=>[...r,...n])}function Qe(a){return`/^$${a.name}$/`}function zt(a){return`$${a.name}`}const Se=(0,A.css)({paddingRight:"4px"}),jt=(0,A.cx)("width-8",Se),Xt=({format:a,inputId:e,onChange:t})=>s.createElement(N.Ph,{inputId:e,className:jt,onChange:r=>{t(ae(r.value))},value:a,options:we});var Te=d(81803),Jt=d(97368),Zt=d.n(Jt),qt=d(65489);const ke=(0,A.css)({minWidth:"160px"}),Ue=a=>a,_t=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const n=Zt()(a,1e3,{leading:!0});return s.createElement("div",{className:ke},s.createElement(N.qb,{formatCreateLabel:Ue,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:e,loadOptions:n,onChange:t,createOptionPosition:"first"}))},ea=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const[n,i]=(0,qt.Z)(a,[a]);return(0,s.useEffect)(()=>{i("")},[i,a]),s.createElement("div",{className:ke},s.createElement(N.Ph,{isLoading:n.loading,formatCreateLabel:Ue,autoFocus:!0,isOpen:!n.loading,onCloseMenu:r,allowCustomValue:e,options:n.value??[],onChange:t,createOptionPosition:"first"}))},ta=({loadOptions:a,filterByLoadOptions:e,allowCustomValue:t,onChange:r,onClose:n})=>e?s.createElement(_t,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:n}):s.createElement(ea,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:n}),aa=({initialValue:a,onChange:e,onClose:t})=>{const[r,n]=ue(a);return s.createElement($.I,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:t,onKeyDown:i=>{i.key==="Enter"&&e(r)},onChange:i=>{n(i.currentTarget.value)},value:r})},ra=(0,A.css)({width:"auto",cursor:"pointer"}),j=({value:a,buttonClassName:e,loadOptions:t,filterByLoadOptions:r,allowCustomValue:n,onChange:i})=>{const[o,l]=(0,s.useState)(!1);if(o)return t!==void 0?s.createElement(ta,{loadOptions:t,filterByLoadOptions:r??!1,allowCustomValue:n,onChange:u=>{l(!1),i(u)},onClose:()=>{l(!1)}}):s.createElement(aa,{initialValue:a,onClose:()=>{l(!1)},onChange:u=>{l(!1),i({value:u,label:u})}});{const u=(0,A.cx)(ra,e);return s.createElement(X.W,{as:"button",className:u,onClick:()=>{l(!0)}},a)}},na=({policy:a,measurement:e,onChange:t,getPolicyOptions:r,getMeasurementOptions:n})=>{const i=async()=>{const l=await r();return(l.some(c=>c===F)?l:[F,...l]).map(B)},o=async l=>(await n(l)).map(B);return s.createElement(s.Fragment,null,s.createElement(j,{allowCustomValue:!0,value:a??"using default policy",loadOptions:i,onChange:l=>{t(l.value,e)}}),s.createElement(j,{allowCustomValue:!0,value:e??"select measurement",loadOptions:o,filterByLoadOptions:!0,onChange:l=>{t(a,l.value)}}),e&&s.createElement(Te._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t(a,void 0)}}))},ce=({value:a,onChange:e,isWide:t,placeholder:r})=>{const[n,i]=ue(a),o=()=>{e(n===""?void 0:n)};return s.createElement(s.Fragment,null,s.createElement($.I,{placeholder:r,className:(0,A.cx)(t??!1?"width-14":"width-8",Se),type:"text",spellCheck:!1,onBlur:o,onChange:l=>{i(l.currentTarget.value)},value:n??""}))},sa=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],ia=(0,A.cx)("width-9",Se),oa=({value:a,onChange:e,inputId:t})=>s.createElement(s.Fragment,null,s.createElement(N.Ph,{inputId:t,className:ia,onChange:r=>{e(ae(r.value))},value:a,options:sa}));var la=d(43078),ua=d(85001),ca=d(43867);const Ge=({loadOptions:a,allowCustomValue:e,onAdd:t})=>s.createElement(j,{value:"+",loadOptions:a,allowCustomValue:e,onChange:r=>{t(ae(r.value))}}),ma=a=>s.createElement(la.k,{label:""},s.createElement(ua.s,{label:"remove",onClick:a})),da=(0,A.css)({paddingRight:"0",marginRight:"0"}),fa=({name:a,onRemove:e})=>s.createElement(ca.z,{renderMenuItems:()=>ma(e)},({openMenu:t})=>s.createElement("button",{className:(0,A.cx)("gf-form-label",da),onClick:t},a)),ga=(0,A.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),pa=a=>(0,A.cx)("gf-form-label",(0,A.css)({paddingLeft:"0",lineHeight:a.typography.body.lineHeight,fontSize:a.typography.body.fontSize})),ha=({name:a,params:e,onChange:t,onRemove:r})=>{const n=(0,oe.l4)(),i=(0,s.useMemo)(()=>pa(n),[n]),o=(l,u)=>{const c=e.map(g=>g.value);c[u]=l,t(c)};return s.createElement("div",{className:i},s.createElement(fa,{name:a,onRemove:r}),"(",e.map((l,u)=>{const{value:c,options:g}=l,f=u===e.length-1,v=g!==null?()=>g().then(E=>E.map(B)):void 0;return s.createElement(s.Fragment,{key:u},s.createElement(j,{allowCustomValue:!0,value:c,buttonClassName:ga,loadOptions:v,onChange:E=>{o(ae(E.value),u)}}),!f&&",")}),")")},Ve=({parts:a,getNewPartOptions:e,onAddNewPart:t,onRemovePart:r,onChange:n})=>s.createElement(s.Fragment,null,a.map((i,o)=>s.createElement(s.Fragment,{key:o},s.createElement(ha,{name:i.name,params:i.params,onRemove:()=>{r(o)},onChange:l=>{n(o,l)}}),s.createElement(Te._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{r(o)}}))),s.createElement(Ge,{loadOptions:e,onAdd:t}));function We(a){return/^\/.*\/$/.test(a)}function $e(a){return a.operator??(We(a.value)?"=~":"=")}function He(a,e){return e?void 0:a.condition??"AND"}function Ea(a,e){const t=a==="=~"||a==="!~";return We(e)?t?a:"=~":t?"=":a}const ya=["=","!=","<>","<",">","=~","!~"],va=["AND","OR"],Sa=ya.map(B),Ta=va.map(B),Ia=()=>Promise.resolve(Ta),Ca=()=>Promise.resolve(Sa),Na=({tag:a,isFirst:e,onRemove:t,onChange:r,getTagKeyOptions:n,getTagValueOptions:i})=>{const o=$e(a),l=He(a,e),u=()=>n().catch(g=>(console.error(g),[])).then(g=>g.map(B)),c=()=>i(a.key).then(g=>g.map(B));return s.createElement("div",{className:"gf-form"},l!=null&&s.createElement(j,{value:l,loadOptions:Ia,onChange:g=>{r({...a,condition:g.value})}}),s.createElement(j,{allowCustomValue:!0,value:a.key,loadOptions:u,onChange:g=>{const{value:f}=g;f===void 0?t():r({...a,key:f??""})}}),s.createElement(j,{value:o,loadOptions:Ca,onChange:g=>{r({...a,operator:g.value})}}),s.createElement(j,{allowCustomValue:!0,value:a.value,loadOptions:c,onChange:g=>{const f=g.value??"";r({...a,value:f,operator:Ea(o,f)})}}),s.createElement(Te._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t()}}))},Ra=({tags:a,onChange:e,getTagKeyOptions:t,getTagValueOptions:r})=>{const n=(u,c)=>{const g=a.map((f,v)=>c===v?u:f);e(g)},i=u=>{const c=a.filter((g,f)=>f!==u);e(c)},o=()=>t().then(u=>u.map(B)),l=(u,c)=>{const g={key:u,value:"select tag value"},f={key:g.key,value:g.value,operator:$e(g),condition:He(g,c)};e([...a,f])};return s.createElement(s.Fragment,null,a.map((u,c)=>s.createElement(Na,{tag:u,isFirst:c===0,key:c,onChange:g=>{n(g,c)},onRemove:()=>{i(c)},getTagKeyOptions:t,getTagValueOptions:r})),s.createElement(Ge,{allowCustomValue:!0,loadOptions:o,onAdd:u=>{l(u,a.length===0)}}))},ba=a=>{const e=(0,s.useId)(),t=`influxdb-qe-format-as-${e}`,r=`influxdb-qe-order-by${e}`,n=(0,oe.wW)(Aa),i=dt(a.query),{datasource:o}=a,{measurement:l,policy:u}=i,c=(0,s.useMemo)(async()=>{const S=(await Vt(o,l,u)).map(P=>`${P}::tag`),x=(await Me(o,l||"",u)).map(P=>`${P}::field`);return new Set([...S,...x])},[l,u,o]),g=(0,s.useMemo)(()=>{const S=new Map([["field_0",()=>l!==void 0?Me(o,l,u):Promise.resolve([])]]);return(i.select??[]).map(x=>Be(x,S))},[l,u,i.select,o]),f=(0,s.useMemo)(()=>async()=>[...await c],[c]),v=(0,s.useMemo)(()=>{const S=new Map([["tag_0",f]]);return Be(i.groupBy??[],S)},[f,i.groupBy]),E=S=>{a.onChange(S),a.onRunQuery()},Q=(S,x)=>{E({...i,policy:S,measurement:x})},ne=S=>{E({...i,tags:S.length===0?void 0:S})};return s.createElement("div",null,s.createElement(q.f,{label:"FROM",fill:!0},s.createElement(na,{policy:u,measurement:l,getPolicyOptions:()=>ve(Ut(o),zt),getMeasurementOptions:S=>ve(c.then(x=>Gt(o,Fe(i.tags??[],x),S===""?void 0:S)),Qe,S),onChange:Q}),s.createElement(X.W,{width:"auto",className:n.inlineLabel},"WHERE"),s.createElement(Ra,{tags:i.tags??[],onChange:ne,getTagKeyOptions:f,getTagValueOptions:S=>ve(c.then(x=>Wt(o,Fe(i.tags??[],x),S)),Qe)})),g.map((S,x)=>s.createElement(q.f,{key:x,label:x===0?"SELECT":"",fill:!0},s.createElement(Ve,{parts:S,getNewPartOptions:()=>Promise.resolve($t()),onChange:(P,er)=>{const tr=pt(i,x,P,er);E(tr)},onAddNewPart:P=>{E(ft(i,P,x))},onRemovePart:P=>{E(gt(i,P,x))}}))),s.createElement(q.f,{label:"GROUP BY",fill:!0},s.createElement(Ve,{parts:v,getNewPartOptions:()=>Ht(i,f),onChange:(S,x)=>{const P=yt(i,S,x);E(P)},onAddNewPart:S=>{E(ht(i,S))},onRemovePart:S=>{E(Et(i,S))}})),s.createElement(q.f,{label:"TIMEZONE",fill:!0},s.createElement(ce,{placeholder:"(optional)",value:i.tz,onChange:S=>{E({...i,tz:S})}}),s.createElement(X.W,{htmlFor:r,width:"auto",className:n.inlineLabel},"ORDER BY TIME"),s.createElement(oa,{inputId:r,value:i.orderByTime==="DESC"?"DESC":"ASC",onChange:S=>{E({...i,orderByTime:S})}})),s.createElement(q.f,{label:"LIMIT",fill:!0},s.createElement(ce,{placeholder:"(optional)",value:i.limit?.toString(),onChange:S=>{E({...i,limit:S})}}),s.createElement(X.W,{width:"auto",className:n.inlineLabel},"SLIMIT"),s.createElement(ce,{placeholder:"(optional)",value:i.slimit?.toString(),onChange:S=>{E({...i,slimit:S})}})),s.createElement(q.f,{htmlFor:t,label:"FORMAT AS",fill:!0},s.createElement(Xt,{inputId:t,format:i.resultFormat??Pe,onChange:S=>{E({...i,resultFormat:S})}}),i.resultFormat!=="table"&&s.createElement(s.Fragment,null,s.createElement(X.W,{width:"auto",className:n.inlineLabel},"ALIAS"),s.createElement(ce,{isWide:!0,placeholder:"Naming pattern",value:i.alias,onChange:S=>{E({...i,alias:S})}}))))};function Aa(a){return{inlineLabel:(0,A.css)`
      color: ${a.colors.primary.text};
    `}}const Oa=({query:a,onChange:e,onRunQuery:t,datasource:r})=>{switch(r.version){case y.Flux:return s.createElement("div",{className:"gf-form-query-content"},s.createElement(he,{query:a,onChange:e,onRunQuery:t,datasource:r}));case y.SQL:return s.createElement(wt,{datasource:r,query:a,onChange:e,onRunQuery:t});case y.InfluxQL:default:return s.createElement("div",{className:(0,A.css)({display:"flex"})},s.createElement("div",{className:(0,A.css)({flexGrow:1})},a.rawQuery?s.createElement(Qt,{query:a,onChange:e,onRunQuery:t}):s.createElement(ba,{query:a,onChange:e,onRunQuery:t,datasource:r})),s.createElement(Mt,{isRaw:a.rawQuery??!1,onChange:n=>{e({...a,query:xe(a),rawQuery:n}),t()}}))}},xa=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],Da=()=>s.createElement("div",null,s.createElement("h2",null,"InfluxDB Cheat Sheet"),xa.map(a=>s.createElement("div",{className:"cheat-sheet-item",key:a.title},s.createElement("div",{className:"cheat-sheet-item__title"},a.title),s.createElement("div",{className:"cheat-sheet-item__label"},a.label))));function La(){return s.createElement(Da,null)}class wa extends s.PureComponent{constructor(){super(...arguments),this.onRefresh=()=>{}}render(){let{query:e,datasource:t,onChange:r}=this.props;switch(t.version){case y.Flux:return s.createElement(he,{datasource:t,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:n=>r(n.query)});case y.SQL:return s.createElement("div",{className:"gf-form-inline"},"TODO");case y.InfluxQL:default:return s.createElement("div",{className:"gf-form-inline"},s.createElement(h.c,{width:10},"Query"),s.createElement("div",{className:"gf-form-inline gf-form--grow"},s.createElement(Le.K,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:n=>r(n.currentTarget.value)})))}}}var Ke=d(8894),Pa=d(36497),Ma=d(3195),re=d(31312),Ie=d(63302),me=d(71476),Fa=d(10752),Ba=d(53305),Qa=d(77877),K=d(89591),ka=d(92743),Ce=d(4649),Ye=d(4148),Ua=d(41182);const Ga=a=>{const{query:e,onChange:t}=a,[r,n]=(0,s.useState)(e.query??""),[i,o]=(0,s.useState)(e.textColumn??""),[l,u]=(0,s.useState)(e.tagsColumn??""),[c,g]=(0,s.useState)(e?.timeEndColumn??""),[f]=(0,s.useState)(e?.titleColumn??""),v=(E,Q)=>{t({...e,[E]:Q,rawQuery:!0,fromAnnotations:!0,textEditor:!0})};return s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{width:12},"InfluxQL Query"),s.createElement($.I,{value:r,onChange:E=>n(E.currentTarget.value??""),onBlur:()=>v("query",r),placeholder:"select text from events where $timeFilter limit 1000"})),s.createElement(h.c,{width:12,tooltip:s.createElement("div",null,"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage.")},"Field mappings"),s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(h.c,{width:12},"Text"),s.createElement($.I,{value:i,onChange:E=>o(E.currentTarget.value??""),onBlur:()=>v("textColumn",i)})),s.createElement("div",{className:"gf-form"},s.createElement(h.c,{width:12},"Tags"),s.createElement($.I,{value:l,onChange:E=>u(E.currentTarget.value??""),onBlur:()=>v("tagsColumn",l)})),s.createElement("div",{className:"gf-form"},s.createElement(h.c,{width:12},"TimeEnd"),s.createElement($.I,{value:c,onChange:E=>g(E.currentTarget.value??""),onBlur:()=>v("timeEndColumn",c)})),s.createElement("div",{className:"gf-form ng-hide"},s.createElement(h.c,{width:12},"Title"),s.createElement($.I,{defaultValue:f})))))};var ze=d(86654);function Va({sql:a,dataset:e,table:t}){let r="";if(!a||!(0,ze.IC)(a.columns))return r;if(r+=(0,ze.zE)(a.columns),e&&t&&(r+=`FROM ${e}.${t} `),a.whereString&&(r+=`WHERE ${a.whereString} `),a.groupBy?.[0]?.property.name){const n=a.groupBy.map(i=>i.property.name).filter(i=>!(0,m.isEmpty)(i));r+=`GROUP BY ${n.join(", ")} `}return a.orderBy?.property.name&&(r+=`ORDER BY ${a.orderBy.property.name} `),a.orderBy?.property.name&&a.orderByDirection&&(r+=`${a.orderByDirection} `),Wa(a.limit)&&(r+=`LIMIT ${a.limit}`),r}const Wa=a=>a!==void 0&&a>=0;var je=d(94162);class Xe{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,r;return this.series.length===0||(0,m.each)(this.series,n=>{const i=n.columns.length,o=(0,m.map)(n.tags,(l,u)=>u+": "+l);for(r=1;r<i;r++){let l=n.name;const u=n.columns[r];u!=="value"&&(l=l+"."+u),this.alias?l=this._getSeriesName(n,r):n.tags&&(l=l+" {"+o.join(", ")+"}");const c=[];if(n.values)for(t=0;t<n.values.length;t++)c[t]=[n.values[t][r],n.values[t][0]];e.push({title:l,target:l,datapoints:c,tags:n.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,t){const r=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,n=e.name.split(".");return this.alias.replace(r,(i,o,l)=>{const u=o||l,c=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[t];if(!isNaN(c))return n[c]??i;if(u.indexOf("tag_")!==0)return i;const g=u.replace("tag_","");return e.tags?e.tags[g]:i})}getAnnotations(){const e=[];return(0,m.each)(this.series,t=>{let r=null,n=null,i=null;const o=[];let l=null;(0,m.each)(t.columns,(u,c)=>{if(u==="time"){n=c;return}if(u!=="sequence_number"){if(u===this.annotation.titleColumn){r=c;return}if((0,m.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),u)){o.push(c);return}if(u===this.annotation.textColumn){l=c;return}if(u===this.annotation.timeEndColumn){i=c;return}!r&&l!==c&&(r=c)}}),(0,m.each)(t.values,u=>{const c={annotation:this.annotation,time:+new Date(u[n]),title:u[r],timeEnd:u[i],tags:(0,m.flatten)(o.filter(g=>u[g]).map(g=>u[g].split(","))),text:u[l]};e.push(c)})}),e}getTable(){const e=new je.Z;let t,r;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,m.each)(this.series,(n,i)=>{if(i===0){const o=n.columns[0],l=o==="time"?{text:"Time",type:K.fS.time}:{text:o};for(e.columns.push(l),(0,m.each)((0,m.keys)(n.tags),u=>{e.columns.push({text:u})}),r=1;r<n.columns.length;r++)e.columns.push({text:n.columns[r]})}if(n.values)for(t=0;t<n.values.length;t++){const o=n.values[t],l=[o[0]];if(n.tags)for(const u in n.tags)n.tags.hasOwnProperty(u)&&l.push(n.tags[u]);for(r=1;r<o.length;r++)l.push(o[r]);e.rows.push(l)}}),e}}const $a=a=>{const e={refId:"",query:a.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:a.tagsColumn??"",textColumn:a.textColumn??"",timeEndColumn:a.timeEndColumn??"",titleColumn:a.titleColumn??"",name:a.name??""};return a.target&&a.target.limit&&(e.limit=a.target.limit),a.target&&a.target.matchAny&&(e.matchAny=a.target.matchAny),a.target&&a.target.tags&&(e.tags=a.target.tags),a.target&&a.target.type&&(e.type=a.target.type),e},Ha=a=>(a.target=a.target&&!a.target?.query?$a(a):a.target,a);class Ka{parse(e,t){if(!t?.results||t.results.length===0)return[];const r=t.results[0];if(!r.series)return[];const n=e.toLowerCase(),i=n.indexOf("show retention policies")>=0,o=n.indexOf("show field keys")>=0||i,l=new Set;return(0,m.each)(r.series,u=>{(0,m.each)(u.values,c=>{(0,m.isArray)(c)?o?l.add(c[0].toString()):c[1]!==void 0?l.add(c[1].toString()):l.add(c[0].toString()):l.add(c.toString())})}),Array.from(l).map(u=>({text:u}))}getTable(e,t,r){let n=new je.Z;if(e.length>0)if(n.meta={...r,executedQueryString:e[0].meta?.executedQueryString},n.refId=t.refId,n=za(e,n,t),e[0].fields[1]&&e[0].fields[1].labels){let i=(0,m.groupBy)(e,u=>u.fields[1].labels?Object.values(u.fields[1].labels):null);const o=Object.keys(i),l=Object.values(i);for(let u=0;u<l.length;u++)n=Je(l[u],n,[...o[u].split(",")])}else n=Je(e,n,[]);return n}async transformAnnotationResponse(e,t,r){const n=(0,Ce.z1)(t,[r]);if(!n)return[];const i=this.getTable(n.data,r,{}),o=[];let l=0,u=0,c=0,g=0;const f=[];return(0,m.each)(i.columns,(v,E)=>{if(v.text.toLowerCase()==="time"){u=E;return}if(v.text===e.titleColumn){l=E;return}if(Ya(v.text,e.tagsColumn)){f.push(E);return}if(e.textColumn&&v.text.includes(e.textColumn)){g=E;return}if(v.text===e.timeEndColumn){c=E;return}!l&&g!==E&&(l=E)}),(0,m.each)(i.rows,v=>{const E={annotation:e,time:+new Date(v[u]),title:v[l],timeEnd:v[c],tags:(0,m.flatten)(f.filter(Q=>v[Q]).map(Q=>v[Q].split(","))),text:v[g]};o.push(E)}),o}}function Ya(a,e){const t=(e||"").replace(" ","").split(",");for(const r of t)if(r!==""&&a.includes(r))return!0;return!1}function za(a,e,t){const r=ja(t);a[0].fields.forEach(n=>{n.name.toLowerCase()==="time"?e.columns.push({text:"Time",type:K.fS.time}):n.name.toLowerCase()==="value"&&n.labels&&Object.keys(n.labels).forEach(i=>{e.columns.push({text:i})})}),a[0].refId==="metricFindQuery"&&a.forEach(n=>{n.name&&e.columns.push({text:n.name})});for(let n=0;n<r.length;n++)e.columns.push({text:r[n]});return t.rawQuery&&r.length===0&&Xa(t.query,a)&&a[0].refId!=="metricFindQuery"&&a.map(n=>{n.name&&e.columns.push({text:n.name})}),e}function Je(a,e,t){const r=a[0].fields[0].values;for(let n=0;n<r.length;n++){const i=r[n],o=a.map(l=>l.fields[1]?l.fields[1].values[n]:null);o.indexOf(null)<0&&e.rows.push([i,...t,...o])}return e}function ja(a){let e=[];a.select?.forEach(r=>{const n=r.filter(i=>i.type!=="field");if(n.length>0){const i=n.find(o=>o.type==="alias");i?e.push(i.params?.[0].toString()??""):e.push(n[0].type)}else r[0]&&r[0].params&&r[0].params[0]&&e.push(r[0].params[0].toString())});let t=[];return e.forEach(r=>{t.push(Ze(r,r,t,0))}),t}function Ze(a,e,t,r){return t.indexOf(e)>-1?(r++,Ze(a,a+"_"+r,t,r)):e}function Xa(a,e){const r=e.map(o=>o.name).every(o=>o&&a?o.split(".").every(u=>a.toLowerCase().includes(u.toLowerCase())):!1),i=["*","SHOW"].some(o=>a?a.toLowerCase().includes(o.toLowerCase()):!1);return r||i}class Ja extends ka.CK{constructor(e,t=(0,Ua.J)()){super(e),this.templateSrv=t,this.type="influxdb",this.urls=(e.url??"").split(",").map(n=>n.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const r=e.jsonData??{};this.database=r.dbName??e.database,this.interval=r.timeInterval,this.httpMode=r.httpMode||"GET",this.responseParser=new Ka,this.version=r.version??y.InfluxQL,this.isProxyAccess=e.access==="proxy",this.version===y.Flux?this.annotations={QueryEditor:he}:this.annotations={QueryEditor:Ga,prepareAnnotation:Ha}}query(e){if(!this.isProxyAccess){const t=new Error(H);return(0,Ke._)(()=>t)}return this._query(e)}_query(e){const t={...e,targets:e.targets.filter(r=>r.hide!==!0)};if(t.targets.some(r=>r.fromAnnotations)){const r=[];for(const n of t.targets)n.query&&r.push(new Pa.y(i=>{this.annotationEvents(t,n).then(o=>i.next({data:[(0,Ba.g0)(o)]})).catch(o=>i.error(new Error(o))).finally(()=>i.complete())}));return(0,Ma.T)(...r)}return this.version===y.Flux||this.version===y.SQL?super.query(t):this.isMigrationToggleOnAndIsAccessProxy()?super.query(t).pipe((0,me.U)(r=>{if(r.error)throw{message:"InfluxDB Error: "+r.error.message,res:r};const n=(0,m.groupBy)(r.data,o=>o.refId);if(Object.keys(n).length===0)return{data:[]};const i=[];return t.targets.forEach(o=>{const l=n[o.refId]??[];switch(o.resultFormat){case"logs":case"table":i.push(this.responseParser.getTable(l,o,{preferredVisualisationType:o.resultFormat}));break;default:{for(let u=0;u<l.length;u++)i.push(l[u]);break}}}),{data:i}})):this.classicQuery(e)}getQueryDisplayText(e){switch(this.version){case y.Flux:return e.query;case y.SQL:return Va(e);case y.InfluxQL:return new V(e).render(!1);default:return""}}filterQuery(e){return this.version===y.Flux?!!e.query:!0}applyTemplateVariables(e,t){const{__interval:r,__interval_ms:n,...i}=t||{};if(this.version===y.Flux)return{...e,query:this.templateSrv.replace(e.query??"",i)};if(this.isMigrationToggleOnAndIsAccessProxy()&&(e=this.applyVariables(e,i),e.adhocFilters?.length)){const o=(e.adhocFilters??[]).map(l=>{const{condition:u,...c}=l;return c});e.tags=[...e.tags??[],...o]}return e}targetContainsTemplate(e){const t=this.version===y.Flux?e.query:xe(e);return this.templateSrv.containsTemplate(t)}interpolateVariablesInQueries(e,t){return!e||e.length===0?[]:e.map(r=>this.version===y.Flux?{...r,datasource:this.getRef(),query:this.templateSrv.replace(r.query??"",t,"regex")}:{...r,datasource:this.getRef(),...this.applyVariables(r,t)})}applyVariables(e,t){const r={...e};return e.groupBy&&(r.groupBy=e.groupBy.map(n=>({...n,params:n.params?.map(i=>this.templateSrv.replace(i.toString(),void 0,"regex"))}))),e.select&&(r.select=e.select.map(n=>n.map(i=>({...i,params:i.params?.map(o=>this.templateSrv.replace(o.toString(),void 0,"regex"))})))),e.tags&&(r.tags=e.tags.map(n=>({...n,value:this.templateSrv.replace(n.value,t,"regex")}))),{...r,adhocFilters:this.templateSrv.getAdhocFilters(this.name)??[],query:this.templateSrv.replace(e.query??"",t,"regex"),alias:this.templateSrv.replace(e.alias??"",t),limit:this.templateSrv.replace(e.limit?.toString()??"",t,"regex"),measurement:this.templateSrv.replace(e.measurement??"",t,"regex"),policy:this.templateSrv.replace(e.policy??"",t,"regex"),slimit:this.templateSrv.replace(e.slimit?.toString()??"",t,"regex"),tz:this.templateSrv.replace(e.tz??"",t)}}async runMetadataQuery(e){return(0,re.n)(super.query({targets:[e]})).then(t=>t.data?.length?(0,Ce.S9)(t.data[0]):[])}async metricFindQuery(e,t){if(this.version===y.Flux||this.isMigrationToggleOnAndIsAccessProxy()){const n={refId:"metricFindQuery",query:e,rawQuery:!0};return(0,re.n)(super.query({...t,targets:[n]})).then(i=>i.data?.length?(0,Ce.S9)(i.data[0]):[])}const r=new V({refId:"metricFindQuery",query:e,rawQuery:!0},this.templateSrv,t?.scopedVars).render(!0);return(0,re.n)(this._seriesQuery(r,t)).then(n=>this.responseParser.parse(e,n))}getTagKeys(e){const t=ye({type:"TAG_KEYS",templateService:this.templateSrv,database:this.database});return this.metricFindQuery(t)}getTagValues(e){const t=ye({type:"TAG_VALUES",templateService:this.templateSrv,database:this.database,withKey:e.key});return this.metricFindQuery(t)}_seriesQuery(e,t){if(!e)return(0,Ie.of)({results:[]});if(t&&t.range){const r=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",r)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,m.reduce)(e,(t,r,n)=>(r==null||t.push(encodeURIComponent(n)+"="+encodeURIComponent(r)),t),[]).join("&"):""}_influxRequest(e,t,r,n){const i=this.urls.shift();this.urls.push(i);const o={};this.username&&(o.u=this.username,o.p=this.password),n&&n.database?o.db=n.database:this.database&&(o.db=this.database),n?.policy&&n.policy!==F&&(o.rp=n.policy);const{q:l}=r;e==="POST"&&(0,m.has)(r,"q")?((0,m.extend)(o,(0,m.omit)(r,["q"])),r=this.serializeParams((0,m.pick)(r,["q"]))):(e==="GET"||e==="POST")&&((0,m.extend)(o,r),r=null);const u={method:e,url:i+t,params:o,data:r,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,Ye.i)().fetch(u).pipe((0,me.U)(c=>{const{data:g}=c;if(g&&(g.executedQueryString=l,g.results)){const f=c.data.results.filter(v=>v.error);if(f.length>0)throw{message:"InfluxDB Error: "+f[0].error,data:g}}return g}),(0,Fa.K)(c=>c.cancelled?(0,Ie.of)(c):(0,Ke._)(this.handleErrors(c))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){const t=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),r=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+t+" and time <= "+r}getInfluxTime(e,t,r){let n;if((0,m.isString)(e)){if(e==="now")return"now()";const i=/^now-(\d+)([dhms])$/.exec(e);if(i){const o=parseInt(i[1],10),l=i[2];return"now() - "+o+l}if(n=Qa.parse(e,t,r),!n)throw new Error("unable to parse date");e=n}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return p.default.featureToggles.influxdbBackendMigration&&this.access==="proxy"}classicQuery(e){let t=this.getTimeFilter(e);const r=e.scopedVars,n=(0,m.cloneDeep)(e.targets),i=[];let o,l,u=(0,m.map)(n,f=>f.hide?"":(i.push(f),r.interval=r.__interval,new V(f,this.templateSrv,r).render(!0))).reduce((f,v)=>(v!==""&&(f+=";"+v),f));if(u==="")return(0,Ie.of)({data:[]});const c=this.templateSrv.getAdhocFilters(this.name),g=e.targets.flatMap(f=>f.adhocFilters??[]);if(c?.length||g?.length){const f=c?.length?c:g,v=new V({refId:"A"},this.templateSrv,r);t+=" AND "+v.renderAdhocFilters(f)}return r.timeFilter={value:t},u=this.templateSrv.replace(u,r),this._seriesQuery(u,e).pipe((0,me.U)(f=>{if(!f||!f.results)return{data:[]};const v=[];for(o=0;o<f.results.length;o++){const E=f.results[o];if(!E||!E.series)continue;const Q=i[o];let ne=Q.alias;ne&&(ne=this.templateSrv.replace(Q.alias,e.scopedVars));const S={executedQueryString:f.executedQueryString},x=new Xe({refId:Q.refId,series:f.results[o].series,alias:ne,meta:S});switch(Q.resultFormat){case"logs":S.preferredVisualisationType="logs";case"table":{v.push(x.getTable());break}default:{const P=x.getTimeSeries();for(l=0;l<P.length;l++)v.push(qa(P[l]));break}}}return{data:v}}))}async annotationEvents(e,t){if(this.version===y.Flux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!t.query)return Promise.reject({message:"Query missing in annotation definition"});if(this.isMigrationToggleOnAndIsAccessProxy()){const i={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(t.query,void 0,"regex"),rawQuery:!0};return(0,re.n)((0,Ye.i)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[i]},requestId:t.name}).pipe((0,me.U)(async o=>await this.responseParser.transformAnnotationResponse(t,o,i))))}const r=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let n=t.query.replace("$timeFilter",r);return n=this.templateSrv.replace(n,void 0,"regex"),(0,re.n)(this._seriesQuery(n,e)).then(i=>{if(!i||!i.results||!i.results[0])throw{message:"No results in response from InfluxDB"};return new Xe({series:i.results[0].series,annotation:t}).getAnnotations()})}}function Za(a){const e=a.find(r=>r!==null);if(e===void 0)return K.fS.number;const t=typeof e;switch(t){case"string":return K.fS.string;case"boolean":return K.fS.boolean;case"number":return K.fS.number;default:throw new Error(`InfluxQL: invalid value type ${t}`)}}function qa(a){const e=[],t=[],r=a.datapoints;for(const l of r)t.push(l[0]),e.push(l[1]);const n={name:K.Ls,type:K.fS.time,config:{},values:e},i={name:K.M5,type:Za(t),config:{displayNameFromDS:a.title},values:t,labels:a.tags},o=[n,i];return{name:a.target,refId:a.refId,meta:a.meta,fields:o,length:t.length}}const _a=new k.hf(Ja).setConfigEditor(ot).setQueryEditor(Oa).setVariableQueryEditor(wa).setQueryEditorHelp(La)},67564:(se,W,d)=>{d.d(W,{J:()=>k});function k(s){const b=[];for(const M of s){let N="text";switch(M.type?.toUpperCase()){case"BOOLEAN":case"BOOL":{N="boolean";break}case"BYTES":case"VARCHAR":{N="text";break}case"FLOAT":case"FLOAT64":case"INT":case"INTEGER":case"INT64":case"NUMERIC":case"BIGNUMERIC":{N="number";break}case"DATE":{N="date";break}case"DATETIME":{N="datetime";break}case"TIME":{N="time";break}case"TIMESTAMP":{N="datetime";break}case"GEOGRAPHY":{N="text";break}default:break}b.push({...M,raqbFieldType:N,icon:m(M.type.toUpperCase())})}return b}function m(s){switch(s){case"TIME":case"DATETIME":case"TIMESTAMP":return"clock-nine";case"BOOLEAN":return"toggle-off";case"INTEGER":case"FLOAT":case"FLOAT64":case"INT":case"SMALLINT":case"BIGINT":case"TINYINT":case"BYTEINT":case"INT64":case"NUMERIC":case"DECIMAL":return"calculator-alt";case"CHAR":case"VARCHAR":case"STRING":case"BYTES":case"TEXT":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":return"text";case"GEOGRAPHY":return"map";default:return}}},16824:(se,W,d)=>{d.d(W,{W2:()=>b,qw:()=>m,tk:()=>s});var k=d(63565);function m(D){return`SELECT table_name FROM information_schema.tables WHERE table_schema = ${D!==void 0?N(D):"database()"} ORDER BY table_name`}function s(){return"SELECT DISTINCT TABLE_SCHEMA from information_schema.TABLES where TABLE_TYPE != 'SYSTEM VIEW' ORDER BY TABLE_SCHEMA"}function b(D,U){let O="SELECT column_name, data_type FROM information_schema.columns WHERE ";return O+=M(D,U),O+=" ORDER BY column_name",O}function M(D,U){let O="";if(D.includes(".")){const p=D.split(".");return O="table_schema = "+N(p[0]),O+=" AND table_name = "+N(p[1]),O}else return O=`table_schema = ${U!==void 0?N(U):"database()"} AND table_name = `+N(D),O}function N(D){return(0,k.MM)((0,k.b)(D))}},75392:(se,W,d)=>{d.d(W,{Iu:()=>s});var k=d(69415),m=d(78597);const s=({getMeta:h})=>(R,L)=>({...L&&(0,k.h)(R,L),customStatementPlacement:D,customSuggestionKinds:U(h)}),b={afterDatabase:"afterDatabase"},M={tablesWithinDatabase:"tablesWithinDatabase"},N="FROM",D=()=>[{id:b.afterDatabase,resolve:(h,R,L)=>!!(h?.is(m.iv.Delimiter,".")&&R?.value===N&&(L?.is(m.iv.IdentifierQuote)||L?.isIdentifier())&&h?.getPreviousUntil(m.iv.Keyword,[m.iv.IdentifierQuote],N)?.filter(Y=>Y.isIdentifier()).length===1)}],U=h=>()=>[{id:m.is.Tables,overrideDefault:!0,suggestionsResolver:async R=>{const L=p(R.currentToken);return(await h({schema:L})).map(O(R))}},{id:m.is.Columns,overrideDefault:!0,suggestionsResolver:async R=>{const L=y(R.currentToken),Y=p(L),J=H(L);return!Y||!J?[]:(await h({schema:Y,table:J})).map(O(R))}},{id:M.tablesWithinDatabase,applyTo:[b.afterDatabase],suggestionsResolver:async R=>{const L=p(R.currentToken);return(await h({schema:L})).map(O(R))}}];function O(h){return function(R){return{label:R.name,insertText:R.completion??R.name,command:{id:"editor.action.triggerSuggest",title:""},kind:m.cm.Field,sortText:m.G8.High,range:{...h.range,startColumn:h.range.endColumn,endColumn:h.range.endColumn}}}}function p(h){if(h?.isIdentifier()&&h.value[h.value.length-1]!==".")return h.value;if(h?.is(m.iv.Delimiter,"."))return h.getPreviousOfType(m.iv.Identifier)?.value;if(h?.is(m.iv.IdentifierQuote))return h.getPreviousOfType(m.iv.Identifier)?.value||h.getNextOfType(m.iv.Identifier)?.value}function H(h){return h?.getNextOfType(m.iv.Identifier)?.value}const F=h=>(h?.getPreviousOfType(m.iv.Keyword,"SELECT")??null)?.getNextOfType(m.iv.Keyword,N),y=h=>{const L=F(h)?.getNextOfType(m.iv.Identifier);return L?.isKeyword()&&L.next?.is(m.iv.Parenthesis,"(")?null:L}},63565:(se,W,d)=>{d.d(W,{Et:()=>b,MM:()=>U,b:()=>D,vy:()=>M});var k=d(86832),m=d.n(k),s=d(86654);function b({sql:p,dataset:H,table:F}){let y="";if(!p||!(0,s.IC)(p.columns))return y;if(y+=(0,s.zE)(p.columns),H&&F&&(y+=`FROM ${H}.${F} `),p.whereString&&(y+=`WHERE ${p.whereString} `),p.groupBy?.[0]?.property.name){const h=p.groupBy.map(R=>R.property.name).filter(R=>!(0,k.isEmpty)(R));y+=`GROUP BY ${h.join(", ")} `}return p.orderBy?.property.name&&(y+=`ORDER BY ${p.orderBy.property.name} `),p.orderBy?.property.name&&p.orderByDirection&&(y+=`${p.orderByDirection} `),p.limit!==void 0&&p.limit>=0&&(y+=`LIMIT ${p.limit} `),y}function M(p){return N(p)?p:`\`${p}\``}function N(p){const H=/^[a-zA-Z_][a-zA-Z0-9_$]*$/g.test(p);return!O.includes(p.toUpperCase())&&H}function D(p){return p[0]==='"'&&p[p.length-1]==='"'?p.substring(1,p.length-1).replace(/""/g,'"'):p[0]==="`"&&p[p.length-1]==="`"?p.substring(1,p.length-1):p}function U(p){return"'"+p.replace(/'/g,"''")+"'"}const O=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CUBE","CUME_DIST","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DENSE_RANK","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","EMPTY","ENCLOSED","ESCAPED","EXCEPT","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FIRST_VALUE","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","FUNCTION","GENERATED","GET","GRANT","GROUP","GROUPING","GROUPS","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERVAL","INTO","IO_AFTER_GTIDS","IO_BEFORE_GTIDS","IS","ITERATE","JOIN","JSON_TABLE","KEY","KEYS","KILL","LAG","LAST_VALUE","LATERAL","LEAD","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_BIND","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAXVALUE","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NTH_VALUE","NTILE","NULL","NUMERIC","OF","ON","OPTIMIZE","OPTIMIZER_COSTS","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","PARTITION","PERCENT_RANK","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","RANK","READ","READS","READ_WRITE","REAL","RECURSIVE","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESIGNAL","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","ROW","ROWS","ROW_NUMBER","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIGNAL","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STORED","STRAIGHT_JOIN","SYSTEM","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","VIRTUAL","WHEN","WHERE","WHILE","WINDOW","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"]}}]);

//# sourceMappingURL=7444.js.map