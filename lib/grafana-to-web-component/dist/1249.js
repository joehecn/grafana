"use strict";(this.webpackChunkGrafanaToWebComponent=this.webpackChunkGrafanaToWebComponent||[]).push([[1249],{54522:(se,W,l)=>{l.d(W,{a:()=>$});var v=l(39953),h=l(41407),A=l(69171),n=l(97250),V=l(38637),y=l(99242),L=Object.defineProperty,T=Object.defineProperties,F=Object.getOwnPropertyDescriptors,w=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,g=Object.prototype.propertyIsEnumerable,S=(x,p,M)=>p in x?L(x,p,{enumerable:!0,configurable:!0,writable:!0,value:M}):x[p]=M,N=(x,p)=>{for(var M in p||(p={}))b.call(p,M)&&S(x,M,p[M]);if(w)for(var M of w(p))g.call(p,M)&&S(x,M,p[M]);return x},E=(x,p)=>T(x,F(p));const $=({config:x,onChange:p,className:M})=>{const ne=G=>{p(E(N({},x),{jsonData:E(N({},x.jsonData),{keepCookies:G})}))},C=G=>{p(E(N({},x),{jsonData:E(N({},x.jsonData),{timeout:parseInt(G.currentTarget.value,10)})}))},ee={container:(0,h.css)({maxWidth:578})};return v.createElement(y._,{title:"Advanced HTTP settings",className:(0,h.cx)(ee.container,M)},v.createElement(A._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:x.readOnly,grow:!0},v.createElement(n.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:x.jsonData.keepCookies,onChange:ne})),v.createElement(A._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:x.readOnly,grow:!0},v.createElement(V.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:x.jsonData.timeout,onChange:C})))}},3793:(se,W,l)=>{l.d(W,{i:()=>n});var v=l(41407),h=l(39953),A=l(82803);const n=({hideLine:y=!1})=>{const L=(0,A.wW)(V);return y?h.createElement("hr",{className:L.dividerHideLine}):h.createElement("hr",{className:L.divider})},V=y=>({divider:(0,v.css)`
    margin: ${y.spacing(4,0)};
  `,dividerHideLine:(0,v.css)`
    border: none;
    margin: ${y.spacing(3,0)};
  `})},23846:(se,W,l)=>{l.d(W,{I:()=>b});var v=l(41407),h=l(39953),A=l(47635),n=l(99242),V=l(82803),y=l(74661),L=l(69171),T=l(26286),F=l(43997);function w({options:S,onOptionsChange:N}){const E=(0,V.wW)(g);return h.createElement("div",{className:E.container},h.createElement(y.Z,{className:E.row},h.createElement(L._,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26},h.createElement(T.x,{id:"enableNodeGraph",value:S.jsonData.nodeGraph?.enabled,onChange:$=>(0,A.tp)({onOptionsChange:N,options:S},"nodeGraph",{...S.jsonData.nodeGraph,enabled:$.currentTarget.checked})}))))}const b=({options:S,onOptionsChange:N})=>h.createElement(n._,{title:"Node graph",description:h.createElement(F.W,{description:"Show or hide the node graph visualization.",suffix:`${S.type}/#node-graph`,feature:"the node graph"})},h.createElement(w,{options:S,onOptionsChange:N})),g=S=>({infoText:(0,v.css)`
    label: infoText;
    padding-bottom: ${S.spacing(2)};
    color: ${S.colors.text.secondary};
  `,container:(0,v.css)`
    label: container;
    width: 100%;
  `,row:(0,v.css)`
    label: row;
    align-items: baseline;
  `})},49605:(se,W,l)=>{l.d(W,{Y:()=>$});var v=l(41407),h=l(39953),A=l(47635),n=l(27770),V=l(82803),y=l(74661),L=l(69171),T=l(4919),F=l(38637),w=l(11286),b=l(43997),g=l(13273),S=l(60317),N=l(36516);function E({options:p,onOptionsChange:M}){const ne=(0,V.wW)(x);return h.createElement("div",{className:(0,v.css)({width:"100%"})},h.createElement(y.Z,{className:ne.row},h.createElement(L._,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26},h.createElement(w.q,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:p.jsonData.tracesToMetrics?.datasourceUid,noDefault:!0,width:40,onChange:C=>(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,datasourceUid:C.uid})})),p.jsonData.tracesToMetrics?.datasourceUid?h.createElement(T.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,datasourceUid:void 0})}},"Clear"):null),h.createElement(y.Z,null,h.createElement(g.w,{label:(0,N.mH)("start"),tooltip:(0,N.rr)("start","-2m"),value:p.jsonData.tracesToMetrics?.spanStartTimeShift||"",onChange:C=>{(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,spanStartTimeShift:C})},placeholder:"-2m",isInvalidError:N.Ny})),h.createElement(y.Z,null,h.createElement(g.w,{label:(0,N.mH)("end"),tooltip:(0,N.rr)("end","2m"),value:p.jsonData.tracesToMetrics?.spanEndTimeShift||"",onChange:C=>{(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,spanEndTimeShift:C})},placeholder:"2m",isInvalidError:N.Ny})),h.createElement(y.Z,null,h.createElement(L._,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26},h.createElement(S.a,{values:p.jsonData.tracesToMetrics?.tags??[],onChange:C=>(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,tags:C})}))),p.jsonData.tracesToMetrics?.queries?.map((C,ee)=>h.createElement("div",{key:ee,className:ne.queryRow},h.createElement(L._,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query"},h.createElement(F.I,{label:"Link Label",type:"text",allowFullScreen:!0,value:C.name,width:40,onChange:G=>{let ie=p.jsonData.tracesToMetrics?.queries.slice()??[];ie[ee].name=G.currentTarget.value,(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,queries:ie})}})),h.createElement(L._,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0},h.createElement(F.I,{label:"Query",type:"text",allowFullScreen:!0,value:C.query,onChange:G=>{let ie=p.jsonData.tracesToMetrics?.queries.slice()??[];ie[ee].query=G.currentTarget.value,(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,queries:ie})}})),h.createElement(T.zx,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{let G=p.jsonData.tracesToMetrics?.queries.slice();G?.splice(ee,1),(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,queries:G})}}))),h.createElement(T.zx,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{(0,A.tp)({onOptionsChange:M,options:p},"tracesToMetrics",{...p.jsonData.tracesToMetrics,queries:[...p.jsonData.tracesToMetrics?.queries??[],{query:""}]})}},"Add query"))}const $=({options:p,onOptionsChange:M})=>h.createElement(n.K,{title:"Trace to metrics",description:h.createElement(b.W,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:`${p.type}/#trace-to-metrics`,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0},h.createElement(E,{options:p,onOptionsChange:M})),x=p=>({infoText:(0,v.css)`
    padding-bottom: ${p.spacing(2)};
    color: ${p.colors.text.secondary};
  `,row:(0,v.css)`
    label: row;
    align-items: baseline;
  `,queryRow:(0,v.css)`
    label: queryRow;
    display: flex;
    flex-flow: wrap;
  `})},88132:(se,W,l)=>{l.d(W,{n:()=>y});var v=l(39953),h=l(38793);const A=v.lazy(()=>Promise.all([l.e(1569),l.e(7142)]).then(l.bind(l,29681))),n=L=>v.createElement(v.Suspense,{fallback:null},v.createElement(A,{...L})),V=L=>{const T=(0,v.useRef)(null),{onRunQuery:F,onChange:w,...b}=L,g=N=>{T.current=N,w(N),F()},S=N=>{w(N)};return v.createElement(n,{onRunQuery:g,onBlur:S,onChange:w,...b})};class y extends v.PureComponent{constructor(T){super(T),this._isMounted=!1,this.onChangeQuery=(F,w)=>{const{query:b,onChange:g,onRunQuery:S}=this.props;if(g){const N={...b,expr:F};g(N),w&&S&&S()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(T){const{range:F,datasource:{languageProvider:w}}=this.props;(0,h.rf)(F,T.range)&&w.fetchLabels()}render(){const{ExtraFieldElement:T,query:F,datasource:w,history:b,onRunQuery:g}=this.props,S=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return v.createElement(v.Fragment,null,v.createElement("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"]},v.createElement("div",{className:"gf-form--grow flex-shrink-1 min-width-15"},v.createElement(V,{datasource:w,history:b??[],onChange:this.onChangeQuery,onRunQuery:g,initialValue:F.expr??"",placeholder:S}))),T)}}},38793:(se,W,l)=>{l.d(W,{Hk:()=>F,U9:()=>y,_z:()=>w,aC:()=>b,iS:()=>L,rf:()=>A,tU:()=>T});function v(g){return h(g/1e3)}function h(g){return Math.floor(g/60)}function A(g,S){if(g&&S){const N=v(g.from.valueOf())===v(S.from.valueOf()),E=v(g.to.valueOf())===v(S.to.valueOf());return!(N&&E)}return!1}const n=/[*+?()|\\.\[\]{}^$]/g;function V(g){return g.replace(n,"\\$&")}function y(g){return g.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')}function L(g){return g.replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}function T(g){return y(V(g))}function F(g,S){return w(S)?T(g):y(g)}function w(g){return!!(g&&(g.includes("=~")||g.includes("!~")))}function b(g){const S=["b","kib","Kib","kb","KB","mib","Mib","mb","MB","gib","Gib","gb","GB","tib","Tib","tb","TB","pib","Pib","pb","PB","eib","Eib","eb","EB"],N=new RegExp(`^(?:-?\\d+(?:\\.\\d+)?)(?:${S.join("|")})$`);return!!g.match(N)}},30736:(se,W,l)=>{l.d(W,{d:()=>b});var v=l(41407),h=l(39953),A=l(948),n=l(83502),V=l(27366),y=l(32688),L=l(82803),T=l(62818),F=l(69865),w=l(39285);function b({title:E,children:$,collapsedInfo:x,queryStats:p}){const[M,ne]=(0,A.Z)(!1),C=(0,L.wW)(g);return h.createElement("div",{className:C.wrapper},h.createElement(T.U,{className:C.collapse,collapsible:!0,isOpen:M,onToggle:ne,label:h.createElement(V.K,{gap:0,wrap:!1},h.createElement("h6",{className:C.title},E),!M&&h.createElement("div",{className:C.description},x.map((ee,G)=>h.createElement("span",{key:G},ee))))},h.createElement("div",{className:C.body},$)),p&&y.config.featureToggles.lokiQuerySplitting&&h.createElement(F.u,{content:"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part."},h.createElement(w.J,{tabIndex:0,name:"info-circle",className:C.tooltip,size:"sm"})),p&&h.createElement("p",{className:C.stats},S(p)))}const g=E=>({collapse:(0,v.css)({backgroundColor:"unset",border:"unset",marginBottom:0,["> button"]:{padding:E.spacing(0,1)}}),wrapper:(0,v.css)({width:"100%",display:"flex",justifyContent:"space-between",alignItems:"baseline"}),title:(0,v.css)({flexGrow:1,overflow:"hidden",fontSize:E.typography.bodySmall.fontSize,fontWeight:E.typography.fontWeightMedium,margin:0}),description:(0,v.css)({color:E.colors.text.secondary,fontSize:E.typography.bodySmall.fontSize,fontWeight:E.typography.bodySmall.fontWeight,paddingLeft:E.spacing(2),gap:E.spacing(2),display:"flex"}),body:(0,v.css)({display:"flex",gap:E.spacing(2),flexWrap:"wrap"}),stats:(0,v.css)({margin:"0px",color:E.colors.text.secondary,fontSize:E.typography.bodySmall.fontSize}),tooltip:(0,v.css)({marginRight:E.spacing(.25)})}),S=E=>E.message?E.message:`This query will process approximately ${N(E)}.`,N=E=>{const{text:$,suffix:x}=(0,n.Cf)("bytes")(E.bytes,1);return $+x}},21249:(se,W,l)=>{l.r(W),l.d(W,{plugin:()=>wn});var v=l(54721),h=l(36316),A=l(77014),n=l(39953),V=l(72639),y=l(32688);function L(){return(0,V.ff)("grafana_traces_cheatsheet_clicked",{datasourceType:"tempo",grafana_version:y.config.buildInfo.version}),n.createElement("div",null,n.createElement("h2",{id:"tempo-cheat-sheet"},"Tempo Cheat Sheet"),n.createElement("p",null,"Tempo is a trace id lookup store. Enter a trace id in the above field and hit \u201CRun Query\u201D to retrieve your trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces."),n.createElement("p",null,"Here are some"," ",n.createElement("a",{href:"https://grafana.com/docs/tempo/latest/guides/instrumentation/",target:"blank"},"instrumentation examples")," ","to get you started with trace discovery through logs and metrics (exemplars)."))}var T=l(41407),F=l(73075),w=l(17789),b=l(74661),g=l(69171),S=l(12223),N=l(20454),E=l(4919),$=l(82803),x=l(99292),p=l(99491),M=l(88132),ne=l(26205);const C=(t,e)=>{const a=t?` (${t})`:"";return`${e||"Error"}${a}. Please check the server logs for more details.`};async function ee(t){if(!t)return;const e=(0,ne.F)();try{return await e.get(t)}catch(a){console.error("Failed to load data source",a);return}}function G({logsDatasourceUid:t,onChange:e,onRunQuery:a,query:r}){const s=(0,x.Z)(()=>ee(t),[t]);if(s.loading)return null;const o=s.value;return o?n.createElement(n.Fragment,null,n.createElement(p.W,null,"Tempo uses ",o.name," to find traces."),n.createElement(M.n,{datasource:o,onChange:e,onRunQuery:a,query:r.linkedQuery??{refId:"linked"},history:[]})):t?t&&!o?n.createElement("div",{className:"text-warning"},"Loki search datasource is configured but the data source no longer exists. Please configure existing data source to use the search."):null:n.createElement("div",{className:"text-warning"},"Please set up a Loki search datasource in the datasource settings.")}var ie=l(99456),Ve=l(5195),he=l(4148),Oe=l(79059),ra=l(52184),ve=l(33155),te=l(9558),Me=l(38637),ft=l(97316),oe=l(14687),le=l(74600),z=l(86832),Ze=l(31312),B=l(63302),He=l(22605),na=l(8894),ht=l(3195),Ot=l(51366),Z=l(71476),Te=l(10752),Ae=l(84289),vt=l(83639),Je=l(41311),sa=l(64912),ia=l.n(sa),ae=l(10694),Tt=l(81626),Le=l(92403),oa=l(96083),H=l(89591),la=l(92743),be=l(34547),ca=l(5365),ye=l(52436),U=l(1838);const ua={wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}},yt=["=","!=",">","<",">=","<=","=~","!~"],da=["=","!=","=~","!~"],Ra=["=","!=",">","<",">=","<="],we=["duration","kind","name","status"],St=["resource","span"],ma=["avg","min","max","sum","count","by"],pa={ignoreCase:!1,defaultToken:"",tokenPostfix:".traceql",keywords:we.concat(St),operators:yt,statusValues:["ok","unset","error","false","true"],functions:ma,symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,tokenizer:{root:[[/[0-9]+(.[0-9]+)?(us|µs|ns|ms|s|m|h)/,"number"],[/^\s*[0-9A-Fa-f]+\s*$/,"tag"],[/[a-zA-Z_.]\w*/,{cases:{"@functions":"predefined","@keywords":"keyword","@statusValues":"type","@default":"tag"}}],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/[{}()\[\]]/,"delimiter.bracket"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/(@digits)[eE]([\-+]?(@digits))?[fFdD]?/,"number.float"],[/(@digits)\.(@digits)([eE][\-+]?(@digits))?[fFdD]?/,"number.float"],[/0(@octaldigits)[Ll]?/,"number.octal"],[/0[bB](@binarydigits)[Ll]?/,"number.binary"],[/(@digits)[fFdD]/,"number.float"],[/(@digits)[lL]?/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]]}},ga={id:"traceql",extensions:[".traceql"],aliases:["tempo","traceql"],mimetypes:[],def:{language:pa,languageConfiguration:ua}},fa={comment:{pattern:/#.*/},"span-set":{pattern:/\{[^}]*}/,inside:{filter:{pattern:/([\w.\/-]+)?(\s*)(([!=+\-<>~]+)\s*("([^"\n&]+)?"?|([^"\n\s&|}]+))?)/g,inside:{comment:{pattern:/#.*/},"label-key":{pattern:/[a-z_.][\w./_-]*(?=\s*(=|!=|>|<|>=|<=|=~|!~))/,alias:"attr-name"},"label-value":{pattern:/("(?:\\.|[^\\"])*")|(\w+)/,alias:"attr-value"}}},punctuation:/[}{&|]/}},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,operator:new RegExp("/[-+*/=%^~]|&&?|\\|?\\||!=?|<(?:=>?|<|>)?|>[>=]?|","i"),punctuation:/[{};()`,.]/},qe=t=>`{${t.filter(e=>e.tag&&e.operator&&e.value?.length).map(e=>`${Et(e)}${e.tag}${e.operator}${ha(e)}`).join(" && ")}}`,ha=t=>Array.isArray(t.value)&&t.value.length>1?`"${t.value.join("|")}"`:t.valueType==="string"?`"${t.value}"`:t.value,Et=t=>we.find(e=>e===t.tag)?"":(t.scope===U.NM.Resource||t.scope===U.NM.Span?t.scope?.toLowerCase():"")+".",et=t=>Et(t)+t.tag,Oa=t=>t.tag==="name"?"Span Name":(0,z.startCase)(et(t)),va=(t,e)=>[...we,...t].filter(a=>!e.includes(a)),$e=t=>(0,z.uniq)(t.map(e=>e.name&&e.name!=="intrinsic"&&e.tags?e.tags:[]).flat()),Ta=t=>(0,z.uniq)(t.map(e=>e.tags?e.tags:[]).flat()),tt=(t,e)=>(0,z.uniq)(t.map(a=>a.name&&a.name===e&&a.tags?a.tags:[]).flat());function at(t,e,a){const r=t.slice(0);return r[e]=a,r}const Qt=t=>{const e={label:t,value:t};switch(t){case"=":e.description="Equals";break;case"!=":e.description="Not equals";break;case">":e.description="Greater";break;case">=":e.description="Greater or Equal";break;case"<":e.description="Less";break;case"<=":e.description="Less or Equal";break;case"=~":e.description="Matches regex";break;case"!~":e.description="Does not match regex";break}return e};var rt=(t=>(t[t.LabelNames=0]="LabelNames",t[t.LabelValues=1]="LabelValues",t))(rt||{});const ya=[{label:"Label names",value:0},{label:"Label values",value:1}],nt="TempoDatasourceVariableQueryEditor-VariableQuery",Sa=({onChange:t,query:e,datasource:a})=>{const[r,s]=(0,n.useState)(e.label||""),[o,i]=(0,n.useState)(e.type),[c,u]=(0,n.useState)([]);(0,n.useEffect)(()=>{o===1&&a.labelNamesQuery().then(f=>{u(f.map(({text:O})=>({label:O,value:O})))})},[a,e,o]);const d=f=>{i(f.value),f.value!==void 0&&t({type:f.value,label:r,refId:nt})},m=f=>{const O=f.value||"";s(O),o!==void 0&&t({type:o,label:O,refId:nt})},R=()=>{o!==void 0&&t({type:o,label:r,refId:nt})};return n.createElement(n.Fragment,null,n.createElement(b.Z,null,n.createElement(g._,{label:"Query type",labelWidth:20},n.createElement(te.Ph,{"aria-label":"Query type",onChange:d,onBlur:R,value:o,options:ya,width:32}))),o===1&&n.createElement(b.Z,null,n.createElement(g._,{label:"Label",labelWidth:20},n.createElement(te.Ph,{"aria-label":"Label",onChange:m,onBlur:R,value:{label:r,value:r},options:c,width:32,allowCustomValue:!0}))))};var Y=l(1497);class st extends v.iL{constructor(e,a){super(),this.request=async(r,s={})=>(await this.datasource.metadataRequest(r,s))?.data,this.start=async()=>(this.startTask||(this.startTask=this.fetchTags().then(()=>[])),this.startTask),this.setV1Tags=r=>{this.tagsV1=r},this.setV2Tags=r=>{this.tagsV2=r},this.getTags=r=>this.tagsV2&&r?r===U.NM.Unscoped?$e(this.tagsV2):tt(this.tagsV2,r):this.tagsV1?(this.tagsV1.find(s=>s==="status")||this.tagsV1.push("status"),this.tagsV1):[],this.getMetricsSummaryTags=r=>this.tagsV2&&r?r===U.NM.Unscoped?$e(this.tagsV2):tt(this.tagsV2,r):this.tagsV1?this.tagsV1:[],this.getTraceqlAutocompleteTags=r=>{if(this.tagsV2){if(r){if(r===U.NM.Unscoped)return $e(this.tagsV2)}else return $e(this.tagsV2);return tt(this.tagsV2,r)}else if(this.tagsV1)return this.tagsV1.find(s=>s==="status")||this.tagsV1.push("status"),this.tagsV1;return[]},this.getAutocompleteTags=()=>this.tagsV2?Ta(this.tagsV2):this.tagsV1?(this.tagsV1.find(r=>r==="status.code")||this.tagsV1.push("status.code"),this.tagsV1):[],this.encodeTag=r=>encodeURIComponent(encodeURIComponent(r)),this.datasource=e,Object.assign(this,a)}async fetchTags(){let e,a;try{a=await this.request("/api/v2/search/tags",[])}catch{e=await this.request("/api/search/tags",[])}a&&a.scopes?this.setV2Tags(a.scopes):e&&this.setV1Tags(e.tagNames)}async getOptionsV1(e){const a=this.encodeTag(e),r=await this.request(`/api/search/tag/${a}/values`);let s=[];return r&&r.tagValues&&(s=r.tagValues.map(o=>({value:o,label:o}))),s}async getOptionsV2(e,a){const r=this.encodeTag(e),s=await this.request(`/api/v2/search/tag/${r}/values`,a?{q:a}:{});let o=[];return s&&s.tagValues&&s.tagValues.forEach(i=>{i.value&&o.push({type:i.type,value:i.value,label:i.value})}),o}}var Pt=l(53305),Ea=l(7906);function Qa(t,e,a){let r;if(!t.length)return Ce;const s={};t.forEach(i=>{const c=ba(i.series,e);i.series.forEach(u=>{s[u.key]={name:`${u.key}`,type:H.fS.string,config:Ca(u,c,a)}})}),r=(0,Pt.at)({name:"Metrics Summary",refId:"metrics-summary",fields:[...Object.values(s).sort((i,c)=>i.name.localeCompare(c.name)),{name:"kind",type:H.fS.string,config:{displayNameFromDS:"Kind",custom:{width:150}}},{name:"spanCount",type:H.fS.number,config:{displayNameFromDS:"Span count",custom:{width:150}}},{name:"errorPercentage",type:H.fS.number,config:{displayNameFromDS:"Error",unit:"percent",custom:{width:150}}},_e("p50"),_e("p90"),_e("p95"),_e("p99")],meta:{preferredVisualisationType:"table"}});const o=t.map(Pa);r.length=o.length;for(const i of o)for(const c of r.fields)c.values.push(i[c.name]);return r=(0,Pt.aK)(r,0),[r]}const Pa=t=>{const e=t.errorSpanCount?Re(t.errorSpanCount)/Re(t.spanCount)*100:"0%",a={kind:"server",spanCount:Re(t.spanCount),errorPercentage:e,p50:Re(t.p50),p90:Re(t.p90),p95:Re(t.p95),p99:Re(t.p99)};return t.series.forEach(r=>{a[`${r.key}`]=Da(r)||""}),a},ba=(t,e)=>{const a=t.map(o=>{const i=o.value.type===3||o.value.type===4,c=o.value.type===8||o.value.type===9,u=i||c?"":'"';return`${o.key}=${u}\${__data.fields["`+o.key+`"]}${u}`});let r="";const s=e.indexOf("}");if(s!==-1){const o=e.substring(s+1);r=e.substring(0,s),a.length>0&&(r+=e.replace(/\s/g,"").includes("{}")?"":" && ",r+=`${a.join(" && ")} && kind=server`,r+="}"),r+=`${o}`}else r=`{${a.join(" && ")} && kind=server} | ${e}`;return r},Ca=(t,e,a)=>{const r={displayNameFromDS:t.key,noValue:"<no value>",links:[{title:"Query in explore",url:"",internal:{datasourceUid:a.uid,datasourceName:a.name,query:{query:e,queryType:"traceql"}}}]};return t.value.type===7?{...r,unit:"ns"}:{...r}},Ue="",Da=t=>{if(!t.value.type)return Ue;switch(t.value.type){case 3:return t.value.n;case 4:return t.value.f;case 5:return t.value.s;case 6:return t.value.b;case 7:return t.value.d;case 8:return Na(t.value.status);case 9:return xa(t.value.kind);default:return Ue}},Na=t=>{if(!t)return Ue;switch(t){case 0:return"error";case 1:return"ok";default:return"unset"}},xa=t=>{if(!t)return Ue;switch(t){case 1:return"internal";case 2:return"client";case 3:return"server";case 4:return"producer";case 5:return"consumer";default:return"unspecified"}},_e=t=>({name:t,type:H.fS.number,config:{displayNameFromDS:t,unit:"ns",custom:{width:150}}}),Re=t=>{const e=parseInt(t,10);return isNaN(e)?0:e},Ce=new Ea.v({name:"Metrics Summary",refId:"metrics-summary",fields:[],meta:{preferredVisualisationType:"table"}});var me=l(94776),Ia=l(53072),it=l(34032),Va=l(48614),Ma=l(60695),Aa=l(16843);async function La(){return(0,it.Z)()}function wa(t,e,a,r){const s=a.range;let o,i=ae.Gu.NotStarted;return(0,Ia.P)(()=>La()).pipe((0,Ae.z)(c=>{const u=performance.now();return(0,Aa.gj)().getStream({scope:Va.z.DataSource,namespace:e.uid,path:`search/${c}`,data:{...t,SpansPerSpanSet:t.spss??De,timeRange:{from:s.from.toISOString(),to:s.to.toISOString()}}}).pipe((0,Z.U)(d=>{if("message"in d&&d?.message){const R=performance.now()-u,f=d.message.data.values[0][0],O=d.message.data.values[1][0],P=d.message.data.values[2][0],X=d.message.data.values[3][0];switch(P){case U.sY.Done:i=ae.Gu.Done;break;case U.sY.Streaming:i=ae.Gu.Streaming;break;case U.sY.Error:throw new Error(X)}o=[$a(O,P,R),...(0,me.KZ)(f,r,t.tableType)]}return{data:o||[],state:i}}))}))}function $a(t,e,a){const r={steps:[{color:"blue",value:-1/0},{color:"green",value:75}],mode:Ma.H.Absolute};return{refId:"streaming-progress",name:"Streaming Progress",length:1,fields:[{name:"state",type:H.fS.string,values:[(0,z.capitalize)(e.toString())],config:{displayNameFromDS:"State"}},{name:"elapsedTime",type:H.fS.number,values:[a],config:{unit:"ms",displayNameFromDS:"Elapsed Time"}},{name:"totalBlocks",type:H.fS.number,values:[t.totalBlocks],config:{displayNameFromDS:"Total Blocks"}},{name:"completedJobs",type:H.fS.number,values:[t.completedJobs],config:{displayNameFromDS:"Completed Jobs"}},{name:"totalJobs",type:H.fS.number,values:[t.totalJobs],config:{displayNameFromDS:"Total Jobs"}},{name:"progress",type:H.fS.number,values:[e===U.sY.Done?100:(t.completedJobs||0)/(t.totalJobs||1)*100],config:{displayNameFromDS:"Progress",unit:"percent",min:0,max:100,custom:{cellOptions:{type:"gauge",mode:"gradient"}},thresholds:r}}],meta:{preferredVisualisationType:"table"}}}var Ua=l(95405);class _a extends Ua.Mg{constructor(e){super(),this.datasource=e,this.editor=Sa}query(e){if(!this.datasource)throw new Error("Datasource not initialized");const a=this.datasource.executeVariableQuery(e.targets[0]);return(0,He.D)(a).pipe((0,Z.U)(r=>({data:r})))}}const pe=20,De=3;var Fa=(t=>(t.streaming="streaming",t))(Fa||{});const Wa={streaming:"2.2.0"},ka="2.1.0";class Ba extends la.CK{constructor(e,a=(0,Oe.J)()){super(e),this.instanceSettings=e,this.templateSrv=a,this.uploadedJson=null,this.init=async()=>{const r=await(0,Ze.n)(this._request("/api/status/buildinfo").pipe((0,Z.U)(s=>s),(0,Te.K)(s=>(console.error("Failure in retrieving build information",s.data.message),(0,B.of)({error:s,data:{version:null}})))));this.tempoVersion=r.data.version},this.handleMetricsSummary=(r,s,o)=>{if((0,V.ff)("grafana_traces_metrics_summary_queried",{datasourceType:"tempo",app:o.app??"",grafana_version:y.config.buildInfo.version,filterCount:r.groupBy?.length??0}),s==="{}")return(0,B.of)({error:{message:"Please ensure you do not have an empty query. This is so filters are applied and the metrics summary is not generated from all spans."},data:Ce});const i=r.groupBy?this.formatGroupBy(r.groupBy):"";return this._request("/api/metrics/summary",{q:s,groupBy:i,start:o.range.from.unix(),end:o.range.to.unix()}).pipe((0,Z.U)(c=>c.data.summaries?c.data.summaries.some(d=>d.series.length>0)?{data:Qa(c.data.summaries,s,this.instanceSettings)}:{error:{message:C("No series data. Ensure you are using an up to date version of Tempo")},data:Ce}:{error:{message:C(`No summary data for '${i}'. Note: the metrics summary API only considers spans of kind = server. You can check if the attributes exist by running a TraceQL query like { attr_key = attr_value && kind = server }`)},data:Ce}),(0,Te.K)(c=>(0,B.of)({error:{message:C(c.data.message)},data:Ce})))},this.formatGroupBy=r=>r?.filter(s=>s.tag).map(s=>s.scope===U.NM.Unscoped?`.${s.tag}`:s.scope!==U.NM.Intrinsic?`${s.scope}.${s.tag}`:s.tag).join(", "),this.hasGroupBy=r=>r.groupBy?.find(s=>s.tag),this.getLokiSearchDS=()=>{const r=this.tracesToLogs?.lokiSearch!==!1&&this.lokiSearch===void 0?this.tracesToLogs?.datasourceUid:void 0;return this.lokiSearch?.datasourceUid??r},this.tracesToLogs=e.jsonData.tracesToLogs,this.serviceMap=e.jsonData.serviceMap,this.search=e.jsonData.search,this.nodeGraph=e.jsonData.nodeGraph,this.lokiSearch=e.jsonData.lokiSearch,this.traceQuery=e.jsonData.traceQuery,this.languageProvider=new st(this),this.search?.filters||(this.search={...this.search,filters:[{id:"service-name",tag:"service.name",operator:"=",scope:U.NM.Resource},{id:"span-name",tag:"name",operator:"=",scope:U.NM.Span}]}),this.variables=new _a(this)}async executeVariableQuery(e){if(e.type===void 0)return new Promise(()=>[]);switch(e.type){case rt.LabelNames:return await this.labelNamesQuery();case rt.LabelValues:return this.labelValuesQuery(e.label);default:throw Error("Invalid query type",e.type)}}async labelNamesQuery(){return await this.languageProvider.fetchTags(),this.languageProvider.getAutocompleteTags().filter(a=>a!==void 0).map(a=>({text:a}))}async labelValuesQuery(e){if(!e)return[];let a;try{const r=(this.languageProvider.tagsV2||[]).flatMap(o=>o.tags.map(i=>({scope:o.name,name:i}))).find(o=>o.name===e)?.scope;if(!r)throw Error(`Scope for tag ${e} not found`);const s=r==="intrinsic"?e:`${r}.${e}`;a=await this.languageProvider.getOptionsV2(s)}catch{a=await this.languageProvider.getOptionsV1(e)}return a.filter(r=>r.value!==void 0).map(r=>({text:r.value}))}isFeatureAvailable(e){const a=this.tempoVersion??ka;try{return ia().gte(a,Wa[e])}catch{return!0}}query(e){const a=[],r=e.targets.filter(i=>!i.hide),s=(0,z.groupBy)(r,i=>i.queryType||"traceql");if(s.clear)return(0,B.of)({data:[],state:ae.Gu.Done});const o=this.getLokiSearchDS();if(o&&s.search?.length>0){(0,V.ff)("grafana_traces_loki_search_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,hasLinkedQueryExpr:!!(s.search[0].linkedQuery?.expr&&s.search[0].linkedQuery?.expr!=="")});const i=(0,ye.ak)();a.push((0,He.D)(i.get(o)).pipe((0,Ae.z)(c=>{const u={...e,targets:s.search.map(R=>R.linkedQuery)},m=c.instanceSettings.jsonData.derivedFields?.filter(R=>R.datasourceUid===this.uid&&R.matcherRegex).map(R=>R.matcherRegex)||[];return!m||m.length===0?(0,na._)(()=>new Error("No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.")):c.query(u).pipe((0,Z.U)(R=>R.error?R:(0,me.RY)(R,this.uid,this.name,m)))})))}if(s.nativeSearch?.length)try{(0,V.ff)("grafana_traces_search_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,hasServiceName:!!s.nativeSearch[0].serviceName,hasSpanName:!!s.nativeSearch[0].spanName,resultLimit:s.nativeSearch[0].limit??"",hasSearch:!!s.nativeSearch[0].search,minDuration:s.nativeSearch[0].minDuration??"",maxDuration:s.nativeSearch[0].maxDuration??""});const i={startTime:e.range.from.unix(),endTime:e.range.to.unix()},c=this.applyVariables(s.nativeSearch[0],e.scopedVars),u=this.buildSearchQuery(c,i);a.push(this._request("/api/search",u).pipe((0,Z.U)(d=>({data:[(0,me.n4)(d.data.traces,this.instanceSettings)]})),(0,Te.K)(d=>(0,B.of)({error:{message:C(d.data.message)},data:[]}))))}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.traceql?.length)try{const c=this.applyVariables(s.traceql[0],e.scopedVars)?.query||"",u=/^[0-9A-Fa-f]*$/;c.trim().match(u)?((0,V.ff)("grafana_traces_traceID_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,hasQuery:c!==""}),a.push(this.handleTraceIdQuery(e,s.traceql))):((0,V.ff)("grafana_traces_traceql_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,query:c??"",streaming:y.config.featureToggles.traceQLStreaming}),y.config.featureToggles.traceQLStreaming&&this.isFeatureAvailable("streaming")?a.push(this.handleStreamingSearch(e,s.traceql,c)):a.push(this._request("/api/search",{q:c,limit:e.targets[0].limit??pe,spss:e.targets[0].spss??De,start:e.range.from.unix(),end:e.range.to.unix()}).pipe((0,Z.U)(d=>({data:(0,me.KZ)(d.data.traces,this.instanceSettings,s.traceql[0].tableType)})),(0,Te.K)(d=>(0,B.of)({error:{message:C(d.data.message)},data:[]})))))}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.traceqlSearch?.length)try{if(y.config.featureToggles.metricsSummary){const c=s.traceqlSearch.find(u=>this.hasGroupBy(u));c&&a.push(this.handleMetricsSummary(c,qe(c.filters),e))}const i=y.config.featureToggles.metricsSummary?s.traceqlSearch.filter(c=>!this.hasGroupBy(c)):s.traceqlSearch;if(i.length>0){const c=qe(i[0].filters),u=this.templateSrv.replace(c,e.scopedVars);(0,V.ff)("grafana_traces_traceql_search_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,query:u??"",streaming:y.config.featureToggles.traceQLStreaming}),y.config.featureToggles.traceQLStreaming&&this.isFeatureAvailable("streaming")?a.push(this.handleStreamingSearch(e,i,u)):a.push(this._request("/api/search",{q:u,limit:e.targets[0].limit??pe,spss:e.targets[0].spss??De,start:e.range.from.unix(),end:e.range.to.unix()}).pipe((0,Z.U)(d=>({data:(0,me.KZ)(d.data.traces,this.instanceSettings,s.traceqlSearch[0].tableType)})),(0,Te.K)(d=>(0,B.of)({error:{message:C(d.data.message)},data:[]}))))}}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.upload?.length)if(this.uploadedJson){(0,V.ff)("grafana_traces_json_file_uploaded",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version});const i=JSON.parse(this.uploadedJson),c=i.batches,u=Array.isArray(i)&&i.some(d=>d?.meta?.preferredVisualisationType==="nodeGraph");c?a.push((0,B.of)((0,me.IM)(i.batches,this.nodeGraph?.enabled))):u?a.push((0,B.of)({data:i,state:ae.Gu.Done})):a.push((0,B.of)({error:{message:"Unable to parse uploaded data."},data:[]}))}else a.push((0,B.of)({data:[],state:ae.Gu.Done}));if(this.serviceMap?.datasourceUid&&s.serviceMap?.length>0){(0,V.ff)("grafana_traces_service_graph_queried",{datasourceType:"tempo",app:e.app??"",grafana_version:y.config.buildInfo.version,hasServiceMapQuery:!!s.serviceMap[0].serviceMapQuery});const i=this.serviceMap.datasourceUid,c=this.uid;a.push(ja(e,i,c).pipe((0,vt.b)(u=>Ga(e,u,i).pipe((0,vt.b)(d=>Ya(e,d,i,c))))))}return(0,ht.T)(...a)}applyTemplateVariables(e,a){return this.applyVariables(e,a)}interpolateVariablesInQueries(e,a){return!e||e.length===0?[]:e.map(r=>({...r,datasource:this.getRef(),...this.applyVariables(r,a)}))}applyVariables(e,a){const r={...e};return e.linkedQuery&&(r.linkedQuery={...e.linkedQuery,expr:this.templateSrv.replace(e.linkedQuery?.expr??"",a)}),{...r,query:this.templateSrv.replace(e.query??"",a,be.b8.Pipe),serviceName:this.templateSrv.replace(e.serviceName??"",a),spanName:this.templateSrv.replace(e.spanName??"",a),search:this.templateSrv.replace(e.search??"",a),minDuration:this.templateSrv.replace(e.minDuration??"",a),maxDuration:this.templateSrv.replace(e.maxDuration??"",a)}}handleTraceIdQuery(e,a){const r=a.filter(o=>o.query).map(o=>({...o,query:o.query.trim(),queryType:"traceId"}));if(!r.length)return Ot.E;const s=this.traceIdQueryRequest(e,r);return super.query(s).pipe((0,Z.U)(o=>o.error?o:(0,me.Jk)(o,this.nodeGraph?.enabled)))}traceIdQueryRequest(e,a){const r={...e,targets:a};return this.traceQuery?.timeShiftEnabled?r.range=e.range&&{...e.range,from:e.range.from.subtract(Tt.intervalToMs(this.traceQuery?.spanStartTimeShift||"30m"),"milliseconds"),to:e.range.to.add(Tt.intervalToMs(this.traceQuery?.spanEndTimeShift||"30m"),"milliseconds")}:r.range={from:(0,Le.CQ)(0),to:(0,Le.CQ)(0),raw:{from:(0,Le.CQ)(0),to:(0,Le.CQ)(0)}},r}handleStreamingSearch(e,a,r){return r===""?Ot.E:(0,ht.T)(...a.map(s=>wa({...s,query:r},this,e,this.instanceSettings)))}async metadataRequest(e,a={}){return await(0,Ze.n)(this._request(e,a,{method:"GET",hideFromInspector:!0}))}_request(e,a,r){const s=a?(0,ca.tW)(a):"",o=`${this.instanceSettings.url}${e}${s.length?`?${s}`:""}`,i={...r,url:o};return(0,he.i)().fetch(i)}async testDatasource(){const e={headers:{},method:"GET",url:`${this.instanceSettings.url}/api/echo`};return await(0,Ze.n)((0,he.i)().fetch(e).pipe((0,Ae.z)(()=>(0,B.of)({status:"success",message:"Data source successfully connected."})),(0,Te.K)(a=>(0,B.of)({status:"error",message:C(a.data.message,"Unable to connect with Tempo")}))))}getQueryDisplayText(e){if(e.queryType==="nativeSearch"){let a=[];for(const r of["serviceName","spanName","search","minDuration","maxDuration","limit"])e.hasOwnProperty(r)&&e[r]&&a.push(`${(0,z.startCase)(r)}: ${e[r]}`);return a.join(", ")}return e.query}buildSearchQuery(e,a){let r=e.search??"",s=(0,z.pick)(e,["minDuration","maxDuration","limit"]);if(s=(0,z.pickBy)(s,z.identity),e.serviceName&&(r+=` service.name="${e.serviceName}"`),e.spanName&&(r+=` name="${e.spanName}"`),s.limit||(s.limit=pe),s.minDuration){if(s.minDuration=this.templateSrv.replace(s.minDuration??""),!(0,Ve.IA)(s.minDuration))throw new Error("Please enter a valid min duration.");s.minDuration=s.minDuration.replace(/\s/g,"")}if(s.maxDuration){if(s.maxDuration=this.templateSrv.replace(s.maxDuration??""),!(0,Ve.IA)(s.maxDuration))throw new Error("Please enter a valid max duration.");s.maxDuration=s.maxDuration.replace(/\s/g,"")}if(!Number.isInteger(s.limit)||s.limit<=0)throw new Error("Please enter a valid limit.");let o={tags:r,...s};return a&&(o.start=a.startTime,o.end=a.endTime),o}}function ot(t,e){return(0,He.D)((0,ye.ak)().get(e)).pipe((0,Ae.z)(a=>a.query(t)))}function ja(t,e,a){const r=lt(t);return ot(r,e).pipe((0,Je.q)(),(0,Z.U)(s=>{const o=s.find(m=>!!m.error);if(o)throw new Error(C(o.error?.message));const{nodes:i,edges:c}=(0,Y.BC)(s,t.range);if(i.fields.length>0&&c.fields.length>0){const m=i.fields[0].values.length,R=c.fields[0].values.length;(0,V.ff)("grafana_traces_service_graph_size",{datasourceType:"tempo",grafana_version:y.config.buildInfo.version,nodeLength:m,edgeLength:R})}const{serviceMapIncludeNamespace:u,refId:d}=t.targets[0];return i.refId=d,c.refId=d,u?(i.fields[0].config=Fe(e,a,"__data.fields.title","__data.fields[0]",void 0,{targetNamespace:"__data.fields.subtitle"}),c.fields[0].config=Fe(e,a,"__data.fields.targetName","__data.fields.target","__data.fields.sourceName",{targetNamespace:"__data.fields.targetNamespace",sourceNamespace:"__data.fields.sourceNamespace"})):(i.fields[0].config=Fe(e,a,"__data.fields.id","__data.fields[0]"),c.fields[0].config=Fe(e,a,"__data.fields.target","__data.fields.target","__data.fields.source")),{data:[i,c],state:ae.Gu.Done}}))}function Ga(t,e,a){const r=lt(t);return r.targets=Dt([ge(Y.rB,Y.T1,t)]),ot(r,a).pipe((0,Je.q)(),(0,Z.U)(s=>{const o=s.find(i=>!!i.error);if(o)throw new Error(C(o.error?.message));return{data:[s[0]?.data??[],e.data[0],e.data[1]],state:ae.Gu.Done}}))}function Ya(t,e,a,r){let s=[],o="",i=[],c=[];if(e.data[0][0]&&t.app===oa.zj.Explore){const m=e.data[0][0].fields.find(R=>R.name==="span_name");m&&m.values&&(c=m.values)}else e.data[0]&&e.data[0].map(m=>{const R=m.fields.find(f=>f.labels?.span_name);R&&c.push(R.labels?.span_name)});const u=Ka(c);u.length>0&&(o=ge(Y.$C,'span_name=~"'+u.join("|")+'"',t),s.push(o),u.map(m=>{const R=ge(Y.vO,'span_name=~"'+m+'"',t);i.push(R),s.push(R)}));const d=lt(t);return d.targets=Dt(s),ot(d,a).pipe((0,Je.q)(),(0,Z.U)(m=>{const R=m.find(O=>!!O.error);if(R)throw new Error(C(R.error?.message));const f=Xa(t,e,m[0],o,i,a,r);return f.fields.length===0?{data:[e.data[1],e.data[2]],state:ae.Gu.Done}:{data:[f,e.data[1],e.data[2]],state:ae.Gu.Done}}))}function Se(t,e,a,r){return{url:"",title:t,internal:{query:{expr:e,range:!r,exemplar:!r,instant:r},datasourceUid:a,datasourceName:(0,ye.ak)().getDataSourceSettingsByUid(a)?.name??""}}}function Ka(t){return t.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\\\$&"))}function Fe(t,e,a,r,s,o){let i=s?`client="\${${s}}",`:"",c=`server="\${${a}}"`,u="server";if(o!==void 0){const{targetNamespace:d}=o;if(c+=`,server_service_namespace="\${${d}}"`,u+=", server_service_namespace",i){const{sourceNamespace:m}=o;i+=`client_service_namespace="\${${m}}",`,u+=", client_service_namespace"}}return{links:[Se("Request rate",`sum by (client, ${u})(rate(${Y.Yt}{${i}${c}}[$__rate_interval]))`,t,!1),Se("Request histogram",`histogram_quantile(0.9, sum(rate(${Y.NZ}{${i}${c}}[$__rate_interval])) by (le, client, ${u}))`,t,!1),Se("Failed request rate",`sum by (client, ${u})(rate(${Y.yf}{${i}${c}}[$__rate_interval]))`,t,!1),bt("View traces",`\${${r}}`,"",e)]}}function bt(t,e,a,r){let s={queryType:"nativeSearch"};return e!==""&&(s.serviceName=e),a!==""&&(s.spanName=a),{url:"",title:t,internal:{query:s,datasourceUid:r,datasourceName:(0,ye.ak)().getDataSourceSettingsByUid(r)?.name??""}}}function lt(t){return{...t,targets:Y.t3.map(e=>{const{serviceMapQuery:a,serviceMapIncludeNamespace:r}=t.targets[0];return{format:"table",refId:e,expr:`sum by (client, server${r?", client_service_namespace, server_service_namespace":""}) (rate(${e}${a||""}[$__range]))`,instant:!0}})}}function Xa(t,e,a,r,s,o,i){let c={fields:[]};const u=e.data[0]?.filter(R=>R.refId===ge(Y.rB,Y.T1,t)),d=a.data.filter(R=>R.refId===r),m=a.data.filter(R=>s.includes(R.refId));if(u.length>0&&u[0].fields?.length>2&&(c.fields.push({...u[0].fields[1],name:"Name",config:{filterable:!1}}),c.fields.push({...u[0].fields[2],name:"Rate",config:{links:[Se("Rate",ct(ge(Y.rB,'span_name="${__data.fields[0]}"',t)),o,!1)],decimals:2}}),c.fields.push({...u[0].fields[2],name:"  ",labels:null,config:{color:{mode:"continuous-BlPu"},custom:{cellOptions:{mode:be.QH.Lcd,type:be.h2.Gauge}},decimals:3}})),d.length>0&&d[0].fields?.length>2){const R=d[0].fields[1]?.values??[],f=d[0].fields[2]?.values??[];let O={};R.map((X,D)=>{O[X]={value:f[D]}});const P=Ct({...u},O);c.fields.push({...d[0].fields[2],name:"Error Rate",values:P,config:{links:[Se("Error Rate",ct(ge(Y.$C,'span_name="${__data.fields[0]}"',t)),o,!1)],decimals:2}}),c.fields.push({...d[0].fields[2],name:"   ",values:P,labels:null,config:{color:{mode:"continuous-RdYlGr"},custom:{cellOptions:{mode:be.QH.Lcd,type:be.h2.Gauge}},decimals:3}})}if(m.length>0&&m[0].fields?.length>1){let R={};m.map(f=>{const O=f.refId?.includes('span_name=~"')?'span_name=~"':'span_name="',P=f.refId?.split(O)[1].split('"}')[0];R[P]={value:f.fields[1].values[0]}}),c.fields.push({...m[0].fields[1],name:"Duration (p90)",values:Ct({...u},R),config:{links:[Se("Duration",ct(ge(Y.vO,'span_name="${__data.fields[0]}"',t)),o,!1)],unit:"s"}})}return c.fields.length>0&&c.fields[0].values&&c.fields.push({name:"Links",type:H.fS.string,values:c.fields[0].values.map(()=>"Tempo"),config:{links:[bt("Tempo","","${__data.fields[0]}",i)]}}),c}function ge(t,e,a){let r=a.targets[0]?.serviceMapQuery??"";const s=r.match(/^{(.*)}$/);s?.length&&(r=s[1]),r=r.replace("client","service").replace("server","service");const o=r.includes("span_name")?t.params.concat(r):t.params.concat(r).concat(e).filter(i=>i);return t.expr.replace("{}","{"+o.join(",")+"}")}function ct(t){return t=t.replace("topk(5, ","").replace(" by (span_name))",""),t.replace("__range","__rate_interval")}function Ct(t,e){const a=t[0]?.fields[1]?.values??[];let r=[];for(let s=0;s<a.length;s++)Object.keys(e).includes(a[s])?r.push(e[a[s]].value):r.push("0");return r}function Dt(t){return t.map(e=>({refId:e,expr:e,instant:!0}))}var Nt=l(84541),Ee=l(59138);class za{constructor(e){this.triggerCharacters=["="," "],this.cachedValues={},this.languageProvider=e.languageProvider}provideCompletionItems(e,a){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==e.id)return{suggestions:[]};const{range:r,offset:s}=Ha(this.monaco,e,a),o=this.getSituation(e.getValue(),s);return this.getCompletions(o).then(c=>{const u=c.length.toString().length;return{suggestions:c.map((m,R)=>({kind:Za(m.type,this.monaco),label:m.label,insertText:m.insertText,sortText:R.toString().padStart(u,"0"),range:r}))}})}async getTagValues(e){let a;return this.cachedValues.hasOwnProperty(e)?a=this.cachedValues[e]:(a=await this.languageProvider.getOptionsV1(e),this.cachedValues[e]=a),a}async getCompletions(e){switch(e.type){case"UNKNOWN":return[];case"EMPTY":return this.getTagsCompletions();case"IN_NAME":return this.getTagsCompletions();case"IN_VALUE":const a=await this.getTagValues(e.tagName),r=[],s=o=>`"${o.label}"`;return a.forEach(o=>{o?.label&&r.push({label:o.label,insertText:s(o),type:"TAG_VALUE"})}),r;default:throw new Error(`Unexpected situation ${e}`)}}getTagsCompletions(){return this.languageProvider.getAutocompleteTags().sort((a,r)=>a.localeCompare(r,void 0,{sensitivity:"accent"})).map(a=>({label:a,insertText:a,type:"TAG_NAME"}))}getSituation(e,a){if(e===""||a===0||e[e.length-1]===" ")return{type:"EMPTY"};const r=e.substring(0,a),s=/(?<key>[^= ]+)(?<equals>=)?(?<value>([^ "]+)|"([^"]*)")?/,o=r.match(new RegExp(s,"g"));if(o?.length){const c=o[o.length-1].match(s);if(c){const u=c.groups?.key,d=c.groups?.equals;return u?d?{type:"IN_VALUE",tagName:u}:{type:"IN_NAME"}:{type:"EMPTY"}}}return{type:"EMPTY"}}}function Za(t,e){switch(t){case"TAG_NAME":return e.languages.CompletionItemKind.Enum;case"KEYWORD":return e.languages.CompletionItemKind.Keyword;case"OPERATOR":return e.languages.CompletionItemKind.Operator;case"TAG_VALUE":return e.languages.CompletionItemKind.EnumMember;case"SCOPE":return e.languages.CompletionItemKind.Class;default:throw new Error(`Unexpected CompletionType: ${t}`)}}function Ha(t,e,a){const r=e.getWordAtPosition(a),s=r!=null?t.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):t.Range.fromPositions(a),o={column:a.column,lineNumber:a.lineNumber};return{offset:e.getOffsetAt(o),range:s}}const Ja={id:"tagsfield",extensions:[".tagsfield"],aliases:["tagsfield"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".tagsfield",operators:["="],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_.][\w./_-]*(?=\s*(=|!=|>|<|>=|<=|=~|!~))/,"tag"],[/[a-zA-Z_.]\w*/,{cases:{"@default":"identifier"}}],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};function qa(t){const{onChange:e,onBlur:a,placeholder:r}=t,s=ar(t.datasource),o=(0,$.l4)(),i=nr(o,r);return n.createElement(Nt.p,{value:t.value,language:Ne,onBlur:a,onChange:e,containerStyles:i.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on"},onBeforeEditorMount:rr,onEditorDidMount:(c,u)=>{s(c,u),er(c,u,i),tr(c)}})}function er(t,e,a){const r=[{range:new e.Range(1,1,1,1),options:{className:a.placeholder,isWholeLine:!0}}];let s=[];const o=()=>{const i=t.getModel();if(!i)return;const c=i.getValueLength()===0?r:[];s=i.deltaDecorations(s,c)};o(),t.onDidChangeModelContent(o)}function tr(t){const e=t.getDomNode(),a=()=>{if(e){const r=Math.min(1e3,t.getContentHeight()),s=parseInt(e.style.width,10);e.style.width=`${s}px`,e.style.height=`${r}px`,t.layout({width:s,height:r})}};t.onDidContentSizeChange(a),a()}function ar(t){const e=(0,n.useRef)(new za({languageProvider:t.languageProvider}));(0,n.useEffect)(()=>{(async()=>{try{await t.languageProvider.start()}catch(s){s instanceof Error&&(0,le.WI)((0,Ee.$l)((0,oe.t_)("Error",s)))}})()},[t]);const a=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{a.current?.()},[]),(r,s)=>{e.current.editor=r,e.current.monaco=s;const{dispose:o}=s.languages.registerCompletionItemProvider(Ne,e.current);a.current=o}}let xt=!1;const Ne="tagsfield";function rr(t){if(!xt){xt=!0;const{aliases:e,extensions:a,mimetypes:r,def:s}=Ja;t.languages.register({id:Ne,aliases:e,extensions:a,mimetypes:r}),t.languages.setMonarchTokensProvider(Ne,s.language),t.languages.setLanguageConfiguration(Ne,s.languageConfiguration)}}const nr=(t,e)=>({queryField:(0,T.css)`
      border-radius: ${t.shape.radius.default};
      border: 1px solid ${t.components.input.borderColor};
      flex: 1;
    `,placeholder:(0,T.css)`
      ::after {
        content: '${e}';
        font-family: ${t.typography.fontFamilyMonospace};
        opacity: 0.3;
      }
    `}),It="e.g. 1.2s, 100ms",sr=({datasource:t,query:e,onChange:a,onBlur:r,onRunQuery:s})=>{const o=(0,$.wW)(ir),i=(0,n.useMemo)(()=>new st(t),[t]),[c,u]=(0,n.useState)(),[d,m]=(0,n.useState)(),[R,f]=(0,n.useState)(null),[O,P]=(0,n.useState)({}),[X,D]=(0,n.useState)({serviceName:!1,spanName:!1}),_=(0,n.useCallback)(async(Q,j="")=>{const Pe=Q==="serviceName"?"service.name":"name";D(K=>({...K,[Q]:!0}));try{return(await i.getOptionsV1(Pe)).filter(I=>I.value?(0,ra.C)(I.value,j).found:!1)}catch(K){return(0,he.kW)(K)&&K?.status===404?f(K):K instanceof Error&&(0,le.WI)((0,ft.$l)((0,oe.t_)("Error",K))),[]}finally{D(K=>({...K,[Q]:!1}))}},[i]);(0,n.useEffect)(()=>{(async()=>{try{const[j,Pe]=await Promise.all([_("serviceName"),_("spanName")]);e.serviceName&&(0,Oe.J)().containsTemplate(e.serviceName)&&j.push((0,ie.E)(e.serviceName)),u(j),e.spanName&&(0,Oe.J)().containsTemplate(e.spanName)&&Pe.push((0,ie.E)(e.spanName)),m(Pe)}catch(j){(0,he.kW)(j)&&j?.status===404?f(j):j instanceof Error&&(0,le.WI)((0,ft.$l)((0,oe.t_)("Error",j)))}})()},[i,_,e.serviceName,e.spanName]);const re=Q=>{Q.key==="Enter"&&(Q.shiftKey||Q.ctrlKey)&&s()},Ie=(0,n.useCallback)(Q=>{a({...e,search:Q})},[a,e]),Xe=(0,Oe.J)();return n.createElement(n.Fragment,null,n.createElement("div",{className:o.container},n.createElement(ve.b,{title:"Deprecated query type",severity:"warning"},"This query type has been deprecated and will be removed in Grafana v10.3. Please migrate to another Tempo query type."),n.createElement(b.Z,null,n.createElement(g._,{label:"Service Name",labelWidth:14,grow:!0},n.createElement(te.Ph,{inputId:"service",options:c,onOpenMenu:()=>{_("serviceName")},isLoading:X.serviceName,value:c?.find(Q=>Q?.value===e.serviceName)||e.serviceName,onChange:Q=>{a({...e,serviceName:Q?.value})},placeholder:"Select a service",isClearable:!0,onKeyDown:re,"aria-label":"select-service-name",allowCustomValue:!0}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Span Name",labelWidth:14,grow:!0},n.createElement(te.Ph,{inputId:"spanName",options:d,onOpenMenu:()=>{_("spanName")},isLoading:X.spanName,value:d?.find(Q=>Q?.value===e.spanName)||e.spanName,onChange:Q=>{a({...e,spanName:Q?.value})},placeholder:"Select a span",isClearable:!0,onKeyDown:re,"aria-label":"select-span-name",allowCustomValue:!0}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Tags",labelWidth:14,grow:!0,tooltip:"Values should be in logfmt."},n.createElement(qa,{placeholder:"http.status_code=200 error=true",value:e.search||"",onChange:Ie,onBlur:r,datasource:t}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Min Duration",invalid:!!O.minDuration,labelWidth:14,grow:!0},n.createElement(Me.I,{id:"minDuration",value:e.minDuration||"",placeholder:It,onBlur:()=>{const Q=Xe.replace(e.minDuration??"");e.minDuration&&!(0,Ve.IA)(Q)?P({...O,minDuration:!0}):P({...O,minDuration:!1})},onChange:Q=>a({...e,minDuration:Q.currentTarget.value}),onKeyDown:re}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Max Duration",invalid:!!O.maxDuration,labelWidth:14,grow:!0},n.createElement(Me.I,{id:"maxDuration",value:e.maxDuration||"",placeholder:It,onBlur:()=>{const Q=Xe.replace(e.maxDuration??"");e.maxDuration&&!(0,Ve.IA)(Q)?P({...O,maxDuration:!0}):P({...O,maxDuration:!1})},onChange:Q=>a({...e,maxDuration:Q.currentTarget.value}),onKeyDown:re}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Limit",invalid:!!O.limit,labelWidth:14,grow:!0,tooltip:"Maximum number of returned results"},n.createElement(Me.I,{id:"limit",value:e.limit||"",placeholder:`Default: ${pe}`,type:"number",onChange:Q=>{let j=Q.currentTarget.value?parseInt(Q.currentTarget.value,10):void 0;j&&(!Number.isInteger(j)||j<=0)?P({...O,limit:!0}):P({...O,limit:!1}),a({...e,limit:Q.currentTarget.value?parseInt(Q.currentTarget.value,10):void 0})},onKeyDown:re})))),R?n.createElement(ve.b,{title:"Unable to connect to Tempo search",severity:"info",className:o.alert},"Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",n.createElement("a",{href:`/datasources/edit/${t.uid}`},"datasource settings"),"."):null)},ir=t=>({container:(0,T.css)`
    max-width: 500px;
  `,alert:(0,T.css)`
    max-width: 75ch;
    margin-top: ${t.spacing(2)};
  `});var Vt=l(87355),or=l(6155),ut=l(46101),Mt=l(28448),lr=l(30736);const dt=n.memo(({onChange:t,query:e})=>{e.hasOwnProperty("limit")||(e.limit=pe),e.hasOwnProperty("tableType")||(e.tableType=U.Mt.Traces);const a=i=>{t({...e,limit:parseInt(i.currentTarget.value,10)})},r=i=>{t({...e,spss:parseInt(i.currentTarget.value,10)})},s=i=>{t({...e,tableType:i})},o=[`Limit: ${e.limit||pe}`,`Spans Limit: ${e.spss||De}`,`Table Format: ${e.tableType===U.Mt.Traces?"Traces":"Spans"}`];return n.createElement(n.Fragment,null,n.createElement(Vt.p,null,n.createElement(lr.d,{title:"Options",collapsedInfo:o},n.createElement(ut.S,{label:"Limit",tooltip:"Maximum number of traces to return."},n.createElement(Mt.H,{className:"width-4",placeholder:"auto",type:"number",min:1,defaultValue:e.limit||pe,onCommitChange:a,value:e.limit})),n.createElement(ut.S,{label:"Span Limit",tooltip:"Maximum number of spans to return for each span set."},n.createElement(Mt.H,{className:"width-4",placeholder:"auto",type:"number",min:1,defaultValue:e.spss||De,onCommitChange:r,value:e.spss})),n.createElement(ut.S,{label:"Table Format",tooltip:"How the query data should be displayed in the results table"},n.createElement(N.S,{options:[{label:"Traces",value:U.Mt.Traces},{label:"Spans",value:U.Mt.Spans}],value:e.tableType,onChange:s})))))});dt.displayName="TempoQueryBuilderOptions";const cr=/^(\$\w+)|(\d+(?:\.\d)?\d*(?:us|µs|ns|ms|s|m|h))$/,ur=()=>({noBoxShadow:(0,T.css)`
    box-shadow: none;
    *:focus {
      box-shadow: none;
    }
  `}),At=({filter:t,operators:e,updateFilter:a})=>{const r=(0,$.wW)(ur);let s=!1;return typeof t.value=="string"&&(s=t.value?!cr.test(t.value.concat("")):!1),n.createElement(S.Lh,{spacing:"none"},n.createElement(te.Ph,{className:r.noBoxShadow,inputId:`${t.id}-operator`,options:e.map(Qt),value:t.operator,onChange:o=>{a({...t,operator:o?.value})},isClearable:!1,"aria-label":`select ${t.id} operator`,allowCustomValue:!0,width:8}),n.createElement(Me.I,{className:r.noBoxShadow,value:t.value,onChange:o=>{a({...t,value:o.currentTarget.value})},placeholder:"e.g. 100ms, 1.2s","aria-label":`select ${t.id} value`,invalid:s,width:18}))};var We=l(81803);const ke=({label:t,tooltip:e,children:a})=>n.createElement(b.Z,null,n.createElement(g._,{label:t,labelWidth:28,grow:!0,tooltip:e},a)),dr=t=>{const{datasource:e,onChange:a,query:r,isTagsLoading:s}=t,o=(0,$.wW)(Rr),i=()=>(0,it.Z)().slice(0,8);(0,n.useEffect)(()=>{(!r.groupBy||r.groupBy.length===0)&&a({...r,groupBy:[{id:i(),scope:U.NM.Span}]})},[a,r]);const c=f=>e.languageProvider.getMetricsSummaryTags(f.scope),u=()=>{m({id:i(),scope:U.NM.Span})},d=f=>{a({...r,groupBy:r.groupBy?.filter(O=>O.id!==f.id)})},m=f=>{const O={...r};O.groupBy||=[];const P=O.groupBy.findIndex(X=>X.id===f.id);P>=0?O.groupBy=at(O.groupBy,P,f):O.groupBy.push(f),a(O)},R=Object.values(U.NM).map(f=>({label:f,value:f}));return n.createElement(ke,{label:"Aggregate by",tooltip:"Select one or more tags to see the metrics summary. Note: the metrics summary API only considers spans of kind = server."},n.createElement(n.Fragment,null,r.groupBy?.map((f,O)=>n.createElement("div",{key:f.id},n.createElement(S.Lh,{spacing:"none",width:"auto"},n.createElement(te.Ph,{"aria-label":`Select scope for filter ${O+1}`,onChange:P=>{m({...f,scope:P?.value,tag:""})},options:R,placeholder:"Select scope",value:f.scope}),n.createElement(te.Ph,{"aria-label":`Select tag for filter ${O+1}`,isClearable:!0,isLoading:s,key:f.tag,onChange:P=>{m({...f,tag:P?.value})},options:c(f)?.map(P=>({label:P,value:P})),placeholder:"Select tag",value:f.tag||""}),n.createElement(We._,{"aria-label":`Remove tag for filter ${O+1}`,icon:"times",onClick:()=>d(f),tooltip:"Remove tag",variant:"secondary"}),O===(r.groupBy?.length??0)-1&&n.createElement("span",{className:o.addFilter},n.createElement(We._,{"aria-label":"Add tag",icon:"plus",onClick:()=>u(),tooltip:"Add tag",variant:"secondary"})))))))},Rr=t=>({addFilter:(0,T.css)`
    margin-left: ${t.spacing(2)};
  `}),mr=()=>({dropdown:(0,T.css)`
    box-shadow: none;
  `}),Lt=({filter:t,datasource:e,updateFilter:a,deleteFilter:r,isTagsLoading:s,tags:o,setError:i,hideScope:c,hideTag:u,hideValue:d,allowDelete:m,query:R})=>{const f=(0,$.wW)(mr),O=(0,n.useMemo)(()=>new st(e),[e]),P=(0,n.useMemo)(()=>et(t),[t]),[X,D]=(0,n.useState)(t.operator),[_,re]=(0,n.useState)(t.value),Ie=async()=>{try{return t.tag?await O.getOptionsV2(P,R):[]}catch(I){(0,he.kW)(I)&&I?.status===404?i(I):I instanceof Error&&(0,le.WI)((0,Ee.$l)((0,oe.t_)("Error",I)))}return[]},{loading:Xe,value:Q}=(0,x.Z)(Ie,[P,O,i,R]);(0,n.useEffect)(()=>{Array.isArray(t.value)&&t.value.length>1&&t.operator!=="=~"&&(D(t.operator),a({...t,operator:"=~"})),Array.isArray(t.value)&&t.value.length<=1&&(_?.length||0)>1&&a({...t,operator:X,value:t.value[0]})},[_,X,a,t]),(0,n.useEffect)(()=>{re(t.value)},[t.value]);const j=Object.values(U.NM).filter(I=>I!==U.NM.Intrinsic).map(I=>({label:I,value:I})),Pe=Q?.filter(I=>I.type===Q[0]?.type),K=Q?.length===Pe?.length?Q?.[0]?.type:void 0;let ze=yt;switch(K){case"string":ze=da;break;case"int":case"float":ze=Ra}return n.createElement(S.Lh,{spacing:"none",width:"auto"},!c&&n.createElement(te.Ph,{className:f.dropdown,inputId:`${t.id}-scope`,options:j,value:t.scope,onChange:I=>{a({...t,scope:I?.value})},placeholder:"Select scope","aria-label":`select ${t.id} scope`}),!u&&n.createElement(te.Ph,{className:f.dropdown,inputId:`${t.id}-tag`,isLoading:s,options:(t.tag!==void 0?(0,z.uniq)([t.tag,...o]):o).map(I=>({label:I,value:I})),value:t.tag,onChange:I=>{a({...t,tag:I?.value})},placeholder:"Select tag",isClearable:!0,"aria-label":`select ${t.id} tag`,allowCustomValue:!0}),n.createElement(te.Ph,{className:f.dropdown,inputId:`${t.id}-operator`,options:ze.map(Qt),value:t.operator,onChange:I=>{a({...t,operator:I?.value})},isClearable:!1,"aria-label":`select ${t.id} operator`,allowCustomValue:!0,width:8}),!d&&n.createElement(te.Ph,{className:f.dropdown,inputId:`${t.id}-value`,isLoading:Xe,options:Q,value:t.value,onChange:I=>{Array.isArray(I)?a({...t,value:I.map($n=>$n.value),valueType:I[0]?.type||K}):a({...t,value:I?.value,valueType:I?.type||K})},placeholder:"Select value",isClearable:!1,"aria-label":`select ${t.id} value`,allowCustomValue:!0,isMulti:!0,allowCreateWhileLoading:!0}),m&&n.createElement(We._,{variant:"secondary",icon:"times",onClick:()=>r?.(t),tooltip:"Remove tag","aria-label":`remove tag with ID ${t.id}`}))},pr=()=>({vertical:(0,T.css)`
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  `,horizontal:(0,T.css)`
    display: flex;
    flex-direction: row;
    gap: 1rem;
  `}),wt=({updateFilter:t,deleteFilter:e,filters:a,datasource:r,setError:s,staticTags:o,isTagsLoading:i,hideValues:c,query:u})=>{const d=(0,$.wW)(pr),m=()=>(0,it.Z)().slice(0,8),R=(0,n.useCallback)(()=>t({id:m(),operator:"=",scope:U.NM.Span}),[t]);(0,n.useEffect)(()=>{a?.length||R()},[a,R]);const f=O=>{const P=r.languageProvider.getTags(O.scope);return va(P,o)};return n.createElement("div",{className:d.vertical},a?.map((O,P)=>n.createElement("div",{className:d.horizontal,key:O.id},n.createElement(Lt,{filter:O,datasource:r,setError:s,updateFilter:t,tags:f(O),isTagsLoading:i,deleteFilter:e,allowDelete:!0,hideValue:c,query:u}),P===a.length-1&&n.createElement(We._,{variant:"secondary",icon:"plus",onClick:R,title:"Add tag"}))))},gr=({datasource:t,query:e,onChange:a})=>{const r=(0,$.wW)(fr),[s,o]=(0,n.useState)(null),[i,c]=(0,n.useState)(!0),[u,d]=(0,n.useState)(""),m=(0,Oe.J)(),R=(0,n.useCallback)(D=>{const _={...e};_.filters||=[];const re=_.filters.findIndex(Ie=>Ie.id===D.id);re>=0?_.filters=at(_.filters,re,D):_.filters.push(D),a(_)},[a,e]),f=D=>{a({...e,filters:e.filters.filter(_=>_.id!==D.id)})};(0,n.useEffect)(()=>{d(qe(e.filters||[]))},[e]);const O=(0,n.useCallback)(D=>e.filters?.find(_=>_.id===D),[e.filters]);(0,n.useEffect)(()=>{(async()=>{try{await t.languageProvider.start(),c(!1)}catch(_){_ instanceof Error&&(0,le.WI)((0,Ee.$l)((0,oe.t_)("Error",_)))}})()},[t]),(0,n.useEffect)(()=>{t.search?.filters?.filter(D=>D.value).forEach(D=>{O(D.id)||R(D)})},[t.search?.filters,O,R]);const P=t.search?.filters?.map(D=>D.tag)||[];P.push("duration");const X=(e.filters||[]).filter(D=>D.tag!=="duration"&&(t.search?.filters?.findIndex(_=>_.id===D.id)||0)===-1);return n.createElement(n.Fragment,null,n.createElement("div",{className:r.container},n.createElement("div",null,t.search?.filters?.map(D=>D.tag&&n.createElement(ke,{key:D.id,label:Oa(D),tooltip:`Filter your search by ${et(D)}. To modify the default filters shown for search visit the Tempo datasource configuration page.`},n.createElement(Lt,{filter:O(D.id)||D,datasource:t,setError:o,updateFilter:R,tags:[],hideScope:!0,hideTag:!0,query:u}))),n.createElement(ke,{label:"Duration",tooltip:"The span duration, i.e.	end - start time of the span. Accepted units are ns, ms, s, m, h"},n.createElement(S.Lh,{spacing:"sm"},n.createElement(At,{filter:O("min-duration")||{id:"min-duration",tag:"duration",operator:">",valueType:"duration"},operators:[">",">="],updateFilter:R}),n.createElement(At,{filter:O("max-duration")||{id:"max-duration",tag:"duration",operator:"<",valueType:"duration"},operators:["<","<="],updateFilter:R}))),n.createElement(ke,{label:"Tags"},n.createElement(wt,{filters:X,datasource:t,setError:o,updateFilter:R,deleteFilter:f,staticTags:P,isTagsLoading:i,query:u})),y.config.featureToggles.metricsSummary&&n.createElement(dr,{datasource:t,onChange:a,query:e,isTagsLoading:i})),n.createElement(Vt.p,null,n.createElement(or.U,{query:m.replace(u),lang:{grammar:fa,name:"traceql"}})),n.createElement(dt,{onChange:a,query:e})),s?n.createElement(ve.b,{title:"Unable to connect to Tempo search",severity:"info",className:r.alert},"Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",n.createElement("a",{href:`/datasources/edit/${t.uid}`},"datasource settings"),"."):null)},fr=t=>({alert:(0,T.css)`
    max-width: 75ch;
    margin-top: ${t.spacing(2)};
  `,container:(0,T.css)`
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    flex-direction: column;
  `});var $t=l(26005),hr=l(26843),Rt=l(60314),Or=l(39285);const Ut=90,_t=({datasource:t,onChange:e,disabled:a,filterKey:r,allFilters:s})=>{const o=()=>Ft(t,r,s),i=()=>yr(t,r,s);return r===null?n.createElement("div",{className:"gf-form","data-testid":"AdHocFilterKey-add-key-wrapper"},n.createElement(Rt.V,{disabled:a,className:"query-segment-key",Component:Tr,value:r,onChange:e,loadOptions:o,inputMinWidth:Ut})):n.createElement("div",{className:"gf-form","data-testid":"AdHocFilterKey-key-wrapper"},n.createElement(Rt.V,{disabled:a,className:"query-segment-key",value:r,onChange:e,loadOptions:i,inputMinWidth:Ut}))},Be="-- remove filter --",vr={label:Be,value:Be},Tr=n.createElement("span",{className:"gf-form-label query-part","aria-label":"Add Filter"},n.createElement(Or.J,{name:"plus"})),Ft=async(t,e,a)=>{const r=await(0,ye.ak)().get(t);if(!r||!r.getTagKeys)return[];const s=a.filter(i=>i.key!==e);return(await r.getTagKeys({filters:s})).map(i=>({label:i.text,value:i.text}))},yr=async(t,e,a)=>{const r=await Ft(t,e,a);return[vr,...r]};var Sr=l(6278);const Er=({datasource:t,disabled:e,onChange:a,filterKey:r,filterValue:s,placeHolder:o,allFilters:i})=>{const c=()=>Qr(t,r,i);return n.createElement("div",{className:"gf-form","data-testid":"AdHocFilterValue-value-wrapper"},n.createElement(Rt.V,{className:"query-segment-value",disabled:e,placeholder:o,value:s,onChange:a,loadOptions:c}))},Qr=async(t,e,a)=>{const r=await(0,ye.ak)().get(t);if(!r||!r.getTagValues)return[];const s=(0,Sr.$t)().timeRange(),o=a.filter(c=>c.key!==e);return(await r.getTagValues({key:e,filters:o,timeRange:s})).map(c=>({label:c.text,value:c.text}))},Pr=["=","!=","<",">","=~","!~"].map(t=>({label:t,value:t})),br=({value:t,disabled:e,onChange:a})=>n.createElement($t.X,{className:"query-segment-operator",value:t,disabled:e,options:Pr,onChange:a}),Wt=({datasource:t,filter:{key:e,operator:a,value:r},onKeyChange:s,onOperatorChange:o,onValueChange:i,placeHolder:c,allFilters:u,disabled:d})=>n.createElement(n.Fragment,null,n.createElement(_t,{disabled:d,datasource:t,filterKey:e,onChange:s,allFilters:u}),n.createElement("div",{className:"gf-form"},n.createElement(br,{disabled:d,value:a,onChange:o})),n.createElement(Er,{disabled:d,datasource:t,filterKey:e,filterValue:r,allFilters:u,onChange:i,placeHolder:c})),Cr=({datasource:t,appendBefore:e,onCompleted:a,allFilters:r})=>{const[s,o]=(0,n.useState)(null),[i,c]=(0,n.useState)("="),u=(0,n.useCallback)(R=>{if(R.value!==Be){o(R.value??"");return}o(null)},[o]),d=(0,n.useCallback)(R=>c(R.value??""),[c]),m=(0,n.useCallback)(R=>{a({value:R.value??"",operator:i,key:s}),o(null),c("=")},[a,i,s]);return s===null?n.createElement(_t,{datasource:t,filterKey:s,onChange:u,allFilters:r}):n.createElement(n.Fragment,{key:"filter-builder"},e,n.createElement(Wt,{datasource:t,filter:{key:s,value:"",operator:i},placeHolder:(0,hr.t)("variable.adhoc.placeholder","Select value"),onKeyChange:u,onOperatorChange:d,onValueChange:m,allFilters:r}))},kt=({label:t})=>n.createElement("div",{className:"gf-form"},n.createElement("span",{className:"gf-form-label query-keyword"},t));class Dr extends n.PureComponent{constructor(){super(...arguments),this.onChange=(e,a)=>r=>{const{filters:s}=this.props,{value:o}=r;return r.value===Be?this.props.removeFilter(e):this.props.changeFilter(e,{...s[e],[a]:o})},this.appendFilterToVariable=e=>{this.props.addFilter(e)}}render(){const{filters:e,disabled:a}=this.props;return n.createElement("div",{className:"gf-form-inline"},this.renderFilters(e,a),!a&&n.createElement(Cr,{datasource:this.props.datasource,appendBefore:e.length>0?n.createElement(kt,{label:"AND"}):null,onCompleted:this.appendFilterToVariable,allFilters:this.getAllFilters()}))}getAllFilters(){return this.props.baseFilters?this.props.baseFilters.concat(this.props.filters):this.props.filters}renderFilters(e,a){return e.length===0&&a?n.createElement($t.X,{disabled:a,value:"No filters",options:[],onChange:()=>{}}):e.reduce((r,s,o)=>(r.length>0&&r.push(n.createElement(kt,{label:"AND",key:`condition-${o}`})),r.push(this.renderFilterSegments(s,o,a)),r),[])}renderFilterSegments(e,a,r){return n.createElement(n.Fragment,{key:`filter-${a}`},n.createElement(Wt,{disabled:r,datasource:this.props.datasource,filter:e,onKeyChange:this.onChange(a,"key"),onOperatorChange:this.onChange(a,"operator"),onValueChange:this.onChange(a,"value"),allFilters:this.getAllFilters()}))}}function Nr({graphDatasourceUid:t,query:e,onChange:a}){const r=(0,$.wW)(Ir),s=(0,x.Z)(()=>ee(t),[t]),[o,i]=(0,n.useState)(void 0);if((0,n.useEffect)(()=>{async function d(m){const R=await m.getTagKeys({filters:[{key:"__name__",operator:"=~",value:"traces_service_graph_request_server_seconds_sum|traces_service_graph_request_total|traces_service_graph_request_failed_total",condition:""}]});i(!!R.length)}!s.loading&&s.value&&d(s.value)},[s]),s.loading)return null;const c=s.value;if(!t)return n.createElement("div",{className:"text-warning"},"Please set up a service graph datasource in the datasource settings.");if(t&&!c)return n.createElement("div",{className:"text-warning"},"Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality.");const u=xr(e.serviceMapQuery||"");return n.createElement("div",null,n.createElement(b.Z,null,n.createElement(g._,{label:"Filter",labelWidth:14,grow:!0},n.createElement(Dr,{datasource:{uid:t},filters:u,baseFilters:[{key:"__name__",operator:"=~",value:"traces_service_graph_request_total|traces_spanmetrics_calls_total",condition:""}],addFilter:d=>{a({...e,serviceMapQuery:mt([...u,d])})},removeFilter:d=>{const m=[...u];m.splice(d,1),a({...e,serviceMapQuery:mt(m)})},changeFilter:(d,m)=>{const R=[...u];R.splice(d,1,m),a({...e,serviceMapQuery:mt(R)})}}))),o===!1?n.createElement(ve.b,{title:"No service graph data found",severity:"info",className:r.alert},"Please ensure that service graph metrics are set up correctly according to the"," ",n.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://grafana.com/docs/grafana/latest/datasources/tempo/#service-graph",className:r.link},"Tempo documentation"),"."):null)}function xr(t){let e,a=[];const r=/([\w_]+)(=|!=|<|>|=~|!~)"(.*?)"/g;for(;(e=r.exec(t))!==null;)a.push({key:e[1],operator:e[2],value:e[3],condition:""});return a}function mt(t){return`{${t.map(e=>`${e.key}${e.operator}"${e.value}"`).join(",")}}`}const Ir=t=>({alert:(0,T.css)`
    max-width: 75ch;
    margin-top: ${t.spacing(2)};
  `,link:(0,T.css)`
    color: ${t.colors.text.link};
    text-decoration: underline;
  `}),Vr={};var Mr=(t=>(t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.INTERNAL=1]="INTERNAL",t[t.SERVER=2]="SERVER",t[t.CLIENT=3]="CLIENT",t[t.PRODUCER=4]="PRODUCER",t[t.CONSUMER=5]="CONSUMER",t))(Mr||{}),Ar=l(48355);const Lr=Ar.WQ.deserialize({version:14,states:",xOVQPOOOVQPO'#CfO!iQPO'#CeO$vQPO'#CgOOQO'#Cy'#CyOOQO'#Cx'#CxO$}QPO'#CxO%SQQO'#CuOOQO'#Cv'#CvO%[QPO'#CvO%gQPO'#C{O%lQPO'#C|O%qQQO'#DOOOQO'#Ce'#CeQ%vQPOOOOQO'#C^'#C^O&[QPO,59QO&cQQO,59bO&nQPO,59OO'VQPO,58xO'^QPO,59QO'^QPO,59QO'^QPO,59QO'^QPO,59QO'^QPO,59QOOQO'#Cj'#CjOOQO'#Co'#CoO'cQSO'#CoO'zQQO'#CqO(PQPO'#CqO!sQPO'#ChO(UQSO,59RO!sQPO'#ChOOQO'#Ch'#ChOOQO,59R,59RO!sQPO,59dO(dQPO,59bO(dQPO,59aOOQO,59b,59bO!sQPO,59gO!sQPO,59hOOQO,59j,59jOVQPO,58xOVQPO,58xOVQPO,58xOVQPO,58xOVQPO,58xOVQPO,58xOOQO1G.l1G.lOOQO1G.|1G.|OOQO1G.j1G.jOOQO1G.d1G.dO'^QPO'#CfO)mQPO1G.lO*]QPO1G.lO*dQPO1G.lO*kQPO1G.lO*rQQO,59]OOQO,59],59]O*}QQO,59]O+SQSO,59SO!sQPO,59SO!sQPO,59SO!sQPO,59SOOQO1G.m1G.mO+bQSO,59SO+vQSO1G/OO(dQPO'#CvO,UQWO1G.{O,sQSO1G/RO-RQSO'#C}O-dQPO1G/SO.TQPO1G.dO.sQPO1G.dO.zQPO1G.dO/RQPO1G.dO/YQPO1G.dO/tQPO,59QOOQO1G.w1G.wO0YQPO1G.wOOQO1G.n1G.nO0pQSO1G.nO0wQSO1G.nOOQO7+$j7+$jO1OQQO,59bOOQO7+$m7+$mO!sQPO,59iOOQO7+$n7+$nO1WQQO7+$cO1]QSO1G/TOOQO<<G}<<G}",stateData:"1w~OuOS~O`WOaWObWOvPOyRO{XO!dTO!eSO!fSO!gSO!hSO!iYO!jZO!l[O~ORdOSeOTfOUgOxhOVXX~OsXXwXX~P!TO_iO`iOaiObiOdkOgmOhmOvnO{pO|pO}iO!OiO!PiO!QiO!RiO!SiO!TiO!UiO!ViO!WiO!XiO!YiO!ZjO![jO!]jO!^jO!_jO!`jO!ajO!bjO!clO~OzrO~P!sOvsO~OktOnuO~O`vOavObvO~OvwO~OvxO~O!myO~ORzOS{OT|OU}OV!POx!OO~Ow!QO~P!TOktOnuOw!RO~Ow!SORQXSQXTQXUQXVQXxQX~Ow!TO~P%vOv!UO~O!c!ZORcXUcX]cXzcXwcX!kcX~Of![O~O!c!]O~OR!`OU!aO]!_Oz!bO~O`WOaWObWOv!eO{XO!dTO!eSO!fSO!gSO!hSO~OSeOTfOxhOUYiVYisYiwYi~ORYi~P)UOSeORYiUYiVYisYixYiwYi~OTYi~P)tORdO~P)UOTfO~P)tOf!pOg!qOh!qO~Of!pO~OR!`OU!aO]!_Ow!rO~OR!`OU!aO]!_Oz[aw[a!k[a~OR!`OU!aO]!_Ow!uO~OktORiiSiiTiiUiiViisiixiiwii~OR!`OU!aO]!_Ow!wO~OR!`OU!aO]!_OwqX!kqX~Ow!yO!k!xO~OS{OT|Ox!OOUQiVQisQiwQi~ORQi~P-lOS{ORQiUQiVQisQixQiwQi~OTQi~P.[ORzO~P-lOT|O~P.[ORzOS{OT|OU}Ox!OOVQisQiwQi~ORdOSeOTfOUgOw!QOxhO~O!c!zO~O]!_OU[iz[iw[i!k[i~OR[i~P0_OR!`O~P0_OktOw!RO~Of!|O~OR!`OU!aO]!_Owqi!kqi~Oab`dghfd~",goto:"%nsPPtPPPPP!^!h!t#d#nP$^PPPP$^P$^PPP#d$jP%P%^P#d#d%k#dQ^OQcPQ!T{Q!jzQ!k|Q!l}Q!m!OR!n!Pa_OPz{|}!O!P^_Oz{|}!O!PRbP^QOz{|}!O!PQ`PQ!QeQ!VdQ!WfQ!XgQ!YhR!o!Ua]OPz{|}!O!PQoRQ!^nQ!cpQ!dsQ!gwQ!hxQ!r!_Q!s!`Q!t!aR!{!xeqRnpswx!_!`!a!x^VOz{|}!O!PQaPQ!RtQ!fuR!v!egWOPtuz{|}!O!P!egUOPtuz{|}!O!P!eR!ix",nodeNames:"\u26A0 TraceQL SpansetPipelineExpression And Gt Desc Or Pipe WrappedSpansetPipeline SpansetPipeline SpansetExpression SpansetFilter FieldExpression FieldOp Static String Integer Float Duration IntrinsicField Parent AttributeField Identifier Resource Span ScalarFilter ScalarExpression ScalarOp Aggregate AggregateExpression ComparisonOp GroupOperation SelectOperation SelectArgs CoalesceOperation",maxTerm:75,skippedNodes:[0],repeatNodeCount:0,tokenData:"#+f~R!WX^$kpq$kqr%`rs%ruv&gvw&nxy&yyz'Wz{&g{|&g|}']}!O'b!O!P'k!P!Q&g!Q![(g!^!_)h!_!`)r!`!a)|!c!}(R#Q#R&g#R#S(R#T#U*b#U#V,O#V#W-Q#W#X>w#X#YCY#Y#ZE|#Z#](R#]#^Hm#^#_(R#_#`MO#`#a(R#a#b! W#b#c!#y#c#d!'W#d#e!(Y#e#f(R#f#g!/e#g#h!>P#h#i!IY#i#j##h#j#o(R#o#p#*v#p#q#*{#q#r#+Y#r#s#+_#y#z$k$f$g$k#BY#BZ$k$IS$I_$k$I|$JO$k$JT$JU$k$KV$KW$k&FU&FV$k~$pYu~X^$kpq$k#y#z$k$f$g$k#BY#BZ$k$IS$I_$k$I|$JO$k$JT$JU$k$KV$KW$k&FU&FV$kV%eQ|P!_!`%k#r#s%kU%rOnQ]S~%uVOY%rZr%rrs&[s#O%r#P;'S%r;'S;=`&a<%lO%r~&aO_~~&dP;=`<%l%r^&nO]SkY~&qPvw&t~&yOR~R'OPvPyz'RQ'WO!mQ~']Ow~~'bO!k~_'kO{P]SkYV'rT!cTfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RQ(WTfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~(lT`~!O!P({!Q![(g#[#])Z#a#b)`#g#h)Z~)OP!Q![)R~)WPa~!Q![)R~)`Ob~~)ePb~#g#h)ZU)oPnQ]S!_!`%kU)yPnQ]S#r#s%k_*VQnQ]SSX!_!`%k!`!a*]X*bOTXR*gVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#j(R#j#k*|#k#o(RR+RVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#Z(R#Z#[+h#[#o(RR+oT!gPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR,TVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#m(R#m#n,j#n#o(RR,qT!iPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR-VZfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#[(R#[#]-x#]#`(R#`#a2x#a#c(R#c#d5l#d#o(RR-}VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^.d#^#o(RR.iVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#a/O#a#o(RR/TVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#W(R#W#X/j#X#o(RR/oVfQ!O!P(R!Q![(R!c!e(R!e!f0U!f!}(R#R#S(R#T#o(RR0ZVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#d0p#d#o(RR0uVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j1[#j#o(RR1aVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c1v#c#o(RR1{VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i2b#i#o(RR2iT![PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR2}VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^3d#^#o(RR3iVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y4O#Y#o(RR4TVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c4j#c#o(RR4oVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i5U#i#o(RR5]T!WPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR5qYfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U6a#U#b(R#b#c9o#c#i(R#i#j<}#j#o(RR6fVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#a6{#a#o(RR7QVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y7g#Y#o(RR7lVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#h8R#h#o(RR8WVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W8m#W#o(RR8rVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y9X#Y#o(RR9`T!lPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR9tVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#h:Z#h#o(RR:`VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j:u#j#o(RR:zVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#a(R#a#b;a#b#o(RR;fVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y;{#Y#o(RR<QVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g<g#g#o(RR<nT!YPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR=SVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c=i#c#o(RR=nVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i>T#i#o(RR>YUfQxy>l!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RP>oPyz>rP>wO!dPR>|VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j?c#j#o(RR?hVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g?}#g#o(RR@SUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U@f#U#o(RR@kVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#iAQ#i#o(RRAVVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^Al#^#o(RRAqVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#dBW#d#o(RRB]VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#cBr#c#o(RRByT!ZPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RRC_VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#gCt#g#o(RRCyVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#gD`#g#o(RRDeVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#dDz#d#o(RREPVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#gEf#g#o(RREmT!RPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RRFRUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#UFe#U#o(RRFjVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#aGP#a#o(RRGUVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#hGk#h#o(RRGpVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#YHV#Y#o(RRH^T!OPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RRHrVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#cIX#c#o(RRI^VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#iIs#i#o(RRIxVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#YJ_#Y#o(RRJdVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#gJy#g#o(RRKOVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#cKe#c#o(RRKjUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#UK|#U#o(RRLRVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#aLh#a#o(RRLoT!UPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RRMTVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^Mj#^#o(RRMoVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#cNU#c#o(RRNZVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#W(R#W#XNp#X#o(RRNwT!_PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR! ]WfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U! u#U#](R#]#^!!w#^#o(RR! zVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#l(R#l#m!!a#m#o(RR!!hT!ePfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!!|VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c!#c#c#o(RR!#jT!fPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!$OWfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!$h#U#](R#]#^!&U#^#o(RR!$mVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#a(R#a#b!%S#b#o(RR!%XVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!%n#Y#o(RR!%uT!]PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!&ZVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#a!&p#a#o(RR!&wT!PPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!']VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#_(R#_#`!'r#`#o(RR!'yT!QPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~!(_WfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!(w#U#f(R#f#g!+k#g#o(R~!(|VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!)c#g#o(R~!)hVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!)}#Y#o(R~!*SVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c!*i#c#o(R~!*nVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i!+T#i#o(R~!+[Td~fQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!+pVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#d!,V#d#o(RR!,[VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#W(R#W#X!,q#X#o(RR!,vVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j!-]#j#o(RR!-bVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W!-w#W#o(RR!-|VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!.c#Y#o(RR!.hVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!.}#g#o(RR!/UT!XPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~!/jXfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!0V#Y#c(R#c#d!4P#d#o(R~!0[VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#h!0q#h#o(R~!0vVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#d!1]#d#o(R~!1bVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j!1w#j#o(R~!1|VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!2c#g#o(R~!2hVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W!2}#W#o(R~!3SVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!3i#Y#o(R~!3pTg~fQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!4UVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#d!4k#d#o(RR!4pVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i!5V#i#o(RR!5[XfQ!O!P(R!Q![(R!c!p(R!p!q!5w!q!u(R!u!v!7|!v!}(R#R#S(R#T#o(RR!5|UfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!6`#U#o(RR!6eVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#a(R#a#b!6z#b#o(RR!7PVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!7f#Y#o(RR!7mT!`PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!8RVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!8h#Y#o(RR!8mVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!9S#g#o(RR!9XVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#j(R#j#k!9n#k#o(RR!9sVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^!:Y#^#o(RR!:_VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W!:t#W#o(RR!:yVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!;`#Y#o(RR!;eVfQ!O!P(R!Q![(R!c!p(R!p!q!;z!q!}(R#R#S(R#T#o(RR!<PUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!<c#U#o(RR!<hVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#a(R#a#b!<}#b#o(RR!=SVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!=i#Y#o(RR!=pT!aPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~!>U[fQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!>z#Y#d(R#d#e!C|#e#h(R#h#i!Eg#i#j!HW#j#o(RR!?PXfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#`(R#`#a!?l#a#f(R#f#g!At#g#o(RR!?qVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!@W#Y#o(RR!@]VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W!@r#W#o(RR!@wVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i!A^#i#o(RR!AeT!jPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!AyVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#j(R#j#k!B`#k#o(RR!BeVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!Bz#Y#o(RR!CPVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!Cf#g#o(RR!CmT!VPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~!DRUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!De#U#o(R~!DjVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c!EP#c#o(R~!EWTh~fQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!ElUfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!FO#U#o(RR!FTVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i!Fj#i#o(RR!FoVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j!GU#j#o(RR!GZVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#h!Gp#h#o(RR!GwT!^PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!H]VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#a(R#a#b!Hr#b#o(RR!HyT!hPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR!I_VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!It#g#o(RR!IyWfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!Jc#U#i(R#i#j#!f#j#o(RR!JhVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W!J}#W#o(RR!KSVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y!Ki#Y#o(RR!KnVfQ!O!P(R!Q![(R!c!f(R!f!g!LT!g!}(R#R#S(R#T#o(RR!LYVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#i(R#i#j!Lo#j#o(RR!LtVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#f(R#f#g!MZ#g#o(RR!M`UfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#U!Mr#U#o(RR!MwVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i!N^#i#o(RR!NcVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^!Nx#^#o(RR!N}VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#c(R#c#d# d#d#o(RR# iVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c#!O#c#o(RR#!VT!bPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR#!kVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y##Q#Y#o(RR##XT}PfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR##mVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#b(R#b#c#$S#c#o(RR#$XVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#g(R#g#h#$n#h#o(RR#$sXfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y#%`#Y#d(R#d#e#&b#e#o(RR#%eVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#h(R#h#i#%z#i#o(RR#&RT!SPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(RR#&gVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y#&|#Y#o(RR#'RVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#V(R#V#W#'h#W#o(RR#'mVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^#(S#^#o(RR#(XVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#Y(R#Y#Z#(n#Z#o(RR#(sVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#](R#]#^#)Y#^#o(RR#)_VfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#X(R#X#Y#)t#Y#o(RR#)yVfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#W(R#W#X#*`#X#o(RR#*gT!TPfQ!O!P(R!Q![(R!c!}(R#R#S(R#T#o(R~#*{Oy~~#+QPV~#p#q#+T~#+YOU~~#+_Oz~]#+fO]SxX",tokenizers:[0,1,2,3],topRules:{TraceQL:[0,1]},tokenPrec:766}),Bt=1,jt=2,wr=3,zn=4,Zn=5,$r=6,Ur=7,Hn=8,_r=9,Jn=10,Gt=11,fe=12,Fr=13,Wr=14,qn=15,es=16,ts=17,as=18,Yt=19,rs=20,je=21,ns=22,ss=23,is=24,kr=25,os=26,ls=27,Kt=28,cs=29,Br=30,jr=31,us=32,Gr=33,ds=34;function Xt(t,e){const a=t.cursorAt(e);do if(a.from===e||a.to===e){const{node:r}=a;if(r.type.isError)return r}while(a.next());return null}function Yr(t,e){return t[e]}function Qe(t,e){let a=t;for(const[r,s]of e)if(a=Yr(a,r),a===null||s.find(o=>o===a?.type.id)===void 0)return null;return a}function pt(t,e){return e.slice(t.from===t.to?t.from-1:t.from,t.to)}function Kr(t,e){return t.every((a,r)=>a===e[r])}function Xr(t,e){if(t==="")return{query:t,type:"EMPTY"};const a=Lr.parse(t);let r=e;for(;r-1>=0&&t[r-1]===" ";)r-=1;let s=Xt(a,r);s||(s=Xt(a,r-1));const o=s!=null?s.cursor():a.cursorAt(r),i=o.node,c=[o.type.id];for(;o.parent();)c.push(o.type.id);let u=null;for(let d of zr)Kr(d.path,c)&&(u=d.fun(i,t,r,e));return{query:t,...u??{type:"UNKNOWN"}}}const ce=0,zr=[{path:[ce,je],fun:Zr},{path:[ce,fe],fun:Hr},{path:[ce,Gt],fun:()=>({type:"SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE"})},{path:[ce,Kt],fun:Jt},{path:[ce,Yt],fun:Jt},{path:[ce,jt],fun:qr},{path:[ce,kr,_r],fun:Jr},{path:[ce,Bt],fun:()=>({type:"UNKNOWN"})},{path:[fe],fun:Zt},{path:[Gt],fun:Zt},{path:[jt],fun:Ht},{path:[Bt],fun:Ht}],zt=(t,e,a)=>{const r=Qe(t,[["firstChild",[fe]]]);if(r&&e[a-1]!==" "){const s=Qe(r,[["firstChild",[je]]]),o=s?pt(s,e):"",i=o.indexOf(".");return{type:"SPANSET_IN_NAME_SCOPE",scope:o.slice(0,i)}}};function Zt(t,e,a,r){const s=zt(t,e,r);if(s)return s;let o=Qe(t,[["firstChild",[fe]],["firstChild",[je]]]);return o?{type:"SPANSET_EXPRESSION_OPERATORS"}:(o=Qe(t,[["lastChild",[fe]],["lastChild",[fe]],["lastChild",[Wr]]]),o?{type:"SPANFIELD_COMBINING_OPERATORS"}:(o=Qe(t,[["lastChild",[fe]]]),o?{type:"SPANSET_EXPRESSION_OPERATORS"}:{type:"SPANSET_EMPTY"}))}function Zr(t,e){const a=Qe(t,[["parent",[je]]]),r=a?pt(a,e):"";if(r===".")return{type:"SPANSET_ONLY_DOT"};const s=r.indexOf("."),o=r.slice(0,s);return["span","resource","parent"].find(i=>i===o)?{type:"SPANSET_IN_NAME_SCOPE",scope:o}:{type:"SPANSET_IN_NAME"}}function Hr(t,e,a,r){const s=zt(t,e,r);if(s)return s;if(t.prevSibling?.type.id===Fr){let o=t.prevSibling.prevSibling;if(o)return{type:"SPANSET_IN_VALUE",tagName:pt(o,e),betweenQuotes:!1}}return t.prevSibling?.type.name==="And"||t.prevSibling?.type.name==="Or"?{type:"SPANSET_EMPTY"}:{type:"SPANSET_IN_THE_MIDDLE"}}function Jr(t,e,a){return t.prevSibling?.type.id===Br?{type:"UNKNOWN"}:{type:"SPANSET_COMPARISON_OPERATORS"}}function Ht(t,e,a){let r=t.firstChild;try{for(r=t.firstChild;r.to<a;)r=r.nextSibling}catch(s){console.error("Unexpected error while searching for previous node",s)}return r?.type.id===wr||r?.type.id===$r?{type:"NEW_SPANSET"}:{type:"SPANSET_COMBINING_OPERATORS"}}function Jt(t,e,a){const r=t?.parent;return r&&[Yt,Kt,jr,Gr].includes(r.type.id)?{type:"ATTRIBUTE_FOR_FUNCTION"}:{type:"UNKNOWN"}}function qr(t,e,a){return t.prevSibling?.type.id===Ur?{type:"SPANSET_PIPELINE_AFTER_OPERATOR"}:{type:"NEW_SPANSET"}}const k=class{constructor(t){this.triggerCharacters=["{",".","[","(","=","~"," ",'"'],this.cachedValues={},this.languageProvider=t.languageProvider,this.registerInteractionCommandId=null}provideCompletionItems(t,e){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:a,offset:r}=tn(this.monaco,t,e),s=Xr(t.getValue(),r);return(s!=null?this.getCompletions(s):Promise.resolve([])).then(i=>{const c=i.length.toString().length;return{suggestions:i.map((d,m)=>{const R={kind:en(d.type,this.monaco),label:d.label,insertText:d.insertText,insertTextRules:d.insertTextRules,detail:d.detail,documentation:d.documentation,sortText:m.toString().padStart(c,"0"),range:a,command:{id:this.registerInteractionCommandId||"noOp",title:"Report Interaction",arguments:[d.label,d.type]}};return an(R,d.type,t,r),R})}})}setRegisterInteractionCommandId(t){this.registerInteractionCommandId=t}async getTagValues(t,e){let a;return this.cachedValues.hasOwnProperty(t)?a=this.cachedValues[t]:(a=await this.languageProvider.getOptionsV2(t,e),this.cachedValues[t]=a),a}async getCompletions(t){switch(t.type){case"UNKNOWN":return[];case"EMPTY":return this.getScopesCompletions("{ ").concat(this.getIntrinsicsCompletions("{ ")).concat(this.getTagsCompletions("{ ."));case"SPANSET_EMPTY":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));case"SPANSET_ONLY_DOT":return this.getTagsCompletions();case"SPANSET_IN_THE_MIDDLE":return[...k.comparisonOps,...k.logicalOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE":return[...k.comparisonOps,...k.logicalOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_IN_NAME":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions());case"SPANSET_IN_NAME_SCOPE":return this.getTagsCompletions(void 0,t.scope);case"SPANSET_EXPRESSION_OPERATORS":return[...k.comparisonOps,...k.logicalOps,...k.arithmeticOps].map(i=>({...i,type:"OPERATOR"}));case"SPANFIELD_COMBINING_OPERATORS":return[...k.logicalOps,...k.arithmeticOps,...k.comparisonOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_COMBINING_OPERATORS":return k.spansetOps.map(i=>({...i,type:"OPERATOR"}));case"SPANSET_PIPELINE_AFTER_OPERATOR":const e=k.functions.map(i=>({...i,insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet,type:"FUNCTION"})),a=this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));return[...e,...a];case"SPANSET_COMPARISON_OPERATORS":return k.comparisonOps.map(i=>({...i,type:"OPERATOR"}));case"SPANSET_IN_VALUE":let r;try{r=await this.getTagValues(t.tagName,t.query)}catch(i){(0,he.kW)(i)?(0,le.WI)((0,Ee.$l)((0,oe.t_)(i.data.error,new Error(i.data.message)))):i instanceof Error&&(0,le.WI)((0,Ee.$l)((0,oe.t_)("Error",i)))}const s=[],o=i=>t.betweenQuotes?i.label:i.type==="string"?`"${i.label}"`:i.label;return r?.forEach(i=>{i?.label&&s.push({label:i.label,insertText:o(i),type:"TAG_VALUE"})}),s;case"SPANSET_AFTER_VALUE":return k.logicalOps.map(i=>({label:i.label,insertText:i.insertText+"}",type:"OPERATOR"}));case"NEW_SPANSET":return this.getScopesCompletions("{ ","$0 }").concat(this.getIntrinsicsCompletions("{ ","$0 }")).concat(this.getTagsCompletions("."));case"ATTRIBUTE_FOR_FUNCTION":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));default:throw new Error(`Unexpected situation ${t}`)}}getTagsCompletions(t,e){return this.languageProvider.getTraceqlAutocompleteTags(e).sort((r,s)=>r.localeCompare(s,void 0,{sensitivity:"accent"})).map(r=>({label:r,insertText:(t||"")+r,type:"TAG_NAME"}))}getIntrinsicsCompletions(t,e){return we.map(a=>({label:a,insertText:(t||"")+a+(e||""),type:"KEYWORD",insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet}))}getScopesCompletions(t,e){return St.map(a=>({label:a,insertText:(t||"")+a+(e||""),type:"SCOPE",insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet}))}};let ue=k;ue.arithmeticOps=[{label:"+",insertText:"+",detail:"Plus"},{label:"-",insertText:"-",detail:"Minus"},{label:"*",insertText:"*",detail:"Times"},{label:"/",insertText:"/",detail:"Over"}],ue.logicalOps=[{label:"&&",insertText:"&&",detail:"And",documentation:"And (intersection) operator. Checks that both conditions found matches."},{label:"||",insertText:"||",detail:"Or",documentation:"Or (union) operator. Checks that either condition found matches."}],ue.comparisonOps=[{label:"=",insertText:"=",detail:"Equality"},{label:"!=",insertText:"!=",detail:"Inequality"},{label:">",insertText:">",detail:"Greater than"},{label:">=",insertText:">=",detail:"Greater than or equal to"},{label:"<",insertText:"<",detail:"Less than"},{label:"<=",insertText:"<=",detail:"Less than or equal to"},{label:"=~",insertText:"=~",detail:"Regular expression"},{label:"!~",insertText:"!~",detail:"Negated regular expression"}],ue.structuralOps=[{label:">>",insertText:">>",detail:"Descendant",documentation:"Descendant operator. Looks for spans matching {condB} that are descendants of a span matching {condA}"},{label:">",insertText:">",detail:"Child",documentation:"Child operator. Looks for spans matching {condB} that are direct child spans of a parent matching {condA}"},{label:"~",insertText:"~",detail:"Sibling",documentation:"Sibling operator. Checks that spans matching {condA} and {condB} are siblings of the same parent span."}],ue.spansetOps=[{label:"|",insertText:"|",detail:"Pipe"},...k.logicalOps,...k.structuralOps],ue.spansetAggregatorOps=[{label:"count",insertText:"count()$0",detail:"Number of spans",documentation:"Counts the number of spans in a spanset"},{label:"avg",insertText:"avg($0)",detail:"Average of attribute",documentation:"Computes the average of a given numeric attribute or intrinsic for a spanset."},{label:"max",insertText:"max($0)",detail:"Max value of attribute",documentation:"Computes the maximum value of a given numeric attribute or intrinsic for a spanset."},{label:"min",insertText:"min($0)",detail:"Min value of attribute",documentation:"Computes the minimum value of a given numeric attribute or intrinsic for a spanset."},{label:"sum",insertText:"sum($0)",detail:"Sum value of attribute",documentation:"Computes the sum value of a given numeric attribute or intrinsic for a spanset."}],ue.functions=[...k.spansetAggregatorOps,{label:"by",insertText:"by($0)",detail:"Grouping of attributes",documentation:"Groups by arbitrary attributes."},{label:"select",insertText:"select($0)",detail:"Selection of fields",documentation:"Selects arbitrary fields from spans."}];function en(t,e){switch(t){case"TAG_NAME":return e.languages.CompletionItemKind.Enum;case"KEYWORD":return e.languages.CompletionItemKind.Keyword;case"OPERATOR":return e.languages.CompletionItemKind.Operator;case"TAG_VALUE":return e.languages.CompletionItemKind.EnumMember;case"SCOPE":return e.languages.CompletionItemKind.Class;case"FUNCTION":return e.languages.CompletionItemKind.Function;default:throw new Error(`Unexpected CompletionType: ${t}`)}}function tn(t,e,a){const r=e.getWordAtPosition(a),s=r!=null?t.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):t.Range.fromPositions(a),o={column:a.column,lineNumber:a.lineNumber};return{offset:e.getOffsetAt(o),range:s}}function an(t,e,a,r){if(e==="TAG_NAME"){const s=a.getValue().substring(0,r).match(/(span\.|resource\.|\.)?([\w./-]*)$/);if(s){const o=s[1],i=s[2];i&&(!o&&t.insertText[0]!=="."&&(t.insertText="."+t.insertText),t.range={...t.range,startColumn:r-i.length+1})}}}function rn(t){const{onChange:e,onRunQuery:a,placeholder:r}=t,s=cn(t.datasource),o=(0,$.l4)(),i=dn(o,r),c=(0,n.useRef)(a);return c.current=a,n.createElement(Nt.p,{value:t.value,language:xe,onBlur:e,onChange:e,containerStyles:i.queryField,readOnly:t.readOnly,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on"},onBeforeEditorMount:un,onEditorDidMount:(u,d)=>{t.readOnly||(s(u,d,on(u)),sn(u,d,()=>c.current()),nn(u,d,i)),ln(u)}})}function nn(t,e,a){const r=[{range:new e.Range(1,1,1,1),options:{className:a.placeholder,isWholeLine:!0}}];let s=[];const o=()=>{const i=t.getModel();if(!i)return;const c=i.getValueLength()===0?r:[];s=i.deltaDecorations(s,c)};o(),t.onDidChangeModelContent(o)}function sn(t,e,a){t.addAction({id:"run-query",label:"Run Query",keybindings:[e.KeyMod.Shift|e.KeyCode.Enter],contextMenuGroupId:"navigation",contextMenuOrder:1.5,run:function(){a()}})}function on(t){return t.addCommand(0,function(e,a,r){const s={datasourceType:"tempo",type:r};r!=="TAG_VALUE"&&(s.label=a),(0,V.ff)("grafana_traces_traceql_completion",s)})}function ln(t){const e=t.getDomNode(),a=()=>{if(e){const r=Math.min(1e3,t.getContentHeight()),s=parseInt(e.style.width,10);e.style.width=`${s}px`,e.style.height=`${r}px`,t.layout({width:s,height:r})}};t.onDidContentSizeChange(a),a()}function cn(t){const e=(0,n.useRef)(new ue({languageProvider:t.languageProvider}));(0,n.useEffect)(()=>{(async()=>{try{await t.languageProvider.start()}catch(s){s instanceof Error&&(0,le.WI)((0,Ee.$l)((0,oe.t_)("Error",s)))}})()},[t]);const a=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{a.current?.()},[]),(r,s,o)=>{e.current.editor=r,e.current.monaco=s,e.current.setRegisterInteractionCommandId(o);const{dispose:i}=s.languages.registerCompletionItemProvider(xe,e.current);a.current=i}}let qt=!1;const xe="traceql";function un(t){if(!qt){qt=!0;const{aliases:e,extensions:a,mimetypes:r,def:s}=ga;t.languages.register({id:xe,aliases:e,extensions:a,mimetypes:r}),t.languages.setMonarchTokensProvider(xe,s.language),t.languages.setLanguageConfiguration(xe,s.languageConfiguration)}}const dn=(t,e)=>({queryField:(0,T.css)`
      border-radius: ${t.shape.radius.default};
      border: 1px solid ${t.components.input.borderColor};
      flex: 1;
    `,placeholder:(0,T.css)`
      ::after {
        content: '${e}';
        font-family: ${t.typography.fontFamilyMonospace};
        opacity: 0.3;
      }
    `});function Rn(t){const e=(0,$.wW)(mn),a=(0,z.defaults)(t.query,Vr),r=s=>{t.onChange({...a,query:s})};return n.createElement(n.Fragment,null,n.createElement(p.W,null,"Build complex queries using TraceQL to select a list of traces."," ",n.createElement("a",{rel:"noreferrer",target:"_blank",href:"https://grafana.com/docs/tempo/latest/traceql/"},"Documentation")),n.createElement(rn,{placeholder:"Enter a TraceQL query or trace ID (run with Shift+Enter)",value:a.query,onChange:r,datasource:t.datasource,onRunQuery:t.onRunQuery}),n.createElement("div",{className:e.optionsContainer},n.createElement(dt,{query:a,onChange:t.onChange})))}const mn=()=>({optionsContainer:(0,T.css)`
    margin-top: 10px;
  `}),pn="traceql";class gn extends n.PureComponent{constructor(e){super(e),this.onChangeLinkedQuery=a=>{const{query:r,onChange:s}=this.props;s({...r,linkedQuery:{...a,refId:"linked"}})},this.onRunLinkedQuery=()=>{this.props.onRunQuery()},this.onClearResults=()=>{const{onChange:a,query:r,onRunQuery:s}=this.props;a({...r,queryType:"clear"}),s()},this.state={uploadModalOpen:!1}}async componentDidMount(){(!this.props.query.queryType||this.props.query.queryType==="clear")&&this.props.onChange({...this.props.query,queryType:pn})}render(){const{query:e,onChange:a,datasource:r,app:s}=this.props,o=r.getLokiSearchDS(),i=r.serviceMap?.datasourceUid;let c=[{value:"traceqlSearch",label:"Search"},{value:"traceql",label:"TraceQL"},{value:"serviceMap",label:"Service Graph"}];return o&&(r?.search?.hide?c.unshift({value:"search",label:"Search"}):c.push({value:"search",label:"Loki Search"})),(e.spanName||e.serviceName||e.search||e.maxDuration||e.minDuration||e.queryType==="nativeSearch")&&c.unshift({value:"nativeSearch",label:"[Deprecated] Search"}),n.createElement(n.Fragment,null,n.createElement(F.u,{title:"Upload trace",isOpen:this.state.uploadModalOpen,onDismiss:()=>this.setState({uploadModalOpen:!1})},n.createElement("div",{className:(0,T.css)({padding:this.props.theme.spacing(2)})},n.createElement(w.Yo,{options:{multiple:!1},onLoad:u=>{this.props.datasource.uploadedJson=u,a({...e,queryType:"upload"}),this.setState({uploadModalOpen:!1}),this.props.onRunQuery()}}))),n.createElement(b.Z,null,n.createElement(g._,{label:"Query type",grow:!0},n.createElement(S.Lh,{spacing:"sm",align:"center",justify:"space-between"},n.createElement(N.S,{options:c,value:e.queryType,onChange:u=>{(0,V.ff)("grafana_traces_query_type_changed",{datasourceType:"tempo",app:s??"",grafana_version:y.config.buildInfo.version,newQueryType:u,previousQueryType:e.queryType??""}),this.onClearResults(),a({...e,queryType:u})},size:"md"}),n.createElement(E.zx,{variant:"secondary",size:"sm",onClick:()=>{this.setState({uploadModalOpen:!0})}},"Import trace")))),e.queryType==="search"&&n.createElement(G,{logsDatasourceUid:o,query:e,onRunQuery:this.onRunLinkedQuery,onChange:this.onChangeLinkedQuery}),e.queryType==="nativeSearch"&&n.createElement(sr,{datasource:this.props.datasource,query:e,onChange:a,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery}),e.queryType==="traceqlSearch"&&n.createElement(gr,{datasource:this.props.datasource,query:e,onChange:a,onBlur:this.props.onBlur}),e.queryType==="serviceMap"&&n.createElement(Nr,{graphDatasourceUid:i,query:e,onChange:a}),e.queryType==="traceql"&&n.createElement(Rn,{datasource:this.props.datasource,query:e,onRunQuery:this.props.onRunQuery,onChange:a}))}}const fn=(0,$.HE)(gn);var hn=l(17613),On=l(66211),vn=l(84461),Tn=l(28789),yn=l(27770),Sn=l(54522),Ge=l(99242),En=l(47169),Ye=l(43997),J=l(3793),Qn=l(23846),gt=l(36516),Pn=l(49605),bn=l(95577),q=l(47635),ea=l(11286),ta=l(26286),aa=l(13273);function Cn({options:t,onOptionsChange:e}){const a=(0,$.wW)(Ke),r=o=>`Time shift for ${o} of search`,s=o=>`Shifts the ${o} of the time range when searching by TraceID. Searching can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default: 30m (Time units can be used here, for example: 5s, 1m, 3h`;return n.createElement("div",{className:a.container},n.createElement(g._,{label:"Use time range in query",tooltip:"The time range can be used when there are performance issues or timeouts since it will narrow down the search to the defined range. Default: disabled",labelWidth:26},n.createElement(ta.x,{id:"enable-time-shift",value:t.jsonData.traceQuery?.timeShiftEnabled||!1,onChange:o=>{(0,q.tp)({onOptionsChange:e,options:t},"traceQuery",{...t.jsonData.traceQuery,timeShiftEnabled:o.currentTarget.checked})}})),n.createElement(aa.w,{label:r("start"),tooltip:s("start"),value:t.jsonData.traceQuery?.spanStartTimeShift||"",disabled:!t.jsonData.traceQuery?.timeShiftEnabled,onChange:o=>{(0,q.tp)({onOptionsChange:e,options:t},"traceQuery",{...t.jsonData.traceQuery,spanStartTimeShift:o})},isInvalidError:gt.Ny}),n.createElement(aa.w,{label:r("end"),tooltip:s("end"),value:t.jsonData.traceQuery?.spanEndTimeShift||"",disabled:!t.jsonData.traceQuery?.timeShiftEnabled,onChange:o=>{(0,q.tp)({onOptionsChange:e,options:t},"traceQuery",{...t.jsonData.traceQuery,spanEndTimeShift:o})},isInvalidError:gt.Ny}))}const Ke=t=>({infoText:(0,T.css)`
    padding-bottom: ${t.spacing(2)};
    color: ${t.colors.text.secondary};
  `,container:(0,T.css)`
    width: 100%;
  `,row:(0,T.css)`
    align-items: baseline;
  `});function Dn({options:t,onOptionsChange:e}){const a=(0,$.wW)(Ke),r=t.jsonData.tracesToLogs?.lokiSearch!==!1?t.jsonData.tracesToLogs?.datasourceUid:void 0;return r&&t.jsonData.lokiSearch===void 0&&(0,q.tp)({onOptionsChange:e,options:t},"lokiSearch",{datasourceUid:r}),n.createElement("div",{className:a.container},n.createElement(b.Z,{className:a.row},n.createElement(g._,{tooltip:"The Loki data source with the service graph data",label:"Data source",labelWidth:26},n.createElement(ea.q,{inputId:"loki-search-data-source-picker",pluginId:"loki",current:t.jsonData.lokiSearch?.datasourceUid,noDefault:!0,width:40,onChange:s=>(0,q.tp)({onOptionsChange:e,options:t},"lokiSearch",{datasourceUid:s.uid})})),t.jsonData.lokiSearch?.datasourceUid?n.createElement(E.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,q.tp)({onOptionsChange:e,options:t},"lokiSearch",{datasourceUid:void 0})}},"Clear"):null))}function Nn({options:t,onOptionsChange:e}){const a=(0,$.wW)(Ke);return n.createElement("div",{className:a.container},n.createElement(b.Z,{className:a.row},n.createElement(g._,{tooltip:"The Prometheus data source with the service graph data",label:"Data source",labelWidth:26},n.createElement(ea.q,{inputId:"service-graph-data-source-picker",pluginId:"prometheus",current:t.jsonData.serviceMap?.datasourceUid,noDefault:!0,width:40,onChange:r=>(0,q.tp)({onOptionsChange:e,options:t},"serviceMap",{datasourceUid:r.uid})})),t.jsonData.serviceMap?.datasourceUid?n.createElement(E.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,q.tp)({onOptionsChange:e,options:t},"serviceMap",{datasourceUid:void 0})}},"Clear"):null))}function xn({options:t,onOptionsChange:e,datasource:a}){const r=async()=>{if(!a)throw new Error("Unable to retrieve datasource");try{await a.languageProvider.start()}catch(m){throw new Error(C(m.data.message,"Unable to query Tempo"))}},{error:s,loading:o}=(0,x.Z)(r,[a,t]),i=(0,n.useCallback)(m=>{let R=t.jsonData.search?.filters;R||=[];const f=R.findIndex(O=>O.id===m.id);f>=0?R=at(R,f,m):R.push(m),(0,q.tp)({onOptionsChange:e,options:t},"search",{...t.jsonData.search,filters:R})},[e,t]),c=m=>{(0,q.tp)({onOptionsChange:e,options:t},"search",{...t.jsonData.search,filters:t.jsonData.search?.filters?.filter(R=>R.id!==m.id)})};(0,n.useEffect)(()=>{t.jsonData.search?.filters||(0,q.tp)({onOptionsChange:e,options:t},"search",{...t.jsonData.search,filters:[{id:"service-name",tag:"service.name",operator:"=",scope:U.NM.Resource},{id:"span-name",tag:"name",operator:"=",scope:U.NM.Span}]})},[e,t]);const u=["duration"],d=t.jsonData.search?.filters?.find(m=>!m.tag);return n.createElement(n.Fragment,null,a?n.createElement(wt,{updateFilter:i,deleteFilter:c,filters:t.jsonData.search?.filters||[],datasource:a,setError:()=>{},staticTags:u,isTagsLoading:o,hideValues:!0,query:"{}"}):n.createElement("div",null,"Invalid data source, please create a valid data source and try again"),s&&n.createElement(ve.b,{title:"Unable to fetch TraceQL tags",severity:"error",topSpacing:1},s.message),d&&n.createElement(ve.b,{title:"Please ensure each filter has a selected tag",severity:"warning",topSpacing:1}))}function In({options:t,onOptionsChange:e}){const a=(0,$.wW)(Ke),r=(0,ne.F)(),s=async()=>await r.get({type:t.type,uid:t.uid}),{value:o}=(0,x.Z)(s,[r,t]);return n.createElement("div",{className:a.container},n.createElement(b.Z,{className:a.row},n.createElement(g._,{tooltip:"Removes the search tab from the query editor",label:"Hide search",labelWidth:26},n.createElement(ta.x,{id:"hideSearch",value:t.jsonData.search?.hide,onChange:i=>(0,q.tp)({onOptionsChange:e,options:t},"search",{...t.jsonData.search,hide:i.currentTarget.checked})}))),n.createElement(b.Z,{className:a.row},n.createElement(g._,{tooltip:"Configures which fields are available in the UI",label:"Static filters",labelWidth:26},n.createElement(xn,{datasource:o,options:t,onOptionsChange:e}))))}const Vn=({options:t,onOptionsChange:e})=>{const a=(0,$.wW)(Mn);return n.createElement("div",{className:a.container},n.createElement(hn.j,{dataSourceName:"Tempo",docsLink:"https://grafana.com/docs/grafana/latest/datasources/tempo",hasRequiredFields:!1}),n.createElement(J.i,null),n.createElement(On.f,{config:t,onChange:e,urlPlaceholder:"http://localhost:3200"}),n.createElement(J.i,null),n.createElement(vn.g,{...(0,Tn.T2)({config:t,onChange:e})}),n.createElement(J.i,null),n.createElement(gt.dw,{options:t,onOptionsChange:e}),n.createElement(J.i,null),y.config.featureToggles.traceToMetrics?n.createElement(n.Fragment,null,n.createElement(Pn.Y,{options:t,onOptionsChange:e}),n.createElement(J.i,null)):null,n.createElement(yn.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1},n.createElement(Sn.a,{config:t,onChange:e}),y.config.secureSocksDSProxyEnabled&&n.createElement(n.Fragment,null,n.createElement(J.i,{hideLine:!0}),n.createElement(En.i,{options:t,onOptionsChange:e})),n.createElement(J.i,{hideLine:!0}),n.createElement(Ge._,{title:"Service graph",description:n.createElement(Ye.W,{description:"Select a Prometheus data source that contains the service graph data.",suffix:"tempo/#service-graph",feature:"the service graph"})},n.createElement(Nn,{options:t,onOptionsChange:e})),n.createElement(J.i,{hideLine:!0}),n.createElement(Qn.I,{options:t,onOptionsChange:e}),n.createElement(J.i,{hideLine:!0}),n.createElement(Ge._,{title:"Tempo search",description:n.createElement(Ye.W,{description:"Modify how traces are searched.",suffix:"tempo/#tempo-search",feature:"Tempo search"})},n.createElement(In,{options:t,onOptionsChange:e})),n.createElement(J.i,{hideLine:!0}),n.createElement(Ge._,{title:"Loki search",description:n.createElement(Ye.W,{description:"Select a Loki data source to search for traces. Derived fields must be configured in the Loki data source.",suffix:"tempo/#loki-search",feature:"Loki search"})},n.createElement(Dn,{options:t,onOptionsChange:e})),n.createElement(J.i,{hideLine:!0}),n.createElement(Ge._,{title:"TraceID query",description:n.createElement(Ye.W,{description:"Modify how TraceID queries are run.",suffix:"tempo/#traceid-query",feature:"the TraceID query"})},n.createElement(Cn,{options:t,onOptionsChange:e})),n.createElement(J.i,{hideLine:!0}),n.createElement(bn.vc,{options:t,onOptionsChange:e})))},Mn=t=>({container:(0,T.css)`
    label: container;
    margin-bottom: ${t.spacing(2)};
    max-width: 900px;
  `});var An=l(35630);const Ln=({payload:{dashboardId:t,orgId:e,grafanaVersion:a,queries:r}})=>{try{const s=r[An.id];if(!s?.length)return;let o={grafana_version:a,dashboard_id:t,org_id:e,native_search_query_count:0,search_query_count:0,service_map_query_count:0,traceql_query_count:0,upload_query_count:0,native_search_queries_with_template_variables_count:0,search_queries_with_template_variables_count:0,service_map_queries_with_template_variables_count:0,traceql_queries_with_template_variables_count:0};for(const i of s)i.hide||(i.queryType==="nativeSearch"?(o.native_search_query_count++,(i.serviceName&&de(i.serviceName)||i.spanName&&de(i.spanName)||i.search&&de(i.search)||i.minDuration&&de(i.minDuration)||i.maxDuration&&de(i.maxDuration))&&o.native_search_queries_with_template_variables_count++):i.queryType==="search"?(o.search_query_count++,i.linkedQuery&&i.linkedQuery.expr&&de(i.linkedQuery.expr)&&o.search_queries_with_template_variables_count++):i.queryType==="serviceMap"?(o.service_map_query_count++,i.serviceMapQuery&&de(i.serviceMapQuery)&&o.service_map_queries_with_template_variables_count++):i.queryType==="traceql"?(o.traceql_query_count++,de(i.query)&&o.traceql_queries_with_template_variables_count++):i.queryType==="upload"&&o.upload_query_count++);(0,V.ff)("grafana_tempo_dashboard_loaded",o)}catch(s){console.error("error in tempo tracking handler",s)}},de=t=>(0,Oe.J)().containsTemplate(t),wn=new v.hf(Ba).setQueryEditor(fn).setConfigEditor(Vn).setQueryEditorHelp(L);(0,A.N$)().subscribe(h.Pl,Ln)},99292:(se,W,l)=>{var v;v={value:!0};var h=l(58145),A=l(39953),n=h.__importDefault(l(95681));function V(y,L){L===void 0&&(L=[]);var T=n.default(y,L,{loading:!0}),F=T[0],w=T[1];return A.useEffect(function(){w()},[w]),F}W.Z=V}}]);

//# sourceMappingURL=1249.js.map